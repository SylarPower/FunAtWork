<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruzzle dei üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #3498db;
            --accent: #e74c3c;
            --bg: #ecf0f1;
            --text-main: #2c3e50;
            --tile-bg: #fff;
            --tile-text: #34495e;
            --tile-shadow: #95a5a6;
            --tile-selected: #f1c40f;
            --tile-valid: #2ecc71;
            --panel-bg: #fff;
            --item-bg: #f8f9fa;
            --line-color: rgba(44, 62, 80, 0.8);
            --overlay-bg: rgba(44, 62, 80, 0.98);
            --grid-cols: 5; 
        }

        body.dark-mode {
            --primary: #3498db;
            --accent: #ff6b6b;
            --bg: #121212;
            --text-main: #ecf0f1;
            --tile-bg: #2c3e50;
            --tile-text: #ecf0f1;
            --tile-shadow: #000;
            --tile-selected: #f39c12;
            --tile-valid: #27ae60;
            --panel-bg: #1e1e1e;
            --item-bg: #2d2d2d;
            --line-color: rgba(241, 196, 15, 0.8);
            --overlay-bg: rgba(0, 0, 0, 0.95);
        }

        /* ‚úÖ PERFORMANCE BOOST */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        @keyframes earthquake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes disco-flash {
            0% { background-color: #e74c3c; }
            25% { background-color: #f1c40f; }
            50% { background-color: #2ecc71; }
            75% { background-color: #9b59b6; }
            100% { background-color: #3498db; }
        }

        @keyframes pulse-ready {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 8px 25px rgba(3, 218, 198, 0.4);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 12px 35px rgba(3, 218, 198, 0.6);
            }
        }
        
        @keyframes urgentPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); color: red; } }
        
        /* ‚úÖ ANIMAZIONI OTTIMIZZATE */
        @keyframes pulseGreen { 
            0% { background: var(--tile-valid); transform: scale(1.03); } 
            100% { background: var(--tile-bg); transform: scale(1); } 
        }
        @keyframes shakeRed { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-3px); background: var(--accent); } 
            75% { transform: translateX(3px); } 
        }
        @keyframes pulseBtn {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(231, 76, 60, 0.8); }
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes fremito {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-1px, 1px); }
            50% { transform: translate(1px, -1px); }
            75% { transform: translate(-1px, -1px); }
        }

        body.mega-win-effect {
            animation: earthquake 0.5s 3, disco-flash 0.5s 3;
        }

        /* ‚úÖ DISABILITA ANIMAZIONI DURANTE PROCESSING */
        body.processing * {
            animation-play-state: paused !important;
            transition: none !important;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 10px;
            overflow-x: hidden; transition: background 0.3s, color 0.3s;
        }

        .app-wrapper {
            width: 100%; max-width: 875px;    
            display: flex; flex-direction: column; padding: 0 10px;
        }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); }

        .theme-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            padding: 5px; border-radius: 50%; transition: background 0.2s;
        }
        .theme-btn:hover { background: rgba(0,0,0,0.1); }
        body.dark-mode .theme-btn:hover { background: rgba(255,255,255,0.1); }

        .game-container {
            display: flex; flex-direction: column; gap: 20px; align-items: center;
            max-width: 950px; width: 100%; height: auto;
        }

        @media (min-width: 850px) {
            .game-container { 
                flex-direction: row; 
                align-items: stretch; 
                justify-content: center; 
                gap: 40px; 
            }
            .board-wrapper { flex: 0 0 450px; } 
            .sidebar { flex: 1; }
        }

        .config-bar {
            width: 100%; background: var(--panel-bg); padding: 15px; border-radius: 10px;
            margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 12px;
        }
        .config-row { display: flex; justify-content: space-between; align-items: center; }
        
        .code-display {
            font-family: monospace; font-weight: bold; font-size: 1.1rem;
            color: var(--primary); background: var(--bg); padding: 6px 10px; border-radius: 4px;
            cursor: pointer; border: 1px solid #ccc;
        }

        select { padding: 5px; border-radius: 4px; background: var(--bg); color: var(--text-main); border: 1px solid #7f8c8d; }

        .board-wrapper {
            display: flex; flex-direction: column; width: 100%;
        }

        .status-bar {
            display: flex; justify-content: space-between; width: 100%;
            margin-bottom: 8px; font-weight: bold; font-size: 1.2rem; align-items: center;
        }
        #timer { color: var(--accent); font-feature-settings: "tnum"; }
        .timer-alert { animation: urgentPulse 0.8s infinite; font-weight: 900; }

        #current-word {
            height: 45px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 900; color: #2c3e50;
            background: #dfe6e9; width: 100%; border-radius: 8px; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 2px; position: relative; z-index: 2;
            transition: background 0.15s ease;
        }

        .grid-container { position: relative; width: 100%; aspect-ratio: 1 / 1; touch-action: none; }
        #line-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        .grid {
            display: grid; 
            grid-template-columns: repeat(var(--grid-cols), 1fr); 
            gap: 6px;
            background: #95a5a6; padding: 6px; border-radius: 10px;
            width: 100%; height: 100%; box-sizing: border-box; user-select: none;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .tile {
            background-color: var(--tile-bg); border-radius: 6px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold; color: var(--tile-text);
            cursor: pointer; box-shadow: 0 3px 0 var(--tile-shadow);
            position: relative; z-index: 2; user-select: none;
            transition: transform 0.15s ease, background-color 0.15s;
            will-change: transform, background-color;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .tile.small-font { font-size: 0.9rem; border-radius: 3px; box-shadow: 0 1px 0 var(--tile-shadow); }
        .tile.medium-font { font-size: 2.2rem; }
        .tile.five-font { font-size: 1.8rem; }
        .tile.six-font { font-size: 1.55rem; }
        .tile.six-font .bonus-badge { font-size: 0.58rem; padding: 1px 3px; }
        .tile.compact-font { font-size: 1.35rem; }
        .tile.compact-font .bonus-badge { font-size: 0.55rem; padding: 1px 3px; }

        .tile.blurred { color: transparent; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .tile.selected { background-color: var(--tile-selected); transform: translateY(2px); box-shadow: 0 1px 0 var(--tile-shadow); color: #fff; }
        .tile.anim-valid { animation: pulseGreen 0.3s; }
        .tile.anim-invalid { animation: shakeRed 0.25s; }

        .bonus-badge {
            position: absolute; top: 2px; right: 2px;
            font-size: 0.6rem; font-weight: 900; padding: 2px 4px;
            border-radius: 3px; color: white; line-height: 1; pointer-events: none;
        }
        .tile.small-font .bonus-badge { font-size: 0.5rem; padding: 1px 2px; top: 1px; right: 1px; }

        .b-2l { background: #3498db; }
        .b-3l { background: #2980b9; }
        .b-2p { background: #e67e22; }
        .b-3p { background: #e74c3c; }

        .rotate-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            transition: transform 0.2s; padding: 5px; color: var(--text-main);
        }
        .rotate-btn:hover { transform: rotate(90deg); }

        .sidebar {
            width: 100%; max-width: 400px; background: var(--panel-bg);
            padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; position: relative;
            min-height: 600px; 
        }
        @media (max-width: 600px) { .sidebar { flex: 1; min-height: 500px; } }

        .score-box-container { 
            position: relative; text-align: center; 
            border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-bottom: 10px; 
        }
        .score-box { display: inline-block; }
        .score-val { font-size: 2.2rem; color: var(--primary); font-weight: bold; line-height: 1.1; }
        .info-btn { 
            position: absolute; right: 0; top: 0;
            width: 24px; height: 24px; border-radius: 50%; background: #95a5a6; color: white; 
            border: none; font-weight: bold; cursor: pointer; 
        }

        .words-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 5px; min-height: 0; transition: filter 0.2s; }
        .words-list.blurred-list { filter: blur(4px); pointer-events: none; user-select: none; }

        .words-list li {
            padding: 8px 10px; background: var(--item-bg); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s; border: 1px solid transparent;
        }
        .words-list li.deleted { text-decoration: line-through; opacity: 0.5; }
        .words-list li.missed { border-left: 4px solid var(--accent); background: rgba(231, 76, 60, 0.1); }
        .words-list.interactive li:hover { background: #ffe0b2; color: #333; }

        .word-item-left { display: flex; align-items: center; gap: 8px; }
        .btn-eye { 
            background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0;
            opacity: 0.5; transition: all 0.2s; display: flex; align-items: center;
        }
        .btn-eye:hover { opacity: 1; transform: scale(1.2); }

        .btn-group { display: flex; gap: 10px; width: 100%; margin-top: 10px; flex-shrink: 0;}
        .game-controls { display: flex; gap:10px; margin-top: 10px; }
        .game-controls .btn-action { margin-top: 0; }
        
        .btn-action {
            width: 100%; 
            padding: 10px; 
            font-size: 0.85rem; 
            border: 1px solid #555; 
            border-radius: 4px;
            background: var(--panel-bg);
            color: var(--text-main); 
            cursor: pointer; 
            font-weight: 500; 
            transition: background 0.15s ease, transform 0.1s ease;
            margin-top: 8px;
        }

        .btn-action:hover {
            background: var(--item-bg);
        }

        .btn-action:active {
            transform: scale(0.97);
        }

        .btn-pause { 
            background: #f39c12 !important; 
            color: white !important;
            border-color: #d68910 !important;
        }

        .btn-pause.paused {
            background: #27ae60 !important;
            border-color: #1e8449 !important;
        }

        .btn-end-now {
            background: var(--accent) !important;
            color: white !important;
            border-color: #c0392b !important;
        }

        .btn-new { display: block; }
        .btn-reset { display: none; }
        .btn-sandbox { display: none; }
        .btn-history { display: block; }
        .btn-missed { display: none; margin-top: 0; margin-bottom: 5px; }

        .btn-rivincita {
            width: auto;
            padding: 12px 30px;
            font-size: 0.9rem;
            border: 2px solid #e74c3c;
            border-radius: 4px;
            background: var(--panel-bg);
            color: var(--text-main);
            cursor: pointer;
            font-weight: 700;
            animation: fremito 0.15s infinite;
        }

        .btn-rivincita:hover {
            background: #e74c3c;
            color: white;
        }

        .switch-container { display: flex; align-items: center; font-size: 0.9rem; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--panel-bg); padding: 25px; border-radius: 10px;
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
            position: relative; display: flex; flex-direction: column; color: var(--text-main);
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 2rem; cursor: pointer; line-height: 1; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--item-bg); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .stat-label { font-size: 0.75rem; opacity: 0.8; }

        .legend-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .legend-table th, .legend-table td { border-bottom: 1px solid #ccc; padding: 8px; text-align: left; }
        
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th, .history-table td { border-bottom: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.9rem;}
        
        .sort-controls { display: none; justify-content: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #ccc; flex-shrink: 0; }
        .sort-btn { background: var(--item-bg); border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; cursor: pointer; color: var(--text-main); }
        .sort-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #grid-overlay {
            position: absolute; inset: 0; background: var(--overlay-bg); border-radius: 10px;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; color: white; text-align: center;
        }

        #pause-overlay {
            position: absolute; inset: 0; background: var(--bg); border-radius: 10px;
            display: none; justify-content: center; align-items: center;
            z-index: 50; color: var(--text-main); font-size: 2rem; font-weight: bold; letter-spacing: 2px;
            flex-direction: column; gap: 10px;
        }

        #wait-banner {
            animation: slideDown 0.3s ease;
        }

        #wait-banner button:active {
            transform: scale(0.95) !important;
        }

        #btn-via {
            width: 100px; height: 100px; border-radius: 50%; background: #e74c3c; border: 4px solid white;
            color: white; font-size: 1.8rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); animation: pulseBtn 1.5s infinite; margin-top: 15px;
        }
        
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 9999; pointer-events: none; }
        .bonus-legend-item { display:flex; align-items:center; gap:10px; margin-bottom:5px; }
        
        #loading-msg {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; color: var(--primary); z-index: 5000;
        }

        #ach-notification {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 90%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            border: 2px solid white;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            pointer-events: none;
        }

        #ach-notification.show { 
            transform: translate(-50%, -50%) scale(1); 
        }
        
        #game-end-modal .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #2980b9 50%, #8e44ad 100%);
            color: white;
            border: 6px solid white;
            box-shadow: 0 0 60px rgba(52, 152, 219, 0.6), 0 0 0 15px rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            max-width: 450px;
            width: 90%;
            padding: 40px 20px;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: auto; 
        }

        #game-end-modal .score-container-inner {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #game-end-modal .btn-action {
            background: white;
            color: #2980b9;
            font-size: 1.1rem;
            font-weight: 900;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        #game-end-modal .btn-action:hover {
            transform: scale(1.05);
            background: #ecf0f1;
        }

        #ach-text { text-shadow: 2px 2px 0px rgba(0,0,0,0.2); }

        .processing-blur {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
            transition: filter 0.2s ease;
        }
        
        #start-screen {
            position: absolute; inset: 0; 
            background: var(--panel-bg); 
            border-radius: 10px;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 100;
            color: var(--text-main); 
            text-align: center;
            padding: 20px;
        }
          
        #calculation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        #calculation-overlay .msg-box {
            background: rgba(0, 0, 0, 0.8); color: white; padding: 20px 40px; border-radius: 10px;
            font-size: 1.5rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #fixed-home-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99999;
            display: none;
        }
        
        #fixed-home-btn button {
            background: var(--panel-bg);
            color: var(--text-main);
            border: 2px solid #555;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        
        #fixed-home-btn button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
.game-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 9999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    animation: slideDown 0.3s ease;
    color: white;
    flex-wrap: wrap;
}

.game-banner .banner-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.game-banner .banner-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

@media (max-width: 600px) {
    .game-banner {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .game-banner .banner-left,
    .game-banner .banner-right {
        justify-content: center;
    }
}
    </style>
</head>
<body class="dark-mode">
    <div id="multiplayer-lobby" style="position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:10000; display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; color:white;">
        <h1 id="lobby-title" style="font-size:3rem; margin-bottom:10px;">SALA D'ATTESA üê∑</h1>
        <p id="lobby-info" style="opacity:0.8;">Sincronizzazione sfida in corso...</p>
        <div id="lobby-status" style="margin: 30px; font-size: 1.5rem; color: #03dac6; font-weight:bold;"></div>
        <div id="lobby-action"></div>
    </div>
    <div id="calculation-overlay">
        <div class="msg-box">üß† Calcolo Soluzioni...</div>
    </div>
    <div id="loading-msg">
        Caricamento Dizionario...
        <div style="font-size:0.9rem; color:#777; margin-top:10px; font-weight:normal;">(Database parole)</div>
    </div>

    <div class="app-wrapper">
        <div class="header-bar">
            <h1>Ruzzle dei üê∑</h1>
            <button class="theme-btn" onclick="toggleTheme()" title="Cambia Tema">üåó</button>
        </div>
        <div class="game-container">
            <div class="board-wrapper">
                <div class="config-bar">
                    <div class="config-row">
                        <span style="font-weight:bold; opacity:0.8;">Codice:</span>
                        <span class="code-display" id="display-seed" onclick="copySeed()" title="Copia">----</span>
                    </div>
                    <div class="config-row">
                        <div class="switch-container">Modalit√† Click <label class="switch"><input type="checkbox" id="input-mode-toggle"><span class="slider"></span></label></div>
                    </div>
                </div>

                <div class="status-bar">
                    <span>Tempo: <span id="timer">03:00</span></span>
                    <span>Trovabili: <span id="possible-count" style="opacity:0.6;">...</span></span>
                    <button id="manual-rotate-btn" class="rotate-btn" onclick="rotateGrid()" title="Ruota Griglia" style="display:none;">üîÑ</button>
                </div>
                
                <div id="current-word"></div>

                <div class="grid-container">
                    <svg id="line-layer" width="100%" height="100%"></svg>
                    
                    <div id="start-screen">
                        <div style="font-size:3rem; margin-bottom:10px;">üé≤</div>
                        <h2>BENVENUTO</h2>
                        <p style="margin-bottom:20px; opacity:0.8;">Inizia una nuova sfida o unisciti a un amico</p>
                    </div>

                    <div id="grid-overlay">
                        <div style="font-size:1rem;">Codice: <span id="overlay-seed" style="color:#f1c40f; font-weight:bold;"></span></div>
                        <div style="margin-top:5px; font-size:0.9rem; opacity:0.8;">Premi VIA per svelare</div>
                        <button id="btn-via" onclick="startRound()">VIA!</button>
                    </div>
                    <div id="pause-overlay">
                        <div>‚è∏Ô∏è IN PAUSA</div>
                        <div style="font-size:0.9rem; opacity:0.7;">Premi RIPRENDI per continuare</div>
                    </div>
                    <div class="grid" id="grid"></div>
                </div>
                
                <div id="in-game-controls" class="game-controls" style="display:none;">
                    <button id="btn-pause" class="btn-action btn-pause" onclick="togglePause()">PAUSA</button>
                    <button id="btn-terminate" class="btn-action btn-end-now" onclick="endGameManually()" style="display:none;">TERMINA ORA</button>
                </div>
                
                <button id="btn-sandbox" class="btn-action btn-sandbox" onclick="startSandbox()">SBLOCCA GRIGLIA (LIBERA)</button>
                <button id="btn-reset-selection" class="btn-action btn-reset" onclick="clearSelection()">AZZERA SELEZIONE</button>
                
                <div class="btn-group">
                    <button class="btn-action btn-new" onclick="startNewGame()">NUOVA</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="score-box-container">
                    <div class="score-box">
                        <div style="font-size:0.8rem; font-weight:bold;">PUNTEGGIO</div>
                        <div class="score-val" id="total-score">0</div>
                        <div id="live-opponent-score" style="color: #ff4081; font-weight: 900; font-size: 1.1rem; margin-top:10px;"></div>
                    </div>
                    <button class="info-btn" onclick="openLegend()" title="Legenda">i</button>
                </div>
                
                <div id="proposta-manuale-container" style="display:none; background:rgba(3,218,198,0.1); padding:10px; border-radius:8px; margin-bottom:10px; border:1px dashed #03dac6;">
                    <input type="text" id="input-nuova-parola" placeholder="Parola non letta? Scrivila..." autocomplete="off" autocorrect="off" spellcheck="false" style="width:100%; margin:0; font-size:0.8rem; text-transform:uppercase;">
                    <button onclick="proponiParolaManuale()" class="btn-action" style="margin-top:5px; padding:8px; font-size:0.75rem;">PROPONI AGGIUNTA üì¢</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px; flex-shrink:0;">
                    <span>Parole: <span id="word-count">0</span></span>
                </div>

                <div class="sort-controls" id="sort-controls">
                    <button class="sort-btn" title="Cronologico" onclick="setSortMode('chrono')">üïí</button>
                    <button class="sort-btn active" title="Alfabetico" onclick="setSortMode('alpha')">üî§</button>
                    <button class="sort-btn" title="Punteggio" onclick="setSortMode('score')">üèÜ</button>
                    <button class="sort-btn" title="Ordinamento" onclick="toggleSortDirection()" id="sort-dir-btn">‚¨áÔ∏è</button>
                </div>

                <div style="font-size:0.8rem; color:var(--accent); margin-bottom:5px; display:none; flex-shrink:0;" id="analysis-msg">Clicca per eliminare una parola</div>
                <div id="ach-notification">üèÜ <span id="ach-text">Obiettivo Sbloccato!</span></div>
                <ul class="words-list" id="found-words"></ul>
                
                <button id="btn-missed" class="btn-action btn-missed" onclick="showMissedWords()">üîç COSA MI SONO PERSO?</button>
                <button class="btn-action btn-history" onclick="openStats()">STORICO & STATS</button>
            </div>
        </div>
    </div>

    <div id="new-game-modal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <span class="close-modal" onclick="closeNewGameModal()">&times;</span>
            <h2>Nuova Partita</h2>
            
            <div style="margin-bottom: 20px;">
                <label for="modal-timer-select" style="font-weight:bold; display:block; margin-bottom:5px;">Durata:</label>
                <select id="modal-timer-select" style="width: 100%; padding: 8px; font-size: 1rem;">
                    <option value="45">45s (Fulmine)</option>
                    <option value="60">60s (Blitz)</option>
                    <option value="90">90s</option>
                    <option value="180" selected>180s (Standard)</option>
                    <option value="300">300s (Relax)</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="modal-grid-select" style="font-weight:bold; display:block; margin-bottom:5px;">Dimensione Griglia:</label>
                <select id="modal-grid-select" style="width: 100%; padding: 8px; font-size: 1rem;">
                    <option value="4">4x4 (Easy)</option>
                    <option value="5" selected>5x5 (Classica)</option>
                    <option value="6">6x6 (Intermedia)</option>
                    <option value="7">7x7 (Grande)</option>
                    <option value="10">10x10 (Estrema!)</option>
                </select>
            </div>

            <p style="margin-bottom:20px; color:var(--text-main);">Scegli la modalit√† di gioco:</p>
            
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button class="btn-action" style="width:auto; padding:12px 25px; margin-top:0;" onclick="confirmNewGame(false, false, false)">CLASSICA</button>
                <button class="btn-action" style="width:auto; padding:12px 25px; margin-top:0;" onclick="confirmNewGame(true, false, false)">BONUS ‚≠ê</button>
                <button class="btn-action" style="width:auto; padding:12px 25px; margin-top:0;" onclick="confirmNewGame(true, true, false)">CRAZY ü§™</button>
                <button class="btn-action" style="width:auto; padding:12px 25px; margin-top:0;" onclick="confirmNewGame(true, true, true)">BIATCH üíÖ</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeStats()">&times;</span>
            <h2>Statistiche</h2>
            
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-val" id="stat-total-games">0</span><span class="stat-label">Partite</span></div>
                <div class="stat-card"><span class="stat-val" id="stat-high-score">0</span><span class="stat-label">Record</span></div>
                <div class="stat-card"><span class="stat-val" id="stat-total-score">0</span><span class="stat-label">Punti Totali</span></div>
                <div class="stat-card"><span class="stat-val" id="stat-avg-score">0</span><span class="stat-label">Media Punti</span></div>
                <div class="stat-card"><span class="stat-val" id="stat-best-word">-</span><span class="stat-label">Pi√π Preziosa</span></div>
                <div class="stat-card" style="grid-column: span 1;"><span class="stat-val" id="stat-longest-word">-</span><span class="stat-label">Pi√π Lunga</span></div>
            </div>

            <h3>Obiettivi</h3>
            <div id="achievements-list" style="margin-bottom:20px; font-size:0.9rem;"></div>

            <h3>Storico Partite</h3>
            <table class="history-table">
                <thead><tr><th>Data</th><th>Codice</th><th>Punti</th></tr></thead>
                <tbody id="history-list-body"></tbody>
            </table>
            
            <div style="margin-top:20px; text-align:center;">
                <button class="btn-action" style="background-color: var(--accent);" onclick="clearData()">RESET DATA</button>
            </div>
        </div>
    </div>

    <div id="legend-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeLegend()">&times;</span>
            <h2>Legenda Punti</h2>
            <table class="legend-table">
                <thead><tr><th>Lunghezza</th><th>Punti Base</th></tr></thead>
                <tbody>
                    <tr><td>4 lettere</td><td>1</td></tr>
                    <tr><td>5 lettere</td><td>2</td></tr>
                    <tr><td>6 lettere</td><td>3</td></tr>
                    <tr><td>7 lettere</td><td>5</td></tr>
                    <tr><td>8+ lettere</td><td>11</td></tr>
                </tbody>
            </table>
            <div style="margin-top:20px; font-size:0.9rem;">
                <p><b>Q</b> = <b>Qu</b> (Conta come 2 lettere!)</p>
                <hr style="margin:10px 0; border:0; border-top:1px solid #ccc;">
                <p style="font-weight:bold; margin-bottom:10px;">Bonus:</p>
                <div class="bonus-legend-item"><span class="bonus-badge b-2l" style="position:relative;">2L</span> +2 Punti al totale</div>
                <div class="bonus-legend-item"><span class="bonus-badge b-3l" style="position:relative;">3L</span> +3 Punti al totale</div>
                <div class="bonus-legend-item"><span class="bonus-badge b-2p" style="position:relative;">2P</span> Punteggio parola x2</div>
                <div class="bonus-legend-item"><span class="bonus-badge b-3p" style="position:relative;">3P</span> Punteggio parola x3</div>
            </div>
        </div>
    </div>

    <div id="game-end-modal" class="modal-overlay" style="z-index: 5000;">
        <div class="modal-content">
            <div style="font-size: 5rem; margin-bottom: 10px; animation: bounceIn 0.8s;">üèÅ</div>
            
            <h2 style="margin: 0 0 10px 0; font-size: 2.5rem; text-transform: uppercase; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">Tempo Scaduto!</h2>
            <p style="opacity: 0.9; margin-bottom: 30px; font-size: 1.1rem;">La partita √® terminata.</p>
            
            <div class="score-container-inner">
                <div style="font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8;">Punteggio Finale</div>
                <div id="end-score-val" style="font-size: 5rem; font-weight: 900; line-height: 1; text-shadow: 0 5px 0 rgba(0,0,0,0.2);">0</div>
            </div>
            
            <div style="display:flex; gap:15px; justify-content:center; margin-top:20px; flex-wrap:wrap;">
                <button onclick="closeEndGameModal()" class="btn-action" style="width:auto; padding:12px 25px; background:white; color:#2980b9; border:none;">üîç ESPLORA GRIGLIA</button>
                <button onclick="tornaHome()" class="btn-action" style="width:auto; padding:12px 25px; background:white; color:#2980b9; border:none;">üè† HOME</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const DEBUG_MODE = false;
    
    // Variabili per il match live
    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('matchId');
    const mioNome = localStorage.getItem('mioNome');

    // --- CONFIGURAZIONE ---
    let gridSize = 5;
    const MIN_WORD_LENGTH = 4;
    const LETTER_POOL = "AAAAAAAABBCCDDEEEEEEEEFFGGGHHIIIIIILLLMMNNOOOOOOPPQRRSSTTTUUUVVZ";
    let EXTRA_WORDS = ["ASIA","EUROPA","AFRICA","AMERICA","OCEANIA","ANTARTIDE","ITALIA","CINA","INDIA","USA","RUSSIA","FRANCIA","SPAGNA","GERMANIA","PERU","CILE","IRAN","IRAQ","LAOS","MALI","CUBA","FIJI","TOGO","ROMA","MILANO","NAPOLI","TORINO","BARI","OSLO","LIMA","RIGA","BONN","NILO","RENO","PO","TEVERE","ARNO","ADIGE","PIAVE","ADDA","ALPI","ANDE","URALI","ETNA","LAGO","MARE","MONTE","CITTA","ISOLA","BELA","LOBO","LOGO","JAVA","HTML","WEB","EMAIL","FILE","APP","GODITI","DIMMI","DAMMI","FAMMI","DILLO","FALLO","VATTENE","PIGLIAMI","SENTIMI",
    "ANITA","LUCA","MARCO","ANNA","MARIA","PAOLO","LUIGI","SARA","ELENA","ROSA","VIOLA","GIOIA","SOLE","LUNA","STELLA",
    "PISA","SIENA","PARMA","COMO","LECCO","LODI","ENNA","RAGUSA","FOGGIA","TERNI","AOSTA","MONZA","MEGA","EZIO","PORCHI","MAMELI","GARDA","MASAI","MAASAI","PABLO","SELINA","LAVAREDO","LARA","PETO","GENE","ENNE","ALARE","RAGU","MONA","GASAI","FETA","FETE","MASO","MASI","MEME","GASI","CAGA","SITE","CASIO","ALONSO","DRENI","CEDO","PENTO","PENTE","ERMA","ERMI",
    "SITA","TOFU","POTAI","PIPPE","CALCIA","ERSE","ERSI","QUINOA","GASO","BUSET","MISO","NASA","EBOLA","TERA","NONE","ZORRO","EOLIE","SERI","SILE","PELMO","PITA"];
    let EXCLUDED_WORDS = ["SAETTI","BIFFE","PIATO","PIOTA","GILE","GLIE","GIOI","POPE","RAFFA","RAFFI","ZAFFI","PASCI","MEVE","MINO","BASTE","DIANE","MAIO","SPALLI","RENA","FELA","FERA","GATO","ZOIA","ANCE","ELISE","ELSE","FIFE","PILLI","PILLO","BASA","INIO","PIVA","PIVE","ROMI","ALPA","ALPO","BIDE","LARIO","LARO","LAURI","PROTI","NESTO","TOSONE","GORE","BIAVA","FOIA","PASSE","SAPA","LETO","LETA","ORTE","TORE","SILA","SERPA","ENEO","LENE","LENO","LIANO","IANO","MALO","BALIO",
    "TELMA","TALLO","GRUMA","GIACO","PASCO","CIRA","VAGITA","FEDO","PRECI","SIRO","QUIRO","POTTE","ROSI","POTTA","PELUTO","BOVO","BETTO","CIANA","CIANE","CIANI","VELIE","FAGO","CORE","RICO","BOVE","CEBO","LIMANA","GIANA","MUFFI","MUFFO","NILA","FOGNATA","NASATE","LICE","GERI","MITRE","TOMA","PELTA","POLTA","FANNE","INNA","GENICA","AGIEA","FANNI","SANNA","SANNE","GINNO","FANNI","OLGO","CALE","IMMO","MITRE","TREVO","MESCE","PINGE","NINI","ANITO","OVATO",
    "GELSA","TOSSO","COTI","BAULA","BAULO","CARMI","LORA","SIMO","BOTRO","EOLA","AGGIO","ALIA","BORNI","BORNIA"];

    // --- ACHIEVEMENTS ---
    const ACHIEVEMENTS = [
        { id: 'not_now', title: 'Anti-sgamo', desc: 'Metti in pausa il gioco', check: (ctx) => ctx.game.isPaused === true },
        { id: 'blender', title: 'Frullatore', desc: 'Ruota la griglia 20 volte in una partita', check: (ctx) => rotationCount >= 20 },
        { id: 'flash', title: 'Flash', desc: 'Trova una parola nei primi 3 secondi', check: (ctx) => ctx.last.word && ctx.game.elapsedTime <= 3 },
        { id: 'fotofinish', title: 'Fotofinish', desc: 'Trova una parola negli ultimi 3 secondi', check: (ctx) => ctx.last.word && ctx.game.timeRemaining <= 3 && !ctx.game.isOver },
        { id: 'sloth', title: 'Bradipo', desc: 'Trova la prima parola quando mancano meno di 30 secondi', check: (ctx) => ctx.game.wordCount === 1 && ctx.game.timeRemaining < 30 },
        { id: 'parkinson', title: 'Parkinson', desc: 'Sbaglia parola per 15 volte', check: (ctx) => errorCount >= 15 },
        { id: 'long_one', title: 'Linguista', desc: 'Trova una parola da 8 o pi√π lettere', check: (ctx) => ctx.last.word && ctx.last.word.length >= 8 },
        { id: 'palindromo', title: 'Specchio Riflesso', desc: 'Trova una parola palindroma', check: (ctx) => { const w = ctx.last.word; return w && w.length >= 4 && w === w.split('').reverse().join(''); }},
        { id: 'sniper', title: 'Cecchino', desc: 'Trova una parola da almeno 30 punti', check: (ctx) => ctx.last.points >= 30 },
        { id: 'words_40', title: 'Mitragliatrice', desc: 'Trova 40 parole in una partita', check: (ctx) => ctx.game.wordCount >= 40 },
        { id: 'score_200', title: 'Fuoriclasse', desc: 'Fai 200 punti in una partita', check: (ctx) => ctx.game.score >= 200 && ctx.game.score < 300 },
        { id: 'score_300', title: 'Einstein', desc: 'Fai 300 punti in una partita', check: (ctx) => ctx.game.score >= 300 },
        { id: 'gandhi', title: 'Gandhi', desc: 'Fai 0 punti in una partita', check: (ctx) => ctx.game.isOver && ctx.game.score === 0 && !ctx.game.isPaused },
        { id: 'copione', title: 'Copione', desc: 'Elimina il 95% delle tue parole in fase di verifica', check: (ctx) => ctx.game.wordCount >= 10 && (ctx.game.deletedCount / ctx.game.wordCount) >= 0.9 },
        { id: 'buset', title: 'BUSET MAIALONE', desc: 'Hai trovato l amore della tua vita!', check: (ctx) => ctx.last.word === 'BUSET' },
        { id: 'biatch_move', title: 'MAL DI TESTA üíÖ', desc: 'Hai fatto girare la griglia tante volte!', check: (ctx) => isBiatchMode && rotationCount > 10 }
    ];

    // --- ‚úÖ STATO CENTRALIZZATO INPUT ---
    const inputState = {
        isDragging: false,
        isRotating: false,
        isProcessing: false,
        lockUntil: 0
    };

    function canInteract() {
        return !inputState.isProcessing && 
               !inputState.isRotating && 
               Date.now() > inputState.lockUntil;
    }

    function lockInput(duration = 300) {
        inputState.isProcessing = true;
        inputState.lockUntil = Date.now() + duration;
        setTimeout(() => {
            inputState.isProcessing = false;
        }, duration);
    }

    // --- ‚úÖ SISTEMA MANAGED LISTENERS ---
    const globalListeners = [];

    function addManagedListener(element, event, handler, options) {
        element.addEventListener(event, handler, options);
        globalListeners.push({ element, event, handler, options });
    }

    function cleanupAllListeners() {
        globalListeners.forEach(({ element, event, handler, options }) => {
            element.removeEventListener(event, handler, options);
        });
        globalListeners.length = 0;
    }

    // --- ‚úÖ DEBOUNCE UTILITY ---
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- STATO ---
    let dictionary = new Set();
    let gridLetters = []; 
    let gridBonuses = []; 
    let selectedCells = []; 
    let foundWords = new Map(); 
    let score = 0;
    let errorTimeout = null;
    let rotationCount = 0;
    let errorCount = 0;
    let fireworksInterval = null;
    let timerInterval;
    let timeRemaining = 180;
    let initialTime = 180;
    let isGameActive = false;
    let isPaused = false; 
    let isSandboxMode = false; 
    let inputMode = 'drag'; 
    let currentSeed = "";
    let isAnalysisPhase = false;
    let wordCounter = 0; 
    let sortMode = 'chrono'; 
    let sortDescending = true; 
    let rotationIndex = 0; 
    let useBonuses = false;
    let currentGameTimestamp = null; 
    let currentHighlightedWord = null;
    let isCrazyMode = false;
    let isBiatchMode = false;
    let currentGameData = null;
    let dizionarioCustomApplicato = false;
    let unsubscribePartita = null;
    let unsubscribeProposte = null;
    let wordDisplayLocked = false;
    let dictionaryReady = false;

    // --- TRIE ---
    class TrieNode {
        constructor() { this.children = {}; this.isWord = false; }
    }
    let trieRoot = null;

    function buildTrie() {
        trieRoot = new TrieNode();
        dictionary.forEach(word => {
            let node = trieRoot;
            for (const ch of word) {
                if (!node.children[ch]) node.children[ch] = new TrieNode();
                node = node.children[ch];
            }
            node.isWord = true;
        });
    }

    function hasPrefix(prefix) {
        let node = trieRoot;
        for (const ch of prefix) {
            if (!node.children[ch]) return false;
            node = node.children[ch];
        }
        return true;
    }

    // --- RNG ---
    function cyrb128(str) {
        let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
        for (let i = 0, k; i < str.length; i++) { k = str.charCodeAt(i); h1 = h2 ^ Math.imul(h1 ^ k, 597399067); h2 = h3 ^ Math.imul(h2 ^ k, 2869860233); h3 = h4 ^ Math.imul(h3 ^ k, 951274213); h4 = h1 ^ Math.imul(h4 ^ k, 2716044179); }
        h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067); h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233); h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213); h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
        return [(h1^h2^h3^h4)>>>0, (h2^h1)>>>0, (h3^h1)>>>0, (h4^h1)>>>0];
    }
    function sfc32(a, b, c, d) {
        return function() { a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; var t = (a + b) | 0; a = b ^ b >>> 9; b = c + (c << 3) | 0; c = (c << 21 | c >>> 11); d = (d + 1) | 0; t = (t + d) | 0; c = (c + t) | 0; return (t >>> 0) / 4294967296; }
    }

    // --- DOM ---
    const gridEl = document.getElementById('grid');
    const wordDisplay = document.getElementById('current-word');
    const scoreDisplay = document.getElementById('total-score');
    const wordsListEl = document.getElementById('found-words');
    const timerDisplay = document.getElementById('timer');
    const loadingMsg = document.getElementById('loading-msg');
    const gridOverlay = document.getElementById('grid-overlay');
    const displaySeed = document.getElementById('display-seed');
    const overlaySeed = document.getElementById('overlay-seed');
    const gameControls = document.getElementById('in-game-controls');
    const btnPause = document.getElementById('btn-pause');
    const pauseOverlay = document.getElementById('pause-overlay');
    const wordCountDisplay = document.getElementById('word-count');
    const lineLayer = document.getElementById('line-layer');
    const analysisMsg = document.getElementById('analysis-msg');
    const sortControls = document.getElementById('sort-controls');
    const btnMissed = document.getElementById('btn-missed');
    const sortDirBtn = document.getElementById('sort-dir-btn');
    const statsModal = document.getElementById('stats-modal');
    const historyListBody = document.getElementById('history-list-body');
    const legendModal = document.getElementById('legend-modal');
    const achNotif = document.getElementById('ach-notification');
    const newGameModal = document.getElementById('new-game-modal');
    const btnSandbox = document.getElementById('btn-sandbox');
    const btnResetSelection = document.getElementById('btn-reset-selection');
    const btnTerminate = document.getElementById('btn-terminate');
    const toggleInput = document.getElementById('input-mode-toggle');
    const modalGridSelect = document.getElementById('modal-grid-select'); 
    const gameEndModal = document.getElementById('game-end-modal');

    // --- BANNER SYSTEM ---
    function showGameBanner(options) {
        removeGameBanner();
        
        const banner = document.createElement('div');
        banner.id = 'game-banner';
        banner.className = 'game-banner';
        banner.style.background = `linear-gradient(135deg, ${options.color} 0%, ${adjustColor(options.color, -20)} 100%)`;
        
        let buttonsHtml = '';
        if (options.buttons && options.buttons.length > 0) {
            buttonsHtml = options.buttons.map(btn => {
                const specialClass = btn.special ? 'btn-rivincita' : 'btn-action';
                const specialStyle = btn.special ? '' : 'style="width:auto; padding:8px 16px; margin:0; background:white; color:#333; border:none;"';
                return `<button onclick="${btn.onclick}" class="${specialClass}" ${specialStyle}>${btn.text}</button>`;
            }).join('');
        }
        
        let spinnerHtml = '';
        if (options.spinner) {
            spinnerHtml = `<div style="width:20px; height:20px; border:3px solid white; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite;"></div>`;
        }
        
        banner.innerHTML = `
            <div class="banner-left">
                <span style="font-size:1.5rem;">${options.icon}</span>
                <div>
                    <div style="font-weight:bold;">${options.title}</div>
                    <div style="font-size:0.8rem; opacity:0.9;">${options.subtitle}</div>
                </div>
            </div>
            <div class="banner-right">
                ${buttonsHtml}
                ${spinnerHtml}
            </div>
        `;
        
        document.body.appendChild(banner);
    }

    function removeGameBanner() {
        const existing = document.getElementById('game-banner');
        if (existing) existing.remove();
        const oldBanner = document.getElementById('wait-banner');
        if (oldBanner) oldBanner.remove();
    }

    function adjustColor(hex, amount) {
        let color = hex.replace('#', '');
        if (color.length === 3) {
            color = color[0]+color[0]+color[1]+color[1]+color[2]+color[2];
        }
        const num = parseInt(color, 16);
        let r = (num >> 16) + amount;
        let g = ((num >> 8) & 0x00FF) + amount;
        let b = (num & 0x0000FF) + amount;
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
        return '#' + (0x1000000 + r*0x10000 + g*0x100 + b).toString(16).slice(1);
    }

    function mostraRisultatiPopup() {
        if (!currentGameData) return;
        
        let msg = "RISULTATI PARZIALI:\n\n";
        Object.entries(currentGameData.punteggi || {}).forEach(([p, s]) => {
            const finito = (currentGameData.finito || []).includes(p);
            msg += `${finito ? '‚úÖ' : '‚è≥'} ${p}: ${s} PT\n`;
        });
        
        alert(msg);
    }
    
    // --- ‚úÖ LOAD DICTIONARY CON TIMEOUT ---
    async function loadDictionary() {
        console.log("üîÑ Inizio caricamento dizionario...");
        loadingMsg.style.display = 'flex';
        
        try {
            const urls = [
                'https://raw.githubusercontent.com/napolux/paroleitaliane/refs/heads/main/paroleitaliane/280000_parole_italiane.txt',
                'https://raw.githubusercontent.com/napolux/paroleitaliane/refs/heads/main/paroleitaliane/9000_nomi_propri.txt'
            ];

            console.log("üì° Download file dizionari...");
            
            const fetchWithTimeout = (url, timeout = 15000) => {
                return Promise.race([
                    fetch(url),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout connessione')), timeout)
                    )
                ]);
            };

            const responses = await Promise.all(
                urls.map(url => fetchWithTimeout(url))
            );

            console.log("üìÑ Conversione testi...");
            const texts = await Promise.all(responses.map(r => r.text()));

            const addWordsToDictionary = (textData) => {
                textData.split('\n').forEach(w => {
                    const clean = w.trim().toUpperCase()
                                   .normalize('NFD')
                                   .replace(/[\u0300-\u036f]/g, "")
                                   .replace(/[^A-Z]/g, "");
                    if (clean.length >= MIN_WORD_LENGTH && !EXCLUDED_WORDS.includes(clean)) {
                        dictionary.add(clean);
                    }
                });
            };

            texts.forEach(t => addWordsToDictionary(t));
            EXTRA_WORDS.forEach(w => dictionary.add(w));
            
            console.log("üî• Caricamento dizionario Firebase...");
            try {
                const globalDocPromise = db.collection("config").doc("dizionario").get();
                const globalDoc = await Promise.race([
                    globalDocPromise,
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Firebase timeout')), 5000)
                    )
                ]);
                
                if (globalDoc.exists) {
                    const data = globalDoc.data();
                    if (data.extra) {
                        data.extra.forEach(w => {
                            if (w && !EXTRA_WORDS.includes(w)) {
                                EXTRA_WORDS.push(w);
                                dictionary.add(w);
                            }
                        });
                    }
                    if (data.excluded) {
                        data.excluded.forEach(w => {
                            if (w && !EXCLUDED_WORDS.includes(w)) {
                                EXCLUDED_WORDS.push(w);
                                dictionary.delete(w);
                            }
                        });
                    }
                    console.log("‚úÖ Dizionario Firebase caricato");
                }
            } catch (fbError) { 
                console.warn("‚ö†Ô∏è Firebase non disponibile (continuo comunque):", fbError); 
            }
            
            console.log("üå≥ Costruzione Trie...");
            buildTrie();
            dictionaryReady = true;
            
            loadingMsg.style.display = 'none';
            console.log(`‚úÖ DIZIONARIO PRONTO: ${dictionary.size} parole`);
            
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            
            if(codeParam) {
                console.log("üéÆ Avvio partita con codice:", codeParam);
                initGame(codeParam);
            } else {
                console.log("üè† Nessun codice - Schermata home");
                gridEl.innerHTML = '';
                displaySeed.textContent = "----";
            }
            
        } catch (error) { 
            console.error("‚ùå ERRORE FATALE:", error);
            
            loadingMsg.innerHTML = `
                <div style="color:#e74c3c; text-align:center;">
                    ‚ùå Errore caricamento dizionari<br>
                    <small style="opacity:0.8;">${error.message}</small><br><br>
                    <button onclick="location.reload()" class="btn-action" style="width:auto; padding:10px 20px;">
                        üîÑ RIPROVA
                    </button>
                </div>
            `; 
            loadingMsg.style.display = 'flex';
        }
    }

    // --- CORE GAME LOGIC ---
    function startNewGame() { newGameModal.style.display = 'flex'; }
    
    function confirmNewGame(withBonus, isCrazy = false, isBiatch = false) {
        if (typeof matchId !== 'undefined' && matchId) {
            creaRivincitaPersonalizzata(withBonus, isCrazy, isBiatch);
            return;
        }
        useBonuses = withBonus || isCrazy;
        isCrazyMode = isCrazy; 
        isBiatchMode = isBiatch;
        const selectedSize = parseInt(modalGridSelect.value) || 5;
        gridSize = selectedSize;
        newGameModal.style.display = 'none';
        initGame(null);
        copySeedNewGame();
    }
 
    async function creaRivincitaPersonalizzata(bonus, crazy, biatch) {
        const snap = await db.collection("partite").doc(matchId).get();
        const v = snap.data();
        let mode = crazy ? 'crazy' : (biatch ? 'biatch' : (bonus ? 'bonus' : 'classic'));
        
        let pts = {}; let words = {}; v.partecipanti.forEach(p => { pts[p]=0; words[p]=[]; });
        const doc = await db.collection("partite").add({
            gioco: 'ruzzle',
            partecipanti: v.partecipanti,
            opzioni: {
                tempo: document.getElementById('modal-timer-select').value,
                griglia: document.getElementById('modal-grid-select').value,
                mode: mode,
                seed: Math.random().toString(36).substring(7).toUpperCase()
            },
            punteggi: pts, parole: words, pronti: [], finito: [], confermaVerifica: [], stato: "attesa", timestamp: Date.now(), dataOra: new Date().toLocaleString('it-IT')
        });
        db.collection("partite").doc(matchId).update({ prossimaPartita: doc.id });
    }
 
    function closeNewGameModal() { newGameModal.style.display = 'none'; }
    function joinGame() {
        const code = prompt("Inserisci il Codice Partita:");
        if (code && code.trim().length > 0) initGame(code.trim().toUpperCase());
    }

    function initGame(forceSeed) {
        timerDisplay.style.color = "";
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('fixed-home-btn').style.display = 'none';
        clearInterval(timerInterval);
        isGameActive = false; isAnalysisPhase = false; isPaused = false; isSandboxMode = false;
        
        document.body.classList.remove('mega-win-effect');
        stopFireworks();
        
        score = 0; foundWords.clear(); selectedCells = []; wordCounter = 0; rotationIndex = 0; rotationCount = 0; errorCount = 0;
        wordDisplayLocked = false;
        currentGameTimestamp = null;
        
        // Reset input state
        inputState.isDragging = false;
        inputState.isRotating = false;
        inputState.isProcessing = false;
        inputState.lockUntil = 0;
        
        scoreDisplay.textContent = "0"; wordCountDisplay.textContent = "0";
        wordsListEl.innerHTML = ""; wordsListEl.classList.remove('interactive');
        analysisMsg.style.display = "none"; sortControls.style.display = "none";
        btnMissed.style.display = "none";
        btnSandbox.style.display = 'none';
        setSortMode('chrono');
        
        const btnNewEl = document.querySelector('.btn-new');
        if (btnNewEl) {
            btnNewEl.style.display = matchId ? 'none' : 'block';
        }
        wordDisplay.textContent = ""; lineLayer.innerHTML = '';
        document.getElementById('possible-count').textContent = '...';
        document.getElementById('possible-count').style.opacity = '0.6';
        gameControls.style.display = 'none';
        pauseOverlay.style.display = 'none';
        btnPause.textContent = "PAUSA";
        btnPause.style.backgroundColor = "#f39c12";

        inputMode = toggleInput.checked ? 'click' : 'drag';
        btnResetSelection.style.display = (inputMode === 'click') ? 'block' : 'none';
        btnTerminate.style.display = 'none';

        if (forceSeed) {
            currentSeed = forceSeed;
            isBiatchMode = currentSeed.includes('-B1');
            isCrazyMode = currentSeed.includes('-C1');
            useBonuses = currentSeed.endsWith('+') || isCrazyMode || isBiatchMode;
            
            const sizeMatch = currentSeed.match(/-S(\d+)/);
            if(sizeMatch && sizeMatch[1]) {
                gridSize = parseInt(sizeMatch[1]);
            } else {
                gridSize = 5; 
            }

            const timeMatch = currentSeed.match(/-T(\d+)/);
            if(timeMatch && timeMatch[1]) {
                timeRemaining = parseInt(timeMatch[1]);
            } else {
                const modalTimer = document.getElementById('modal-timer-select');
                timeRemaining = parseInt(modalTimer ? modalTimer.value : 180);
            }
        } else {
            const baseSeed = Math.random().toString(36).substring(7).toUpperCase();
            const modalTimer = document.getElementById('modal-timer-select');
            const selectedTime = parseInt(modalTimer ? modalTimer.value : 180);
            timeRemaining = selectedTime;

            let tags = `-S${gridSize}-T${timeRemaining}`;
            if (isBiatchMode) tags += "-B1";
            if (isCrazyMode) tags += "-C1";
            else if (useBonuses) tags += "+";
            
            currentSeed = baseSeed + tags;
        }
        
        const manualRotBtn = document.getElementById('manual-rotate-btn');
        if(manualRotBtn) manualRotBtn.style.display = 'none';

        initialTime = timeRemaining;
        if (gridSize === 4 && timeRemaining === 45) showElenaPopup();

        timerDisplay.textContent = formatTime(timeRemaining);
        timerDisplay.className = "";
        displaySeed.textContent = currentSeed;
        overlaySeed.textContent = currentSeed;

        const cleanSeed = currentSeed.split('-')[0];
        
        generateGridData(cleanSeed);
        renderGrid();
        calculatePossibleWordsCount();
        document.getElementById('possible-count').parentElement.style.visibility = 'visible';
        
        if (matchId) {
            gridOverlay.style.display = 'none';
            document.getElementById('start-screen').style.display = 'none';
        } else {
            document.getElementById('start-screen').style.display = 'none';
            gridOverlay.style.display = 'flex';
            document.querySelectorAll('.tile').forEach(t => t.classList.add('blurred'));
        }

        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?code=' + currentSeed;
        window.history.pushState({path:newUrl},'',newUrl);
    }

    function generateGridData(rngSeedStr) {
        const seedHash = cyrb128(rngSeedStr);
        const rand = sfc32(seedHash[0], seedHash[1], seedHash[2], seedHash[3]);
        
        gridLetters = []; 
        gridBonuses = [];
        const totalCells = gridSize * gridSize;
        
        for (let i = 0; i < totalCells; i++) gridLetters.push(LETTER_POOL.charAt(Math.floor(rand() * LETTER_POOL.length)));
        
        for (let i = 0; i < totalCells; i++) {
            let bonus = null;
            let rngVal = rand(); 
            let bonusProbability = isCrazyMode ? 0.70 : 0.20;
            if(rngVal < bonusProbability) {
                const r = rand(); 
                if (isCrazyMode) {
                    if(r < 0.30) bonus = "2L"; 
                    else if(r < 0.50) bonus = "3L"; 
                    else if(r < 0.75) bonus = "2P"; 
                    else bonus = "3P"; 
                } else {
                    if(r < 0.60) bonus = "2L"; else if(r < 0.85) bonus = "3L"; else if(r < 0.95) bonus = "2P"; else bonus = "3P"; 
                }
            }
            gridBonuses.push(useBonuses ? bonus : null);
        }

        if (rngSeedStr.includes("B7S3T") && totalCells >= 5) {
            const secretWord = ['B', 'U', 'S', 'E', 'T'];
            let inserted = false;
            let attempts = 0;

            while (!inserted && attempts < 500) {
                attempts++;
                let currentPath = [];
                let usedIndices = new Set();

                let currentIdx = Math.floor(rand() * totalCells);
                currentPath.push(currentIdx);
                usedIndices.add(currentIdx);

                for (let i = 1; i < secretWord.length; i++) {
                    let r = Math.floor(currentIdx / gridSize);
                    let c = currentIdx % gridSize;
                    let validNeighbors = [];

                    for (let nr = r - 1; nr <= r + 1; nr++) {
                        for (let nc = c - 1; nc <= c + 1; nc++) {
                            if (nr >= 0 && nr < gridSize && nc >= 0 && nc < gridSize) {
                                let nIdx = nr * gridSize + nc;
                                if (nIdx !== currentIdx && !usedIndices.has(nIdx)) {
                                    validNeighbors.push(nIdx);
                                }
                            }
                        }
                    }

                    if (validNeighbors.length === 0) break;

                    let nextIdx = validNeighbors[Math.floor(rand() * validNeighbors.length)];
                    currentPath.push(nextIdx);
                    usedIndices.add(nextIdx);
                    currentIdx = nextIdx;
                }

                if (currentPath.length === secretWord.length) {
                    for (let k = 0; k < secretWord.length; k++) {
                        gridLetters[currentPath[k]] = secretWord[k];
                    }
                    inserted = true;
                }
            }
        }
    }

    function renderGrid() {
        gridEl.innerHTML = '';
        gridEl.style.setProperty('--grid-cols', gridSize);
        
        let displayLetters = [...gridLetters];
        let displayBonuses = [...gridBonuses];
        for(let r=0; r<rotationIndex; r++) { displayLetters = rotateArray(displayLetters); displayBonuses = rotateArray(displayBonuses); }
        
        const totalCells = gridSize * gridSize;

        for (let i = 0; i < totalCells; i++) {
            const char = displayLetters[i];
            const bonus = displayBonuses[i];
            const tile = document.createElement('div');
            tile.classList.add('tile');
            if(!isGameActive && !isAnalysisPhase && !isPaused && !isSandboxMode) tile.classList.add('blurred');
            
            if(gridSize === 4) tile.classList.add('medium-font'); 
            else if(gridSize === 5) tile.classList.add('five-font');
            else if(gridSize === 6) tile.classList.add('six-font');                 
            else if(gridSize === 7) tile.classList.add('compact-font'); 
            else if(gridSize >= 10) tile.classList.add('small-font');   

            tile.textContent = char === 'Q' ? 'Qu' : char;
            
            if(char === 'Q') {
                if(gridSize <= 5) tile.style.fontSize = "1.3rem"; 
                else if(gridSize === 6) tile.style.fontSize = "1.15rem"; 
                else if(gridSize === 7) tile.style.fontSize = "1.0rem"; 
            }
            
            tile.dataset.index = i;
            tile.dataset.bonus = bonus || "";

            if(bonus) {
                const badge = document.createElement('span');
                badge.className = `bonus-badge b-${bonus.toLowerCase()}`;
                badge.textContent = bonus;
                tile.appendChild(badge);
            }
            
            const startHandler = (e) => {
                if (!canInteract()) return;
                
                if(errorTimeout){
                    clearTimeout(errorTimeout);
                    errorTimeout = null;
                }
                
                wordDisplayLocked = false;
                wordDisplay.style.background = "#dfe6e9";
                wordDisplay.textContent = '';
                
                document.querySelectorAll('.tile').forEach(t => {
                    t.classList.remove('selected');
                    t.classList.remove('anim-invalid');
                    t.classList.remove('anim-valid');
                });
                
                selectedCells = [];
                lineLayer.innerHTML = '';
                currentHighlightedWord = null;
                
                if(!isGameActive) return;
                
                if (inputMode === 'drag') { 
                    e.preventDefault(); 
                    inputState.isDragging = true; 
                    selectTile(i); 
                } else {
                    handleClickMode(i);
                }
            };

            tile.addEventListener('mousedown', startHandler);
            tile.addEventListener('touchstart', startHandler, {passive:false});
            gridEl.appendChild(tile);
        }
        gridEl.dataset.letters = JSON.stringify(displayLetters);
        gridEl.dataset.bonuses = JSON.stringify(displayBonuses);
    }

    function rotateArray(arr) {
        const newArr = new Array(gridSize * gridSize);
        for(let r=0; r<gridSize; r++) {
            for(let c=0; c<gridSize; c++) {
                newArr[c * gridSize + (gridSize - 1 - r)] = arr[r * gridSize + c];
            }
        }
        return newArr;
    }

    function rotateGrid() {
        if (isPaused) return;
        if (!isGameActive && !isAnalysisPhase && !isSandboxMode) return;
        if (inputState.isRotating) return; 
        
        inputState.isRotating = true;
        clearSelection();

        const duration = 300; 
        const easing = "cubic-bezier(0.25, 1, 0.5, 1)"; 

        const transitionStyle = `transform ${duration}ms ${easing}`;
        gridEl.style.transition = transitionStyle;
        
        const tiles = document.querySelectorAll('.tile');
        tiles.forEach(t => t.style.transition = transitionStyle);

        gridEl.style.transform = "rotate(90deg)";
        tiles.forEach(t => t.style.transform = "rotate(-90deg)");

        setTimeout(() => {
            gridEl.style.transition = "none";
            rotationIndex = (rotationIndex + 1) % 4;
            if(typeof rotationCount !== 'undefined') rotationCount++; 
            runAchievementCheck();
            renderGrid();
            gridEl.style.transform = "rotate(0deg)";
            inputState.isRotating = false;
        }, duration);
    }
    
    function calculatePossibleWordsCount() {
        const countEl = document.getElementById('possible-count');
        countEl.textContent = '...';
        countEl.style.opacity = '0.6';

        setTimeout(() => {
            if (!trieRoot) { countEl.textContent = '?'; return; }

            const vizL = JSON.parse(gridEl.dataset.letters);
            const total = gridSize * gridSize;
            const adjMap = Array.from({length: total}, (_, i) => getNeighbors(i));
            const found = new Set();
            const maxTime = 8000;
            const startCalc = performance.now();

            function countSolve(idx, word, visited) {
                if (performance.now() - startCalc > maxTime) return;
                visited[idx] = true;
                if (!hasPrefix(word)) { visited[idx] = false; return; }
                if (word.length >= MIN_WORD_LENGTH && dictionary.has(word)) {
                    found.add(word);
                }
                if (word.length >= 12) { visited[idx] = false; return; }
                for (let n of adjMap[idx]) {
                    if (!visited[n]) {
                        let ch = vizL[n];
                        if (ch === 'Q') ch = 'QU';
                        countSolve(n, word + ch, visited);
                    }
                }
                visited[idx] = false;
            }

            for (let i = 0; i < total; i++) {
                if (performance.now() - startCalc > maxTime) break;
                let ch = vizL[i];
                if (ch === 'Q') ch = 'QU';
                countSolve(i, ch, new Array(total).fill(false));
            }

            countEl.textContent = found.size;
            countEl.style.opacity = '1';
        }, 300);
    }
    
    function startRound() {
        isGameActive = true; isPaused = false; gridOverlay.style.display = 'none';
        gameControls.style.display = 'flex'; btnTerminate.style.display = 'block';
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('blurred'));
        
        const rotateBtn = document.getElementById('manual-rotate-btn');
        if (rotateBtn) {
            rotateBtn.style.display = isBiatchMode ? 'none' : 'block';
        }
        
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeRemaining--; updateTimerDisplay();
            if (timeRemaining <= 0) endGame();
        }, 1000);
    }

    function togglePause() {
        if(!isGameActive && !isPaused) return;
        const listEl = document.getElementById('found-words');
        const rotateBtn = document.getElementById('manual-rotate-btn');
        
        if(!isPaused) {
            isPaused = true; isGameActive = false; clearInterval(timerInterval);
            runAchievementCheck();
            pauseOverlay.style.display = 'flex'; listEl.classList.add('blurred-list');
            btnPause.textContent = "RIPRENDI"; 
            btnPause.classList.add('paused');
            if (rotateBtn) rotateBtn.style.display = 'none';
            clearSelection();
        } else {
            isPaused = false; isGameActive = true; pauseOverlay.style.display = 'none';
            listEl.classList.remove('blurred-list'); 
            btnPause.textContent = "PAUSA"; 
            btnPause.classList.remove('paused');
            if (rotateBtn && !isBiatchMode) rotateBtn.style.display = 'block';
            timerInterval = setInterval(() => { timeRemaining--; updateTimerDisplay(); if (timeRemaining <= 0) endGame(); }, 1000);
        }
    }

    function endGameManually() { if(confirm("Terminare ora?")) endGame(); }
   
    function closeEndGameModal() {
        const modal = document.getElementById('game-end-modal');
        if (modal) modal.style.display = 'none';
        stopFireworks();
        document.body.classList.remove('mega-win-effect');
        
        if (window.autoCloseEndGameTimeout) {
            clearTimeout(window.autoCloseEndGameTimeout);
            window.autoCloseEndGameTimeout = null;
        }
    }    
    
    function endGame() {
        if (typeof registraPartita === 'function') {
            registraPartita('ruzzle');
        } else {
            const STATS_KEY = 'funatwork_daily_stats';
            const oggi = new Date().toISOString().split('T')[0];
            const stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{"days":{},"totals":{}}');
            if (!stats.days[oggi]) stats.days[oggi] = {};
            stats.days[oggi].ruzzle = (stats.days[oggi].ruzzle || 0) + 1;
            stats.totals.ruzzle = (stats.totals.ruzzle || 0) + 1;
            localStorage.setItem(STATS_KEY, JSON.stringify(stats));
        }
        clearInterval(timerInterval);
        isGameActive = false;

        if (typeof matchId !== 'undefined' && matchId) {
            const mieParole = [];
            foundWords.forEach((v, k) => { mieParole.push({w: k, p: v.points, path: v.path});});
            
            db.collection("partite").doc(matchId).update({
                [`parole.${mioNome}`]: mieParole,
                finito: firebase.firestore.FieldValue.arrayUnion(mioNome) 
            });

            document.getElementById('multiplayer-lobby').style.display = 'flex';
            document.getElementById('lobby-title').textContent = "FINE TEMPO!";
            document.getElementById('lobby-status').textContent = "Attendo che l'avversario finisca il suo tempo.";
        }
        
        const gandhiContext = {
            game: {
                isOver: true,
                score: score,
                isPaused: false,
                wordCount: foundWords.size,
                elapsedTime: initialTime
            },
            stats: { totalGames: 100, totalScore: 100, highScore: 100 },
            last: { word: null, points: 0 }
        };
        
        const gandhiAch = ACHIEVEMENTS.find(a => a.id === 'gandhi');
        const data = getStorageData();
        
        if (gandhiAch && !data.achievements.includes('gandhi')) {
            if (gandhiAch.check(gandhiContext)) {
                data.achievements.push('gandhi');
                localStorage.setItem('paroliere_data', JSON.stringify(data));
                showAchievement(gandhiAch.title);
            }
        }
          
        timerDisplay.classList.remove('timer-alert');
        
        currentGameTimestamp = Date.now();
        updateStats(); 
        
        gameControls.style.display = 'none'; 
        pauseOverlay.style.display = 'none';
        
        isGameActive = true;
        isSandboxMode = true;
        isAnalysisPhase = true;
        
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('blurred'));
        
        btnSandbox.style.display = 'none'; 
        
        document.getElementById('found-words').classList.remove('blurred-list');
        clearSelection(); 
        wordDisplay.textContent = ""; 
        lineLayer.innerHTML = '';
        
        sortDescending = true; 
        document.getElementById('sort-dir-btn').textContent = "‚¨áÔ∏è";
        setSortMode('alpha');

        wordsListEl.classList.add('interactive');
        analysisMsg.style.display = "block"; 
        sortControls.style.display = "flex";
        btnMissed.style.display = "block";
        
        const rotateBtn = document.getElementById('manual-rotate-btn');
        if (rotateBtn && !isBiatchMode) rotateBtn.style.display = 'block';
        
        document.getElementById('fixed-home-btn').style.display = 'block';
        
        fireConfettiLight();
    }

    function startSandbox() {
        isSandboxMode = true; isGameActive = true; isAnalysisPhase = true; btnSandbox.style.display = 'none';
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('blurred'));
        timerDisplay.textContent = "MODALIT√Ä LIBERA"; timerDisplay.style.color = "var(--primary)";
    }

    // --- INPUT SYSTEM ---
    function getCenter(el) { const r = el.getBoundingClientRect(); return { x: r.left + r.width/2, y: r.top + r.height/2 }; }
    function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
    
    function handleClickMode(i) {
        if(selectedCells.includes(i)) {
             if(i === selectedCells[selectedCells.length-1]) validateWord();
             else if(selectedCells.length > 1 && i === selectedCells[selectedCells.length-2]) { selectedCells.pop(); updateVisuals(); }
             return;
        }
        if(selectedCells.length === 0 || isAdjacent(selectedCells[selectedCells.length-1], i)) { selectedCells.push(i); updateVisuals(); }
    }
    
    const moveListener = (x, y) => {
        if (inputMode !== 'drag' || !inputState.isDragging || !isGameActive) return;
        let closest = -1, minD = 9999;
        const last = selectedCells[selectedCells.length - 1];
        const candidates = getNeighbors(last); candidates.push(last);
        if(selectedCells.length > 1) candidates.push(selectedCells[selectedCells.length - 2]);
        candidates.forEach(idx => {
            const tile = gridEl.children[idx]; const d = dist({x, y}, getCenter(tile));
            if (d < tile.offsetWidth * 0.45 && d < minD) { minD = d; closest = idx; }
        });
        if (closest !== -1) attemptSelection(closest);
    };

    // ‚úÖ MANAGED LISTENERS
    addManagedListener(document, 'mousemove', (e) => { 
        if (inputMode==='drag' && inputState.isDragging) moveListener(e.clientX, e.clientY); 
    });
    addManagedListener(document, 'touchmove', (e) => { 
        if (inputMode==='drag' && inputState.isDragging) { 
            e.preventDefault(); 
            moveListener(e.touches[0].clientX, e.touches[0].clientY); 
        } 
    }, {passive:false});
    addManagedListener(document, 'mouseup', () => endDrag());
    addManagedListener(document, 'touchend', () => endDrag());
     
    function selectTile(i) { selectedCells = [i]; updateVisuals(); }
    function attemptSelection(i) {
        const last = selectedCells[selectedCells.length - 1];
        if (i === last) return;
        if (selectedCells.length > 1 && i === selectedCells[selectedCells.length - 2]) { selectedCells.pop(); updateVisuals(); return; }
        if (!selectedCells.includes(i) && isAdjacent(last, i)) { selectedCells.push(i); updateVisuals(); }
    }

    function getNeighbors(idx) {
        const n = [], r = Math.floor(idx / gridSize), c = idx % gridSize;
        for(let i=r-1; i<=r+1; i++) 
            for(let j=c-1; j<=c+1; j++) 
                if(i>=0 && i<gridSize && j>=0 && j<gridSize && !(i===r && j===c)) 
                    n.push(i * gridSize + j);
        return n;
    }
    
    function isAdjacent(i1, i2) { return getNeighbors(i1).includes(i2); }
    
    function updateVisuals() {
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
        let txt = ""; const letters = JSON.parse(gridEl.dataset.letters);
        selectedCells.forEach(idx => { gridEl.children[idx].classList.add('selected'); txt += (letters[idx] === 'Q' ? 'QU' : letters[idx]); });
        
        if (!wordDisplayLocked) {
            wordDisplay.textContent = txt;
        }
        drawLine();
    }

    function clearSelection() { 
        document.querySelectorAll('.tile').forEach(t => {
            t.classList.remove('selected');
            t.classList.remove('anim-valid');
            t.classList.remove('anim-invalid');
        });
        
        selectedCells = []; 
        lineLayer.innerHTML = ''; 
        
        if (!wordDisplayLocked) {
            wordDisplay.textContent = ""; 
        }
        
        currentHighlightedWord = null; 
    }

    function clearSelectionImmediate() {
        document.querySelectorAll('.tile').forEach(t => {
            t.classList.remove('anim-invalid', 'selected', 'anim-valid');
        });
        selectedCells = [];
        lineLayer.innerHTML = '';
        wordDisplay.textContent = "";
        wordDisplay.style.background = "#dfe6e9";
        currentHighlightedWord = null;
    }
    
    function drawLine() {
        lineLayer.innerHTML = ''; if (selectedCells.length < 2) return;
        let points = selectedCells.map(idx => { const t = gridEl.children[idx]; return `${t.offsetLeft + t.offsetWidth/2},${t.offsetTop + t.offsetHeight/2}`; }).join(" ");
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        poly.setAttribute("points", points); poly.setAttribute("fill", "none"); poly.setAttribute("stroke", "var(--line-color)"); poly.setAttribute("stroke-width", gridSize >= 10 ? "4" : "8");
        poly.setAttribute("stroke-linecap", "round"); poly.setAttribute("stroke-linejoin", "round");
        lineLayer.appendChild(poly);
    }

    function getVisualIndexFromOriginal(originalIdx, rot) {
        let curr = originalIdx;
        for(let i=0; i<rot; i++) { 
            const r = Math.floor(curr/gridSize), c = curr%gridSize; 
            curr = c*gridSize + (gridSize - 1 - r); 
        }
        return curr;
    }
    function getOriginalIndexFromVisual(visualIdx, rot) {
        let curr = visualIdx; const inverseRot = (4 - (rot % 4)) % 4;
        for(let i=0; i<inverseRot; i++) { 
            const r = Math.floor(curr/gridSize), c = curr%gridSize; 
            curr = c*gridSize + (gridSize - 1 - r); 
        }
        return curr;
    }
    
    function showWordOnGrid(word) {
        if(currentHighlightedWord === word) { clearSelection(); return; }
        if(!foundWords.has(word)) return;
        const data = foundWords.get(word); if(!data.path) return;
        clearSelection(); currentHighlightedWord = word;
        selectedCells = data.path.map(idx => getVisualIndexFromOriginal(idx, rotationIndex));
        updateVisuals();
        selectedCells.forEach(i => gridEl.children[i].classList.add('anim-valid'));
        setTimeout(() => { document.querySelectorAll('.tile').forEach(t=>t.classList.remove('anim-valid')); }, 1500);
    }

    function triggerBusetExplosion() {
        document.body.classList.add('mega-win-effect');

        if (fireworksInterval) clearInterval(fireworksInterval);
        fireworksInterval = setInterval(() => {
            launchFirework();
            launchFirework();
        }, 150);

        setTimeout(() => {
            document.body.classList.remove('mega-win-effect');
            stopFireworks();
        }, 5000);
    }

    // --- ‚úÖ SISTEMA VALIDAZIONE OTTIMIZZATO ---
    const endDrag = () => { 
        if (!inputState.isDragging) return;
        
        const wordSnapshot = wordDisplay.textContent;
        const cellsSnapshot = [...selectedCells];
        
        inputState.isDragging = false;
        
        if (wordSnapshot.length >= MIN_WORD_LENGTH && cellsSnapshot.length >= MIN_WORD_LENGTH) {
            validateWord(wordSnapshot, cellsSnapshot);
        } else if (cellsSnapshot.length > 0) {
            clearSelectionImmediate();
        }
    };

    function validateWord(wordParam = null, cellsParam = null) {
        const word = wordParam || wordDisplay.textContent;
        const currentCells = cellsParam || [...selectedCells];
        
        if (!word || word.length === 0 || currentCells.length === 0) {
            return;
        }
        
        if (errorTimeout) {
            clearTimeout(errorTimeout);
            errorTimeout = null;
        }
        
        // === MODALIT√Ä SANDBOX ===
        if (isSandboxMode) {
            if (word.length >= MIN_WORD_LENGTH && dictionary.has(word)) {
                const pts = calculateScoreWithBonuses(word, currentCells);                
                wordDisplayLocked = true;
                wordDisplay.textContent = `${word} (+${pts} pt)`;
                wordDisplay.style.background = "#2ecc71";
                
                selectedCells = [];
                lineLayer.innerHTML = '';
                document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
                
                currentCells.forEach(i => {
                    if(gridEl.children[i]) gridEl.children[i].classList.add('anim-valid');
                });
                
                errorTimeout = setTimeout(() => {
                    document.querySelectorAll('.tile').forEach(t => t.classList.remove('anim-valid'));
                    wordDisplay.style.background = "#dfe6e9"; 
                    wordDisplayLocked = false;
                    wordDisplay.textContent = '';
                    errorTimeout = null;
                }, 800);
            } else { 
                shakeAndClear(currentCells);
            }
            return;
        }

        // === MODALIT√Ä GIOCO ===
        if (word.length < MIN_WORD_LENGTH) { 
            shakeAndClear(currentCells); 
            return; 
        }
        
        if (foundWords.has(word)) { 
            wordDisplay.style.background = "#f1c40f"; 
            selectedCells = [];
            lineLayer.innerHTML = '';
            document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
            setTimeout(()=>wordDisplay.style.background="#dfe6e9", 300); 
            return; 
        }
        
        if (dictionary.has(word)) {
            // PAROLA VALIDA!
            const pts = calculateScoreWithBonuses(word, currentCells);
            const originalPath = currentCells.map(vIdx => getOriginalIndexFromVisual(vIdx, rotationIndex));
            foundWords.set(word, { points: pts, active: true, index: ++wordCounter, path: originalPath });

            if (pts >= 10) fireConfettiLight();
            if (word === "BUSET") triggerBusetExplosion();
            
            if (isBiatchMode) {
                rotateGrid();
                showBiatchOverlay();
            }

            runAchievementCheck(word, pts);
            updateTotalScore();
            
            // Pulisci SUBITO
            selectedCells = [];
            lineLayer.innerHTML = '';
            document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
            
            // Feedback visivo verde
            currentCells.forEach(i => {
                if(gridEl.children[i]) {
                    gridEl.children[i].classList.add('anim-valid');
                }
            });
            
            setTimeout(() => {
                document.querySelectorAll('.tile').forEach(t => t.classList.remove('anim-valid'));
            }, 250);
            
            wordCountDisplay.textContent = foundWords.size;
            
            // Aggiungi alla lista
            const li = document.createElement('li'); 
            li.dataset.word = word;
            li.innerHTML = `<div class="word-item-left"><button class="btn-eye" onclick="showWordOnGrid('${word}')" title="Mostra">üëÅÔ∏è</button><span>${word}</span></div><span class="pts">+${pts}</span>`;
            li.addEventListener('click', (e) => { 
                if(isAnalysisPhase && !e.target.classList.contains('btn-eye')) toggleWord(word, li); 
            });
            wordsListEl.insertBefore(li, wordsListEl.firstChild);
            
            // Mostra conferma BREVE
            wordDisplayLocked = true;
            wordDisplay.textContent = `${word} (+${pts})`;
            wordDisplay.style.background = "#2ecc71";
            
            setTimeout(() => {
                if (!inputState.isDragging) {
                    wordDisplay.style.background = "#dfe6e9";
                    wordDisplayLocked = false;
                    wordDisplay.textContent = "";
                }
            }, 600);
            
        } else { 
            shakeAndClear(currentCells);
        }
    }

    function shakeAndClear(cells) {
        errorCount++;
        
        wordDisplay.style.background = "#e74c3c";
        
        cells.forEach(i => {
            if(gridEl.children[i]) gridEl.children[i].classList.add('anim-invalid');
        });
        
        setTimeout(() => {
            document.querySelectorAll('.tile').forEach(t => {
                t.classList.remove('anim-invalid');
                t.classList.remove('selected');
            });
            selectedCells = [];
            lineLayer.innerHTML = '';
            wordDisplay.style.background = "#dfe6e9";
            wordDisplay.textContent = "";
            wordDisplayLocked = false;
        }, 200);
    }

    function calculateScoreWithBonuses(word, cells) {
        let pts = 0;
        if (word.length === 4) pts = 1; else if (word.length === 5) pts = 2; else if (word.length === 6) pts = 3; else if (word.length === 7) pts = 5; else if (word.length >= 8) pts = 11;
        let wordMult = 1; const bonuses = JSON.parse(gridEl.dataset.bonuses);
        cells.forEach(idx => {
            const b = bonuses[idx];
            if(b === "2L") pts += 2; else if(b === "3L") pts += 3; else if(b === "2P") wordMult *= 2; else if(b === "3P") wordMult *= 3;
        });
        return pts * wordMult;
    }
    
    function updateTotalScore() {
        score = 0; 
        foundWords.forEach(v => { if(v.active) score += v.points; });
        scoreDisplay.textContent = score;
        if(isAnalysisPhase) updateHistoryScore();

        if (typeof matchId !== 'undefined' && matchId && db) {
            db.collection("partite").doc(matchId).update({
                [`punteggi.${mioNome}`]: score
            }).catch(e => {});
        }
    }
    
    function toggleWord(w, li) {
        const d = foundWords.get(w); d.active = !d.active;
        li.classList.toggle('deleted', !d.active); li.querySelector('.pts').textContent = d.active ? "+" + d.points : "0";
        updateTotalScore();
        runAchievementCheck();
    }

    // --- ACHIEVEMENTS E STATISTICHE ---
    function getStorageData() {
        return JSON.parse(localStorage.getItem('paroliere_data')) || {
            games: [], totalGames: 0, totalScore: 0, highScore: 0, 
            bestWord: "", bestWordVal: 0, bestWordLen: 0, bestWordLenW: "", 
            achievements: []
        };
    }

    function runAchievementCheck(lastWord = null, lastPts = 0) {
        let data = getStorageData();
        const unlockedNow = [];
        let activeCount = 0;
        foundWords.forEach(v => { if(v.active) activeCount++; });
        const deletedCount = foundWords.size - activeCount;
        const context = {
            stats: {
                totalGames: data.totalGames + (isGameActive ? 0 : 1),
                totalScore: data.totalScore + score,
                highScore: Math.max(data.highScore, score)
            },
            game: {
                score: score,
                wordCount: foundWords.size,
                deletedCount: deletedCount,
                rotationCount: rotationCount,
                errorCount: errorCount,
                elapsedTime: initialTime - timeRemaining,
                timeRemaining: timeRemaining,
                isOver: !isGameActive,
                isPaused: isPaused
            },
            last: { word: lastWord, points: lastPts }
        };

        ACHIEVEMENTS.forEach(ach => {
            if (!data.achievements.includes(ach.id)) {
                try {
                    if (ach.check(context)) {
                        data.achievements.push(ach.id);
                        unlockedNow.push(ach.title);
                        showAchievement(ach.title);
                    }
                } catch(e) { console.error("Err ach", ach.id, e); }
            }
        });
        if(unlockedNow.length > 0) localStorage.setItem('paroliere_data', JSON.stringify(data));
    }

    function updateStats() {
        let data = getStorageData();
        let maxLen = 0; let bestLenW = "";
        let maxScore = 0; let bestScoreW = "";

        foundWords.forEach((v, k) => { 
            if(v.active) {
                if(k.length > maxLen) { maxLen = k.length; bestLenW = k; }
                if(v.points > maxScore) { maxScore = v.points; bestScoreW = k; }
            } 
        });

        data.totalGames++;
        data.totalScore += score;
        if(score > data.highScore) data.highScore = score;
        if(maxLen > data.bestWordLen) { data.bestWordLen = maxLen; data.bestWordLenW = bestLenW; }
        if(maxScore > data.bestWordVal) { data.bestWordVal = maxScore; data.bestWord = bestScoreW; }

        const entry = { date: new Date().toLocaleDateString('it-IT', {hour:'2-digit', minute:'2-digit'}), seed: currentSeed, score: score, id: currentGameTimestamp };
        data.games.unshift(entry);
        if(data.games.length > 20) data.games = data.games.slice(0, 20);

        localStorage.setItem('paroliere_data', JSON.stringify(data));
        currentGameTimestamp = Date.now();
        runAchievementCheck(null, 0);
    }
    
    function showElenaPopup() {
        const box = document.getElementById('ach-notification');
        const txt = document.getElementById('ach-text');
        if (!box || !txt) return;

        txt.textContent = "GRAZIE ELENA PER QUESTA GENIALATA";
        box.classList.add('show');
        fireConfetti(box);
        setTimeout(() => box.classList.remove('show'), 2500);
    }
     
    function showAchievement(text) {
        const el = document.getElementById('ach-text');
        const notifBox = document.getElementById('ach-notification');
        
        el.textContent = text;
        notifBox.classList.add('show');
        
        setTimeout(() => notifBox.classList.remove('show'), 2000);
        
        fireConfetti(notifBox);
    }

    function openStats() {
        const data = getStorageData();
        document.getElementById('stat-total-games').textContent = data.totalGames;
        document.getElementById('stat-high-score').textContent = data.highScore;
        document.getElementById('stat-total-score').textContent = data.totalScore;
        document.getElementById('stat-best-word').textContent = data.bestWordVal > 0 ? `${data.bestWord} (${data.bestWordVal})` : "-";
        document.getElementById('stat-longest-word').textContent = data.bestWordLen > 0 ? `${data.bestWordLenW} (${data.bestWordLen})` : "-";
        const avg = data.totalGames > 0 ? Math.round(data.totalScore / data.totalGames) : 0;
        document.getElementById('stat-avg-score').textContent = avg; 

        const achDiv = document.getElementById('achievements-list');
        achDiv.innerHTML = ACHIEVEMENTS.map(ach => {
            const unlocked = data.achievements && data.achievements.includes(ach.id);
            return `<div style="padding:5px; margin-bottom:5px; border-radius:4px; background:${unlocked ? 'rgba(39, 174, 96, 0.1)' : 'transparent'}; border-left:3px solid ${unlocked ? '#27ae60' : '#ccc'}">
                <div style="font-weight:bold; color:${unlocked ? '#27ae60' : '#7f8c8d'}">${unlocked ? 'üèÜ' : 'üîí'} ${ach.title}</div>
                <div style="font-size:0.85rem; opacity:0.8;">${ach.desc}</div>
            </div>`;
        }).join('');

        historyListBody.innerHTML = "";
        data.games.forEach(g => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${g.date}</td><td>${g.seed}</td><td style="font-weight:bold; color:var(--primary)">${g.score}</td>`;
            historyListBody.appendChild(tr);
        });
        statsModal.style.display = 'flex';
    }

    function updateHistoryScore() {
        if(!currentGameTimestamp) return;
        let data = getStorageData();
        const index = data.games.findIndex(g => g.id === currentGameTimestamp);
        if(index !== -1) {
             data.games[index].score = score;
             localStorage.setItem('paroliere_data', JSON.stringify(data));
        }
    }
    
    function clearData() {
        if(confirm("Cancellare TUTTI i dati?")) { localStorage.removeItem('paroliere_data'); openStats(); }
    }

    // --- SOLVER ---
    function showMissedWords() {
        if(!confirm("L'analisi potrebbe richiedere del tempo. Continuare?")) return;
          
        const container = document.querySelector('.game-container');
        const overlay = document.getElementById('calculation-overlay');
        
        container.classList.add('processing-blur');
        overlay.style.display = 'flex';
        
        setTimeout(() => {
            try {
                const visualLetters = JSON.parse(gridEl.dataset.letters); 
                const visualBonuses = JSON.parse(gridEl.dataset.bonuses);
                const adjMap = Array.from({length: gridSize * gridSize}, (_, i) => getNeighbors(i));
                const possibleWords = [];
                const start = performance.now();
                const foundSet = new Set();
                const maxTime = 10000;
                const totalCells = gridSize * gridSize;

                function solve(idx, currentWord, visited, currentPath) {
                    if(performance.now() - start > maxTime) return; 
                    visited[idx] = true; currentPath.push(idx);
                    
                    if(trieRoot && !hasPrefix(currentWord)) { visited[idx] = false; currentPath.pop(); return; }
                    
                    if(currentWord.length >= MIN_WORD_LENGTH && dictionary.has(currentWord) && !foundWords.has(currentWord) && !foundSet.has(currentWord)) {
                        foundSet.add(currentWord);
                        const pts = calculateScoreWithBonusesSolver(currentWord, [...currentPath], visualBonuses);
                        possibleWords.push({w: currentWord, p: pts});
                    }
                    if(currentWord.length >= 12) { visited[idx] = false; currentPath.pop(); return; }
                    for(let n of adjMap[idx]) { if(!visited[n]) { let nextChar = visualLetters[n]; if(nextChar === 'Q') nextChar = 'QU'; solve(n, currentWord + nextChar, visited, currentPath); } }
                    visited[idx] = false; currentPath.pop();
                }
                function calculateScoreWithBonusesSolver(word, cells, bonuses) {
                    let pts = 0;
                    if (word.length === 4) pts = 1; else if (word.length === 5) pts = 2; else if (word.length === 6) pts = 3; else if (word.length === 7) pts = 5; else if (word.length >= 8) pts = 11;
                    let wordMult = 1;
                    cells.forEach(idx => { const b = bonuses[idx]; if(b === "2L") pts += 2; else if(b === "3L") pts += 3; else if(b === "2P") wordMult *= 2; else if(b === "3P") wordMult *= 3; });
                    return pts * wordMult;
                }
                for(let i=0; i<totalCells; i++) { 
                    if(performance.now() - start > maxTime) break;
                    let char = visualLetters[i]; if(char === 'Q') char = 'QU'; 
                    solve(i, char, new Array(totalCells).fill(false), []); 
                }
                
                possibleWords.sort((a,b) => b.p - a.p);
                const top = possibleWords.slice(0, 10);
                if(top.length === 0) alert("Hai trovato tutto (o limite di tempo raggiunto)!");
                else alert("Top 10 parole mancate:\n\n" + top.map(x => `${x.w} (${x.p} pt)`).join('\n'));
            } catch(e) {
                console.error(e);
                alert("Si √® verificato un errore durante il calcolo.");
            } finally {
                container.classList.remove('processing-blur');
                overlay.style.display = 'none';
            }
        }, 100); 
    }

    function formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
    function updateTimerDisplay() {
        timerDisplay.textContent = formatTime(timeRemaining);
        const ratio = Math.max(0, timeRemaining / initialTime);
        const hue = Math.round(ratio * 120);
        timerDisplay.style.color = `hsl(${hue}, 85%, 50%)`;
        if (timeRemaining <= 10 && timeRemaining > 0) {
            timerDisplay.classList.add('timer-alert');
        } else {
            timerDisplay.classList.remove('timer-alert');
        }
    }
    
    function copySeed() { navigator.clipboard.writeText(currentSeed).then(() => alert("Codice copiato!")); }
    function copySeedNewGame() { navigator.clipboard.writeText(currentSeed); }
    function copyWords() { 
        const listItems = document.querySelectorAll('#found-words li');
        const exportList = [];

        listItems.forEach(li => {
            if (!li.classList.contains('deleted')) {
                exportList.push(li.dataset.word);
            }
        });

        if (exportList.length === 0) {
            alert("Nessuna parola valida da copiare.");
            return;
        }

        navigator.clipboard.writeText(exportList.join(',')).then(() => {
            alert(`Copiato! (${exportList.length} parole attive)`);
        });
    }

    function setSortMode(m) { 
        sortMode = m; 
        const btns = document.querySelectorAll('.sort-btn');
        btns.forEach(b => b.classList.remove('active')); 
        if(m === 'chrono' && btns[0]) btns[0].classList.add('active');
        if(m === 'alpha' && btns[1]) btns[1].classList.add('active');
        if(m === 'score' && btns[2]) btns[2].classList.add('active');
        sortList(); 
    }
    function toggleSortDirection() { sortDescending = !sortDescending; document.getElementById('sort-dir-btn').textContent = sortDescending ? "‚¨áÔ∏è" : "‚¨ÜÔ∏è"; sortList(); }
    function sortList() {
        const items = Array.from(wordsListEl.children); const m = sortDescending ? 1 : -1;
        items.sort((a,b) => {
            const wA = a.dataset.word, wB = b.dataset.word; const dA = foundWords.get(wA), dB = foundWords.get(wB);
            if(sortMode === 'alpha') return wA.localeCompare(wB) * m;
            if(sortMode === 'score') return (dB.points - dA.points) * m || wA.localeCompare(wB);
            return (dB.index - dA.index) * m;
        });
        wordsListEl.innerHTML = ""; items.forEach(i=>wordsListEl.appendChild(i));
    }

    function closeStats() { statsModal.style.display = 'none'; }
    function openLegend() { legendModal.style.display = 'flex'; }
    function closeLegend() { legendModal.style.display = 'none'; }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); }
    toggleInput.addEventListener('change', () => { clearSelection(); inputMode = toggleInput.checked ? 'click' : 'drag'; btnResetSelection.style.display = inputMode==='click'?'block':'none'; });
    
    function fireConfetti(originElement = null) {
        const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#ffffff', '#ff00ff'];
        const count = 150;

        let centerXPercent = 50;
        let centerYPercent = 50;

        if (originElement) {
            const rect = originElement.getBoundingClientRect();
            centerXPercent = ((rect.left + rect.width / 2) / window.innerWidth) * 100;
            centerYPercent = ((rect.top + rect.height / 2) / window.innerHeight) * 100;
        }

        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'confetti';

            const startX = centerXPercent + (Math.random() - 0.5) * 20; 
            const startY = centerYPercent + (Math.random() - 0.5) * 20;
            
            p.style.position = 'fixed';
            p.style.left = startX + '%';
            p.style.top = startY + '%';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            
            const size = Math.random() * 15 + 5; 
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            
            if (Math.random() > 0.5) p.style.borderRadius = '50%';
            
            p.style.zIndex = '10000';
            p.style.pointerEvents = 'none';

            document.body.appendChild(p);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 200 + Math.random() * 400;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            const rot = (Math.random() - 0.5) * 1000;

            p.animate([
                { transform: `translate(0,0) rotate(0deg) scale(1)`, opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(0.5)`, opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 1500, 
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)'
            }).onfinish = () => p.remove();
        }
    }

    function fireConfettiLight() {
        const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
        const count = 30;
        
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'confetti';
            
            p.style.position = 'fixed';
            p.style.left = (40 + Math.random() * 20) + '%';
            p.style.top = (30 + Math.random() * 20) + '%';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            
            const size = Math.random() * 10 + 5; 
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            if (Math.random() > 0.5) p.style.borderRadius = '50%';
            
            p.style.zIndex = '10000';
            p.style.pointerEvents = 'none';
            document.body.appendChild(p);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 100 + Math.random() * 150;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;

            p.animate([
                { transform: `translate(0,0) scale(1)`, opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
            ], {
                duration: 1000 + Math.random() * 500,
                easing: 'ease-out'
            }).onfinish = () => p.remove();
        }
    }

    function startEndGameCelebration() {
        if(fireworksInterval) clearInterval(fireworksInterval);
        
        let count = 0;
        fireworksInterval = setInterval(() => {
            launchFirework();
            launchFirework();
            count++;
            if(count > 40) stopFireworks(); 
        }, 200);
    }
    
    function stopFireworks() {
        if(fireworksInterval) {
            clearInterval(fireworksInterval);
            fireworksInterval = null;
        }
    }

    function launchFirework() {
        const colors = ['#ff0044', '#ffff00', '#00ff44', '#00ccff', '#ff00ff'];
        
        const startX = Math.random() * window.innerWidth;
        const startY = window.innerHeight;
        
        const endX = startX + (Math.random() - 0.5) * 200;
        const endY = window.innerHeight * 0.2 + Math.random() * window.innerHeight * 0.4;
        const color = colors[Math.floor(Math.random() * colors.length)];

        const rocket = document.createElement('div');
        rocket.style.position = 'fixed';
        rocket.style.left = startX + 'px';
        rocket.style.top = startY + 'px';
        rocket.style.width = '4px';
        rocket.style.height = '12px';
        rocket.style.background = color;
        rocket.style.borderRadius = '2px';
        rocket.style.zIndex = '9998';
        document.body.appendChild(rocket);

        rocket.animate([
            { transform: `translate(0, 0)` },
            { transform: `translate(${endX - startX}px, ${endY - startY}px)` }
        ], {
            duration: 1000,
            easing: 'ease-out'
        }).onfinish = () => {
            rocket.remove();
            explode(endX, endY, color);
        };

        function explode(x, y, color) {
            for (let i = 0; i < 80; i++) {
                const p = document.createElement('div');
                p.style.position = 'fixed';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.width = '6px';
                p.style.height = '6px';
                p.style.backgroundColor = color;
                p.style.borderRadius = '50%';
                p.style.zIndex = '9998';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                document.body.appendChild(p);

                p.animate([
                    { transform: `translate(0,0) scale(1)`, opacity: 1, offset: 0 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0.9)`, opacity: 0.9, offset: 0.2 },
                    { transform: `translate(${tx}px, ${ty + 500}px) scale(0)`, opacity: 0, offset: 1 }
                ], {
                    duration: 2000 + Math.random() * 2000,
                    easing: 'linear'
                }).onfinish = () => p.remove();
            }
        }
    }

    function showBiatchOverlay() {
        const texts = ["GIRA BIATCH!", "OPS!", "DI QUA!", "MUOVITI!", "üê∑üê∑üê∑"];
        const overlay = document.createElement('div');
        overlay.style = "position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); font-size:5rem; font-weight:900; color:#ff00ff; z-index:10000; pointer-events:none; text-shadow: 5px 5px 0px black;";
        overlay.textContent = texts[Math.floor(Math.random() * texts.length)];
        document.body.appendChild(overlay);
        
        fireConfetti(overlay); 

        setTimeout(() => overlay.remove(), 800);
    }

    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            if (e.target.id === 'game-end-modal') {
                closeEndGameModal();
                return;
            }
            e.target.style.display = 'none';
        }
    });
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden || !isGameActive || isPaused || isSandboxMode || matchId) return;
        togglePause();
    });

    // --- LOGICA DI GESTIONE FINALE ---

    // Richiedi login SOLO in multiplayer
    if (!mioNome && matchId) {
        alert("Effettua il login per giocare in multiplayer.");
        window.location.href = "index.html";
    }

    // ‚úÖ DEBOUNCE PER FIREBASE
    const aggiornaInterfacciaMultiplayer = debounce((data) => {
        const altri = data.partecipanti.filter(n => n !== mioNome);
        let scoresHtml = "";
        altri.forEach(a => {
            const punteggio = data.punteggi && data.punteggi[a] ? data.punteggi[a] : 0;
            scoresHtml += `<span style="margin:0 5px;">üÜö ${a}: <strong>${punteggio}</strong></span>`;
        });
        const scoreEl = document.getElementById('live-opponent-score');
        if (scoreEl && scoreEl.innerHTML !== scoresHtml) {
            scoreEl.innerHTML = scoresHtml;
        }
    }, 500);

    if (!matchId) {
        // MODALIT√Ä SOLO
        if(document.getElementById('multiplayer-lobby')) document.getElementById('multiplayer-lobby').style.display = 'none';
        if(document.getElementById('live-opponent-score')) document.getElementById('live-opponent-score').style.display = 'none';
        document.getElementById('manual-rotate-btn').style.display = 'none';
        document.getElementById('possible-count').parentElement.style.visibility = 'hidden';
        loadDictionary(); 
    } else {
        // MODALIT√Ä MULTIPLAYER
        
        if(unsubscribePartita) unsubscribePartita();
        if(unsubscribeProposte) unsubscribeProposte();
        
// ‚úÖ LISTENER PRINCIPALE PARTITA
unsubscribePartita = db.collection("partite").doc(matchId).onSnapshot(async doc => {
    const data = doc.data();
    if(!data) { window.location.href = "index.html"; return; }
    
    currentGameData = data;

    // Nascondi SEMPRE la lobby (usiamo solo banner)
    document.getElementById('multiplayer-lobby').style.display = 'none';

    const btnNewEl = document.querySelector('.btn-new');
    if (btnNewEl) {
        btnNewEl.style.display = (data.stato === 'conclusa') ? 'block' : 'none';
    }

    // APPLICA DIZIONARIO CUSTOM
    if(data.dizionarioCustom) {
        const extraLen = (data.dizionarioCustom.extra || []).length;
        const excludedLen = (data.dizionarioCustom.excluded || []).length;
        const currentVersion = `${extraLen}-${excludedLen}`;
        
        if(!dizionarioCustomApplicato || window.lastDictVersion !== currentVersion) {
            (data.dizionarioCustom.extra || []).forEach(w => {
                if(w && !EXTRA_WORDS.includes(w)) {
                    EXTRA_WORDS.push(w);
                    dictionary.add(w);
                }
            });
            (data.dizionarioCustom.excluded || []).forEach(w => {
                if(w && !EXCLUDED_WORDS.includes(w)) {
                    EXCLUDED_WORDS.push(w);
                    dictionary.delete(w);
                }
            });
            
            buildTrie();
            dizionarioCustomApplicato = true;
            window.lastDictVersion = currentVersion;
            if (DEBUG_MODE) console.log("Dizionario custom aggiornato:", currentVersion);
        }
    }
    
    const pronti = data.pronti || [];
    const finito = data.finito || [];
    const conferma = data.confermaVerifica || [];

    // ========================================
    // 1. ATTESA (gestita con banner, NO lobby)
    // ========================================
    if (data.stato === "attesa") {
        document.getElementById('fixed-home-btn').style.display = 'block';
        
        // Inizializza griglia in background (blurred)
        if (!gridEl.children.length || gridEl.children.length === 0) {
            gridSize = parseInt(data.opzioni.griglia);
            timeRemaining = parseInt(data.opzioni.tempo);
            initialTime = timeRemaining;
            currentSeed = data.opzioni.seed;
            isBiatchMode = (data.opzioni.mode === 'biatch');
            isCrazyMode = (data.opzioni.mode === 'crazy');
            useBonuses = (data.opzioni.mode !== 'classic');
            generateGridData(currentSeed.split('-')[0]);
            renderGrid();
            document.getElementById('start-screen').style.display = 'none';
            gridOverlay.style.display = 'none';
            document.querySelectorAll('.tile').forEach(t => t.classList.add('blurred'));
            timerDisplay.textContent = formatTime(timeRemaining);
        }
        
        if (!pronti.includes(mioNome)) {
            showGameBanner({
                icon: 'üéÆ',
                title: `SFIDA PRONTA`,
                subtitle: `Giocatori pronti: ${pronti.length}/${data.partecipanti.length}`,
                color: '#27ae60',
                buttons: [
                    { text: 'üöÄ SONO PRONTO!', onclick: 'setProntoOnline()' },
                    { text: 'üö´ ANNULLA', onclick: 'annullaPartita()' }
                ]
            });
        } else {
            showGameBanner({
                icon: '‚è≥',
                title: `ATTESA GIOCATORI (${pronti.length}/${data.partecipanti.length})`,
                subtitle: 'Sei pronto! Aspettiamo gli altri...',
                color: '#2c3e50',
                buttons: [
                    { text: 'üö´ ANNULLA', onclick: 'annullaPartita()' }
                ],
                spinner: true
            });
        }
        
        // Tutti pronti? Avvia!
        if (pronti.length >= data.partecipanti.length) {
            db.collection("partite").doc(matchId).update({ stato: "in_corso" });
        }
    }

    // ========================================
    // 2. IN CORSO
    // ========================================
    if (data.stato === "in_corso") {
        aggiornaInterfacciaMultiplayer(data);
        const scoreEl = document.getElementById('live-opponent-score');
        if (scoreEl) scoreEl.style.display = 'block';
        
        if (!finito.includes(mioNome)) {
            // === NON HO ANCORA FINITO - GIOCA! ===
            removeGameBanner();
            
            if (!isGameActive && !isAnalysisPhase && !isPaused) {
                gridSize = parseInt(data.opzioni.griglia);
                timeRemaining = parseInt(data.opzioni.tempo);
                initialTime = timeRemaining;
                currentSeed = data.opzioni.seed;
                isBiatchMode = (data.opzioni.mode === 'biatch');
                isCrazyMode = (data.opzioni.mode === 'crazy');
                useBonuses = (data.opzioni.mode !== 'classic');
                generateGridData(currentSeed.split('-')[0]);
                renderGrid();
                document.getElementById('start-screen').style.display = 'none';
                gridOverlay.style.display = 'flex';
                document.querySelectorAll('.tile').forEach(t => t.classList.add('blurred'));
                overlaySeed.textContent = currentSeed;
                timerDisplay.textContent = formatTime(timeRemaining);
                document.getElementById('possible-count').parentElement.style.visibility = 'visible';
                calculatePossibleWordsCount();
            }
        } else {
            // === HO FINITO IL MIO TEMPO ===
            document.getElementById('fixed-home-btn').style.display = 'block';
            
            // Attiva modalit√† esplorazione
            if (!isAnalysisPhase) {
                isAnalysisPhase = true;
                isGameActive = true;
                isSandboxMode = true;
                document.querySelectorAll('.tile').forEach(t => t.classList.remove('blurred'));
                sortControls.style.display = "flex";
                btnMissed.style.display = "block";
                analysisMsg.style.display = "block";
                const rotateBtn = document.getElementById('manual-rotate-btn');
                if (rotateBtn && !isBiatchMode) rotateBtn.style.display = 'block';
            }
            
            if (finito.length < data.partecipanti.length) {
                // Attendo altri
                showGameBanner({
                    icon: '‚è≥',
                    title: `ATTESA COLLEGHI (${finito.length}/${data.partecipanti.length})`,
                    subtitle: 'Esplora la griglia nel frattempo!',
                    color: '#2c3e50',
                    buttons: [
                        { text: 'üëÄ RISULTATI PARZIALI', onclick: 'mostraRisultatiPopup()' }
                    ],
                    spinner: true
                });
            } else {
                // Tutti hanno finito - mostra pulsante VERIFICA
                showGameBanner({
                    icon: '‚úÖ',
                    title: 'TUTTI HANNO FINITO!',
                    subtitle: 'Procedi alla verifica delle parole',
                    color: '#27ae60',
                    buttons: [
                        { text: 'üèÅ VERIFICA PAROLE', onclick: 'avviaVerificaUnificata()' }
                    ]
                });
            }
        }
    }

    // ========================================
    // 3. VERIFICA (semplificata - un solo step)
    // ========================================
    if (data.stato === "verifica") {
        document.getElementById('fixed-home-btn').style.display = 'block';
        
        // Attiva analisi se non gi√† attiva
        if (!isAnalysisPhase) {
            isAnalysisPhase = true;
            isGameActive = true;
            isSandboxMode = true;
            document.querySelectorAll('.tile').forEach(t => t.classList.remove('blurred'));
            sortControls.style.display = "flex";
            btnMissed.style.display = "block";
            const rotateBtn = document.getElementById('manual-rotate-btn');
            if (rotateBtn && !isBiatchMode) rotateBtn.style.display = 'block';
        }
        
        if (!conferma.includes(mioNome)) {
            // Non ho ancora cliccato VERIFICA
            showGameBanner({
                icon: 'üèÅ',
                title: 'VERIFICA PAROLE',
                subtitle: 'Clicca per confermare e calcolare i risultati',
                color: '#27ae60',
                buttons: [
                    { text: '‚úîÔ∏è VERIFICA PAROLE', onclick: 'avviaVerificaUnificata()' }
                ]
            });
        } else {
            // Ho gi√† confermato, attendo altri
            showGameBanner({
                icon: '‚è≥',
                title: `ATTESA VERIFICA (${conferma.length}/${data.partecipanti.length})`,
                subtitle: 'Hai confermato. Attendi gli altri giocatori...',
                color: '#8e44ad',
                buttons: [],
                spinner: true
            });
        }
        
        // Tutti hanno confermato? Calcola e chiudi
        if (conferma.length >= data.partecipanti.length) {
            // Calcola punteggi finali
            let nuoviPunteggi = {};
            data.partecipanti.forEach(player => {
                let pFinal = 0; 
                const mieParole = data.parole[player] || [];
                mieParole.forEach(par => {
                    let comune = false;
                    data.partecipanti.forEach(altro => { 
                        if(player !== altro && (data.parole[altro] || []).some(x => x.w === par.w)) comune = true; 
                    });
                    if(!comune) pFinal += par.p;
                });
                nuoviPunteggi[player] = pFinal;
            });
            db.collection("partite").doc(matchId).update({ 
                punteggi: nuoviPunteggi, 
                stato: "conclusa" 
            });
        }
    }

    // ========================================
    // 4. CONCLUSA
    // ========================================
    if (data.stato === "conclusa") {
        document.getElementById('fixed-home-btn').style.display = 'block';
        
        const btnNewEl = document.querySelector('.btn-new');
        if (btnNewEl) btnNewEl.style.display = 'block';
        
        // Rivincita in arrivo?
        if (data.prossimaPartita) {
            showGameBanner({
                icon: 'üîÑ',
                title: 'RIVINCITA IN ARRIVO!',
                subtitle: 'Reindirizzamento...',
                color: '#e74c3c',
                buttons: [],
                spinner: true
            });
            
            setTimeout(() => { 
                window.location.href = `ruzzle.html?matchId=${data.prossimaPartita}`; 
            }, 2000);
            return;
        }
        
        // Classifica
        let classifica = Object.entries(data.punteggi).sort((a,b) => b[1]-a[1]);
        const haVinto = classifica[0][0] === mioNome;
        let risultatiStr = classifica.map(([p, s]) => `${p}: ${s}`).join(' | ');
        
        showGameBanner({
            icon: haVinto ? 'üëë' : 'üê∑',
            title: haVinto ? 'VITTORIA!' : 'SCONFITTA!',
            subtitle: risultatiStr,
            color: haVinto ? '#f1c40f' : '#7f8c8d',
            buttons: [
                { text: 'üîÑ RIVINCITA', onclick: 'apriRivincitaBanner()', special: true }
            ]
        });
        
        if(haVinto) fireConfettiLight();
        
        // Attiva analisi
        if (!window.analisiGiaAttivata) {
            window.analisiGiaAttivata = true;
            setTimeout(() => attivaAnalisiMultiplayerSilent(), 500);
        }
    }
});

        // ‚úÖ LISTENER PROPOSTE
        unsubscribeProposte = db.collection("partite").doc(matchId).collection("proposte").onSnapshot(snap => {
            snap.docChanges().forEach(async change => {
                if(change.type === "added" || change.type === "modified") {
                    const prop = change.doc.data();
                    
                    if(!prop.voti.includes(mioNome)) {
                        const azione = prop.tipo === 'extra' ? 'AGGIUNGERE' : 'RIMUOVERE';
                        if(confirm(`VOTAZIONE: ${prop.proponente} vuole ${azione} "${prop.parola}". Approvi?`)) {
                            await db.collection("partite").doc(matchId)
                                .collection("proposte").doc(prop.parola)
                                .update({
                                    voti: firebase.firestore.FieldValue.arrayUnion(mioNome)
                                })
                                .catch(e => console.error("Errore voto:", e));
                        }
                    }
                    
                    if(currentGameData && currentGameData.partecipanti) {
                        const numPartecipanti = currentGameData.partecipanti.length;
                        
                        if(prop.voti.length >= numPartecipanti) {
                            await applicaModificaDizionario(prop.parola, prop.tipo);
                            
                            await db.collection("partite").doc(matchId)
                                .collection("proposte").doc(prop.parola)
                                .delete()
                                .catch(e => console.error("Errore delete:", e));
                        }
                    }
                }
            });
        });
        
        loadDictionary();
    }

    function setProntoOnline() { 
        db.collection("partite").doc(matchId).update({ 
            pronti: firebase.firestore.FieldValue.arrayUnion(mioNome),
        }); 
    }
    async function avviaVerificaUnificata() {
        // Aggiungi il giocatore alla lista conferme E cambia stato se necessario
        const docRef = db.collection("partite").doc(matchId);
        
        await docRef.update({ 
            confermaVerifica: firebase.firestore.FieldValue.arrayUnion(mioNome)
        });
        
        // Leggi i dati aggiornati
        const snap = await docRef.get();
        const data = snap.data();
        
        // Se lo stato √® ancora "in_corso", cambialo a "verifica"
        if (data.stato === "in_corso") {
            await docRef.update({ stato: "verifica" });
        }
        
        // Il calcolo finale avviene automaticamente nel listener quando tutti hanno confermato
    }
    async function attivaAnalisiMultiplayer() {
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = '<div style="text-align:center; padding:20px;">‚è≥ Caricamento analisi...</div>';
        document.getElementById('found-words').appendChild(loadingDiv);
        
        const snap = await db.collection("partite").doc(matchId).get();
        const data = snap.data();
        loadingDiv.remove();
        document.getElementById('multiplayer-lobby').style.display = 'none';
        document.getElementById('proposta-manuale-container').style.display = 'block';
        isAnalysisPhase = true;
        isGameActive = true; 
        
        if(document.getElementById('analysis-msg')) document.getElementById('analysis-msg').style.display = "block";
        if(document.getElementById('btn-missed')) document.getElementById('btn-missed').style.display = "block";
        
        let conteggioParoleGlobali = {};
        data.partecipanti.forEach(p => {
            (data.parole[p] || []).forEach(par => {
                conteggioParoleGlobali[par.w] = (conteggioParoleGlobali[par.w] || 0) + 1;
            });
        });

        const wordsListEl = document.getElementById('found-words');
        wordsListEl.innerHTML = "";

        if(!document.getElementById('sel-analisi')) {
            const headerDiv = document.createElement('div');
            headerDiv.style = "background:#2c3e50; padding:10px; border-radius:5px; margin-bottom:10px;";
            headerDiv.innerHTML = `<label style="font-size:0.7rem; font-weight:bold; display:block; margin-bottom:5px;">MOSTRA PAROLE DI:</label>
                                   <select id="sel-analisi" style="width:100%; background:#1e1e1e; color:white; border:1px solid #444; padding:5px;"></select>`;
            wordsListEl.parentNode.insertBefore(headerDiv, wordsListEl);
            
            const sel = document.getElementById('sel-analisi');
            data.partecipanti.forEach(p => {
                const o = document.createElement('option'); o.value = p; o.textContent = p + (p === mioNome ? " (TU)" : "");
                sel.appendChild(o);
            });
            sel.onchange = (e) => renderizzaAnalisiPlayer(e.target.value);
        }

        const renderizzaAnalisiPlayer = (nomePlayer) => {
            wordsListEl.innerHTML = "";
            const parole = (data.parole[nomePlayer] || []).sort((a,b) => a.w.localeCompare(b.w));
            
            parole.forEach(item => {
                foundWords.set(item.w, { points: item.p, path: item.path });
                const isDuplicata = conteggioParoleGlobali[item.w] > 1;
                const li = document.createElement('li');
                if(isDuplicata) { li.style.textDecoration = "line-through"; li.style.opacity = "0.5"; }

                li.innerHTML = `
                    <div class="word-item-left">
                        <button class="btn-eye" onclick="showWordOnGrid('${item.w}')">üëÅÔ∏è</button>
                        <span>${item.w}</span>
                        <button onclick="inviaPropostaFirebase('${item.w}', 'exclude')" style="background:none; border:none; cursor:pointer;" title="Proponi Rimozione">üì¢</button>
                    </div>
                    <span class="pts">${isDuplicata ? 0 : item.p}</span>`;
                wordsListEl.appendChild(li);
            });
        };

        renderizzaAnalisiPlayer(mioNome);

        const btnTornaLobby = document.createElement('button');
        btnTornaLobby.textContent = "‚¨ÖÔ∏è TORNA ALLA LOBBY / RIVINCITA";
        btnTornaLobby.className = 'btn-action';
        btnTornaLobby.style.marginTop = '15px';
        btnTornaLobby.onclick = () => {
            document.getElementById('multiplayer-lobby').style.display = 'flex';
            document.getElementById('proposta-manuale-container').style.display = 'none';
        };
        wordsListEl.parentNode.appendChild(btnTornaLobby);
    }

    function proponiParolaManuale() {
        const parola = document.getElementById('input-nuova-parola').value
            .trim()
            .toUpperCase()
            .replace(/[^A-Z]/g, '');
        
        if (parola.length < 4) return alert("Minimo 4 lettere!");
        if (parola.length > 20) return alert("Troppo lunga!");
        
        inviaPropostaFirebase(parola, 'extra');
    }

    async function inviaPropostaFirebase(parola, tipo) {
        const azione = (tipo === 'extra') ? "AGGIUNGERE alle EXTRA" : "ELIMINARE (EXCLUDED)";
        if(!confirm(`Vuoi proporre al gruppo di ${azione} la parola: ${parola}?`)) return;

        await db.collection("partite").doc(matchId).collection("proposte").doc(parola).set({
            parola: parola,
            tipo: tipo,
            proponente: mioNome,
            voti: [mioNome]
        });
        alert("Proposta inviata! Gli altri devono approvare.");
    }

    async function applicaModificaDizionario(parola, tipo) {
        if(tipo === 'extra') {
            if(!EXTRA_WORDS.includes(parola)) EXTRA_WORDS.push(parola);
            dictionary.add(parola);
        } else {
            if(!EXCLUDED_WORDS.includes(parola)) EXCLUDED_WORDS.push(parola);
            dictionary.delete(parola);
        }
        
        buildTrie();

        if (matchId) {
            await db.collection("partite").doc(matchId).update({
                [`dizionarioCustom.extra`]: firebase.firestore.FieldValue.arrayUnion(tipo === 'extra' ? parola : null),
                [`dizionarioCustom.excluded`]: firebase.firestore.FieldValue.arrayUnion(tipo === 'exclude' ? parola : null)
            });
        }
        
        const globalRef = db.collection("config").doc("dizionario");
        if (tipo === 'extra') {
            await globalRef.set({
                extra: firebase.firestore.FieldValue.arrayUnion(parola)
            }, { merge: true });
        } else {
            await globalRef.set({
                excluded: firebase.firestore.FieldValue.arrayUnion(parola)
            }, { merge: true });
        }
        
        alert(`${tipo === 'extra' ? '‚úÖ Aggiunta' : 'üö´ Rimossa'} PERMANENTEMENTE: "${parola}"`);
    }

    // ‚úÖ CLEANUP FIREBASE
    function cleanupFirebaseListeners() {
        if(unsubscribePartita) { unsubscribePartita(); unsubscribePartita = null; }
        if(unsubscribeProposte) { unsubscribeProposte(); unsubscribeProposte = null; }
    }

    window.addEventListener('beforeunload', cleanupFirebaseListeners);
    window.addEventListener('pagehide', cleanupFirebaseListeners);

    function tornaHome() {
        cleanupAllListeners();
        cleanupFirebaseListeners();
        window.location.href = 'index.html';
    }

function apriRivincitaBanner() {
    if (!matchId) {
        startNewGame();
        return;
    }
    
    // Crea banner con selettori
    removeGameBanner();
    
    const banner = document.createElement('div');
    banner.id = 'game-banner';
    banner.className = 'game-banner';
    banner.style.background = 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)';
    banner.style.flexWrap = 'wrap';
    banner.style.gap = '10px';
    banner.style.padding = '15px 20px';
    
    banner.innerHTML = `
        <div class="banner-left">
            <span style="font-size:1.5rem;">üéÆ</span>
            <div>
                <div style="font-weight:bold;">RIVINCITA</div>
                <div style="font-size:0.8rem; opacity:0.9;">Configura e scegli modalit√†</div>
            </div>
        </div>
        <div class="banner-right" style="flex-wrap:wrap; gap:8px;">
            <select id="rivincita-tempo" style="padding:6px; border-radius:4px; border:none; font-size:0.85rem;">
                <option value="45">45s</option>
                <option value="60">60s</option>
                <option value="90">90s</option>
                <option value="180" selected>180s</option>
                <option value="300">300s</option>
            </select>
            <select id="rivincita-griglia" style="padding:6px; border-radius:4px; border:none; font-size:0.85rem;">
                <option value="4">4x4</option>
                <option value="5" selected>5x5</option>
                <option value="6">6x6</option>
                <option value="7">7x7</option>
                <option value="10">10x10</option>
            </select>
            <button onclick="creaRivincitaConSelettori(false, false, false)" style="padding:6px 12px; border:none; border-radius:4px; background:white; color:#333; cursor:pointer; font-weight:bold;">CLASSICA</button>
            <button onclick="creaRivincitaConSelettori(true, false, false)" style="padding:6px 12px; border:none; border-radius:4px; background:#f1c40f; color:#333; cursor:pointer; font-weight:bold;">BONUS ‚≠ê</button>
            <button onclick="creaRivincitaConSelettori(true, true, false)" style="padding:6px 12px; border:none; border-radius:4px; background:#e74c3c; color:white; cursor:pointer; font-weight:bold;">CRAZY ü§™</button>
            <button onclick="creaRivincitaConSelettori(true, true, true)" style="padding:6px 12px; border:none; border-radius:4px; background:#ff00ff; color:white; cursor:pointer; font-weight:bold;">BIATCH üíÖ</button>
        </div>
    `;
    
    document.body.appendChild(banner);
}

async function creaRivincitaConSelettori(bonus, crazy, biatch) {
    const tempo = document.getElementById('rivincita-tempo').value;
    const griglia = document.getElementById('rivincita-griglia').value;
    
    showGameBanner({
        icon: '‚è≥',
        title: 'CREAZIONE RIVINCITA...',
        subtitle: 'Attendi un momento',
        color: '#3498db',
        buttons: [],
        spinner: true
    });
    
    try {
        const snap = await db.collection("partite").doc(matchId).get();
        const v = snap.data();
        let mode = crazy ? 'crazy' : (biatch ? 'biatch' : (bonus ? 'bonus' : 'classic'));
        
        let pts = {}; 
        let words = {}; 
        v.partecipanti.forEach(p => { pts[p]=0; words[p]=[]; });
        
        const doc = await db.collection("partite").add({
            gioco: 'ruzzle',
            partecipanti: v.partecipanti,
            opzioni: {
                tempo: tempo,
                griglia: griglia,
                mode: mode,
                seed: Math.random().toString(36).substring(7).toUpperCase()
            },
            punteggi: pts, 
            parole: words, 
            pronti: [], 
            finito: [], 
            confermaVerifica: [], 
            stato: "attesa", 
            timestamp: Date.now(), 
            dataOra: new Date().toLocaleString('it-IT')
        });
        
        await db.collection("partite").doc(matchId).update({ prossimaPartita: doc.id });
        
    } catch(e) {
        console.error("Errore creazione rivincita:", e);
        showGameBanner({
            icon: '‚ùå',
            title: 'ERRORE',
            subtitle: 'Impossibile creare rivincita',
            color: '#e74c3c',
            buttons: [
                { text: 'üîÑ RIPROVA', onclick: 'apriRivincitaBanner()' }
            ]
        });
    }
}

    async function attivaAnalisiMultiplayerSilent() {
        const snap = await db.collection("partite").doc(matchId).get();
        const data = snap.data();
        
        document.getElementById('proposta-manuale-container').style.display = 'block';
        isAnalysisPhase = true;
        isGameActive = true; 
        
        if(document.getElementById('analysis-msg')) document.getElementById('analysis-msg').style.display = "block";
        if(document.getElementById('btn-missed')) document.getElementById('btn-missed').style.display = "block";
        
        let conteggioParoleGlobali = {};
        data.partecipanti.forEach(p => {
            (data.parole[p] || []).forEach(par => {
                conteggioParoleGlobali[par.w] = (conteggioParoleGlobali[par.w] || 0) + 1;
            });
        });

        const wordsListEl = document.getElementById('found-words');
        wordsListEl.innerHTML = "";

        if(!document.getElementById('sel-analisi')) {
            const headerDiv = document.createElement('div');
            headerDiv.style = "background:#2c3e50; padding:10px; border-radius:5px; margin-bottom:10px;";
            headerDiv.innerHTML = `<label style="font-size:0.7rem; font-weight:bold; display:block; margin-bottom:5px;">MOSTRA PAROLE DI:</label>
                                   <select id="sel-analisi" style="width:100%; background:#1e1e1e; color:white; border:1px solid #444; padding:5px;"></select>`;
            wordsListEl.parentNode.insertBefore(headerDiv, wordsListEl);
            
            const sel = document.getElementById('sel-analisi');
            data.partecipanti.forEach(p => {
                const o = document.createElement('option'); 
                o.value = p; 
                o.textContent = p + (p === mioNome ? " (TU)" : "");
                sel.appendChild(o);
            });
            sel.onchange = (e) => renderizzaAnalisiPlayerSilent(e.target.value, data, conteggioParoleGlobali);
        }

        renderizzaAnalisiPlayerSilent(mioNome, data, conteggioParoleGlobali);
    }

    function renderizzaAnalisiPlayerSilent(nomePlayer, data, conteggioParoleGlobali) {
        const wordsListEl = document.getElementById('found-words');
        wordsListEl.innerHTML = "";
        
        const parole = (data.parole[nomePlayer] || []).sort((a,b) => a.w.localeCompare(b.w));
        
        parole.forEach(item => {
            foundWords.set(item.w, { points: item.p, path: item.path });
            const isDuplicata = conteggioParoleGlobali[item.w] > 1;
            const li = document.createElement('li');
            if(isDuplicata) { 
                li.style.textDecoration = "line-through"; 
                li.style.opacity = "0.5"; 
            }

            li.innerHTML = `
                <div class="word-item-left">
                    <button class="btn-eye" onclick="showWordOnGrid('${item.w}')">üëÅÔ∏è</button>
                    <span>${item.w}</span>
                    <button onclick="inviaPropostaFirebase('${item.w}', 'exclude')" style="background:none; border:none; cursor:pointer;" title="Proponi Rimozione">üì¢</button>
                </div>
                <span class="pts">${isDuplicata ? 0 : item.p}</span>`;
            wordsListEl.appendChild(li);
        });
    }

    function apriModalRivincita() {
        document.getElementById('multiplayer-lobby').style.display = 'none';
        apriRivincitaBanner();
    }

    function mostraLobbyTemporanea() {
        const lobby = document.getElementById('multiplayer-lobby');
        lobby.style.display = 'flex';
        
        const actionDiv = document.getElementById('lobby-action');
        
        if (!document.getElementById('btn-torna-griglia')) {
            const btnTorna = document.createElement('button');
            btnTorna.id = 'btn-torna-griglia';
            btnTorna.innerHTML = 'üéÆ TORNA ALLA GRIGLIA';
            btnTorna.className = 'btn-action';
            btnTorna.style.width = 'auto';
            btnTorna.style.padding = '12px 30px';
            btnTorna.style.marginTop = '15px';
            btnTorna.onmouseover = () => btnTorna.style.transform = 'scale(1.05)';
            btnTorna.onmouseout = () => btnTorna.style.transform = 'scale(1)';
            btnTorna.onclick = () => {
                lobby.style.display = 'none';
            };
            actionDiv.appendChild(btnTorna);
        }
    }

    function setupHomeButtonCleanup() {
        document.addEventListener('click', (e) => {
            const target = e.target.closest('a, button');
            if (!target) return;
            
            const href = target.getAttribute('href') || '';
            const onclick = target.getAttribute('onclick') || '';
            
            if (href.includes('index.html') || onclick.includes('index.html')) {
                e.preventDefault();
                e.stopPropagation();
                cleanupFirebaseListeners();
                cleanupAllListeners();
                window.location.href = 'index.html';
            }
        }, true);
    }

    async function annullaPartita() {
        if (!confirm("Sicuro di voler CANCELLARE la partita per tutti?")) return;
        
        try {
            await db.collection("partite").doc(matchId).delete();
            alert("Partita cancellata per tutti!");
            window.location.href = "index.html";
        } catch (e) {
            console.error("Errore cancellazione:", e);
            alert("Errore durante la cancellazione");
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupHomeButtonCleanup);
    } else {
        setupHomeButtonCleanup();
    }
</script>

<!-- PULSANTE HOME FISSO -->
<div id="fixed-home-btn">
    <button onclick="tornaHome()">üè† HOME</button>
</div>
</body>
</html>

