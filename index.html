<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Portale giochi Fun at Work">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üê∑</text></svg>">
    
    <!-- ‚úÖ PRECONNECT per velocit√† -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://firestore.googleapis.com">
    
    <title>Portale FaW</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
<style>
/* ‚úÖ RESET E BASE */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html {
    scroll-behavior: smooth;
}

body { 
    font-family: 'Segoe UI', sans-serif; 
    background: #121212; 
    color: #eee; 
    padding: 20px; 
    margin: 0;
    min-height: 100vh;
}

.container { max-width: 800px; margin: auto; }

.box { 
    background: #1e1e1e; 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 20px; 
    border: 1px solid #333; 
}

h1, h3 { color: #03dac6; margin-top: 0; }

/* ========================================
   üéÆ PULSANTI - STILE RUZZLE (Semplici e Leggeri)
   ======================================== */
button {
    padding: 10px 20px;
    border-radius: 6px;
    border: 1px solid #555;
    background: #1e1e1e;
    color: #eee;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: background 0.15s ease, transform 0.1s ease;
}

button:hover {
    background: #2d2d2d;
}

button:active {
    transform: scale(0.97);
}

/* Pulsante primario (verde acqua) */
.btn-primary {
    background: #03dac6 !important;
    color: #000 !important;
    border-color: #018786 !important;
    font-weight: bold;
}

.btn-primary:hover {
    background: #00c4b0 !important;
}

/* Pulsante pericolo (rosso) */
.btn-danger {
    background: #cf6679 !important;
    color: white !important;
    border-color: #b00020 !important;
}

/* Pulsante secondario (grigio) */
.btn-secondary {
    background: #444 !important;
    color: #eee !important;
}

/* ========================================
   üìù INPUT E SELECT
   ======================================== */
input, select { 
    width: 100%; 
    padding: 12px; 
    margin: 10px 0; 
    background: #2c2c2c; 
    color: white; 
    border: 1px solid #444; 
    border-radius: 6px;
    font-size: 1rem;
}

input:focus, select:focus {
    outline: none;
    border-color: #03dac6;
}

/* ========================================
   üë§ LISTA UTENTI/AMICI
   ======================================== */
.user-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #252525; 
    padding: 12px; 
    margin: 8px 0; 
    border-radius: 8px; 
    cursor: pointer; 
    border: 1px solid transparent;
    transition: all 0.2s;
}

.user-item:hover { 
    border-color: #444;
    background: #2a2a2a;
}

.user-item.selected { 
    background: #03dac6 !important; 
    color: #000; 
    border-color: white; 
}

/* Pulsante sfida multipla */
.btn-sfida-multi { 
    background: #f1c40f !important; 
    color: #000 !important; 
    border: none !important;
    width: 100%; 
    height: 50px; 
    font-size: 1.1rem; 
    margin-bottom: 15px; 
    display: none;
    font-weight: bold;
}

/* Pulsante elimina piccolo */
.btn-del { 
    background: #cf6679 !important; 
    color: white !important; 
    padding: 5px 10px; 
    font-size: 0.8rem;
    border: none !important;
}

/* ========================================
   üéÆ PARTITE LIVE E STORICO
   ======================================== */
.live-match { 
    border-left: 5px solid #f1c40f; 
}

.history-item { 
    font-size: 0.85rem; 
    border-bottom: 1px solid #333; 
    padding: 8px 0; 
    display: flex; 
    justify-content: space-between; 
}

/* ========================================
   üë§ USER DISPLAY
   ======================================== */
#user-display { 
    background: #03dac6; 
    color: #000; 
    padding: 5px 15px; 
    border-radius: 20px; 
    display: inline-block; 
    font-weight: bold; 
}

/* ========================================
   üéÆ GAME CARDS
   ======================================== */
.game-card { 
    min-width: 100px; 
    padding: 15px; 
    background: #252525; 
    border-radius: 10px; 
    text-align: center; 
    cursor: pointer; 
    border: 2px solid transparent; 
    transition: 0.3s;
}

.game-card:hover {
    border-color: #444;
}

.game-card.selected { 
    border-color: #03dac6; 
    background: #1a3a3a; 
}

/* ========================================
   üéØ MODAL
   ======================================== */
.modal { 
    display: none;
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.9); 
    z-index: 10000; 
    justify-content: center; 
    align-items: center; 
}

.modal-content { 
    background: #1e1e1e; 
    padding: 30px; 
    border-radius: 15px; 
    width: 90%; 
    max-width: 450px; 
    border: 2px solid #333; 
}

.modal-content h2 {
    color: #03dac6;
    margin-top: 0;
    text-align: center;
}

/* ========================================
   üéÆ PULSANTI MODALIT√Ä GIOCO (Come Ruzzle)
   ======================================== */
.mode-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 15px;
}

.btn-mode {
    flex: 1;
    min-width: 80px;
    padding: 12px 15px;
    border: 1px solid #555;
    border-radius: 6px;
    background: #1e1e1e;
    color: #eee;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.15s ease;
}

.btn-mode:hover {
    background: #2d2d2d;
    border-color: #777;
}

.btn-mode:active {
    transform: scale(0.97);
}

/* Annulla nel modal */
.btn-cancel {
    background: none !important;
    border: none !important;
    color: #777 !important;
    margin-top: 15px;
    font-size: 0.9rem;
}

.btn-cancel:hover {
    color: #aaa !important;
}

/* ========================================
   üìä STATISTICHE HOMEPAGE
   ======================================== */
.stats-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    border-bottom: 2px solid #333;
    padding-bottom: 10px;
}

.stats-tab {
    flex: 1;
    padding: 8px 12px;
    background: #2c2c2c;
    border: 1px solid #444;
    border-radius: 6px 6px 0 0;
    color: #888;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

.stats-tab.active {
    background: #03dac6;
    color: #000;
    border-color: #03dac6;
}

.stats-tab:hover:not(.active) {
    background: #3c3c3c;
    color: #fff;
}

.stats-grid-home {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

@media (min-width: 500px) {
    .stats-grid-home {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-box {
    background: #252525;
    padding: 15px 10px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid #333;
    transition: transform 0.2s;
}

.stat-box:hover {
    transform: scale(1.03);
}

.stat-box.highlight {
    background: linear-gradient(135deg, #1a3a3a 0%, #0d2626 100%);
    border-color: #03dac6;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 900;
    color: #03dac6;
    line-height: 1.2;
}

.stat-desc {
    font-size: 0.75rem;
    color: #888;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Grafico settimanale */
.weekly-bars {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    height: 100px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 8px;
    gap: 5px;
}

.day-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.day-bar .bar {
    width: 100%;
    max-width: 30px;
    background: linear-gradient(to top, #03dac6, #018786);
    border-radius: 4px 4px 0 0;
    min-height: 5px;
    transition: height 0.5s ease;
}

.day-bar .bar.today {
    background: linear-gradient(to top, #f1c40f, #e67e22);
    box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
}

.day-bar .label {
    font-size: 0.65rem;
    color: #666;
    text-transform: uppercase;
}

.day-bar .count {
    font-size: 0.7rem;
    color: #03dac6;
    font-weight: bold;
}

/* ========================================
   üì± RESPONSIVE
   ======================================== */
@media (max-width: 400px) {
    .mode-buttons {
        flex-direction: column;
    }
    
    .btn-mode {
        width: 100%;
    }
}
</style>
</head>
<body>

<div class="container">
    
    <!-- LOGIN -->
    <div id="login-div" class="box">
        <h1>Login dei üê∑</h1>
        <input type="text" id="username" placeholder="IL TUO NOME">
        <input type="password" id="password" placeholder="PASSWORD">
        <button onclick="entra()" class="btn-primary" style="width:100%; height:50px; font-size:1rem;">ENTRA / REGISTRATI</button>
    </div>

    <!-- DASHBOARD -->
    <div id="main-app" style="display:none;">
<div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
    <div id="user-display"></div>
    <button id="btn-disponibilita" onclick="toggleDisponibilita()" style="padding:8px 15px; border-radius:20px; border:none; cursor:pointer; font-weight:bold; font-size:0.85rem;"></button>
</div>
        <div class="box">
            <h3>üéÆ Partite In Corso</h3>
            <div id="lista-partite"></div>
        </div>
        <div class="box">
            <h3>üéÆ Scegli il Gioco</h3>
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                <div class="game-card selected" onclick="selezionaGioco('ruzzle', this)" id="game-ruzzle">
                    <span style="font-size:2rem;">üî†</span><br>Ruzzle
                </div>
                <div class="game-card" style="opacity:0.3; cursor:not-allowed; pointer-events:none;">
                    <span style="font-size:2rem;">‚ùå</span><br>Prossimamente
                </div>
                <!-- Aggiungerai qui i futuri giochi -->
            </div>
        </div>
        <div class="box">
            <h3>‚≠ê I tuoi Amici</h3>
            <p style="font-size:0.8rem; opacity:0.6;">Clicca sui nomi per selezionare pi√π amici e sfidarli insieme!</p>
            <button id="btn-sfida-multipla" class="btn-sfida-multi" onclick="apriModalSfida()">SFIDA IL GRUPPO ‚öîÔ∏è</button>
            <div id="lista-amici"></div>
        </div>

        <div class="box">
            <h3>üåç Altri Colleghi Online</h3>
            <div id="lista-global"></div>
        </div>

<!-- BOX STATISTICHE GIORNALIERE -->
<div class="box">
    <h3>üìä Le Tue Statistiche</h3>
    
    <!-- Tab per cambiare vista -->
    <div class="stats-tabs">
        <button class="stats-tab active" onclick="showStatsTab('oggi')">Oggi</button>
        <button class="stats-tab" onclick="showStatsTab('settimana')">Settimana</button>
        <button class="stats-tab" onclick="showStatsTab('sempre')">Sempre</button>
    </div>
    
    <!-- Contenuto statistiche -->
    <div id="stats-content">
        <div class="stats-grid-home">
            <div class="stat-box">
                <div class="stat-number" id="stat-oggi-totale">0</div>
                <div class="stat-desc">Partite Oggi</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-oggi-ruzzle">0</div>
                <div class="stat-desc">üé≤ Ruzzle</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-media">0</div>
                <div class="stat-desc">Media/Giorno</div>
            </div>
            <div class="stat-box highlight">
                <div class="stat-number" id="stat-top-day">-</div>
                <div class="stat-desc">üèÜ Giorno Top</div>
            </div>
        </div>
        
        <!-- Dettaglio ultimi 7 giorni -->
        <div id="stats-weekly-chart" style="margin-top:15px; display:none;">
            <div class="weekly-bars" id="weekly-bars"></div>
        </div>
        
        <!-- Statistiche totali -->
        <div id="stats-sempre" style="display:none;">
            <div class="stats-grid-home">
                <div class="stat-box">
                    <div class="stat-number" id="stat-totale-partite">0</div>
                    <div class="stat-desc">Partite Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-giorni-attivi">0</div>
                    <div class="stat-desc">Giorni Attivi</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-streak">0</div>
                    <div class="stat-desc">üî• Streak Attuale</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-best-streak">0</div>
                    <div class="stat-desc">‚ö° Best Streak</div>
                </div>
            </div>
        </div>
		  <div style="margin-top:20px; text-align:center; border-top:1px solid #333; padding-top:15px;">
			<button onclick="resetTutteLeStatistiche()" class="btn-danger" style="font-size:0.8rem; opacity:0.7;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">
			    üóëÔ∏è Azzera Statistiche
			</button>
        </div>
    </div>
</div>

        <div class="box">
            <h3>üìú Storico Partite</h3>
            <div id="lista-storico"></div>
        </div>
        
        <button onclick="logout()" class="btn-secondary" style="width:100%; margin-top:20px;">ESCI (LOGOUT)</button>
    </div>
</div>

<!-- MODALE OPZIONI SFIDA -->
<div id="modal-sfida-ruzzle" class="modal">
    <div class="modal-content">
        <h2 id="target-name">‚öîÔ∏è Nuova Sfida</h2>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size:0.9rem; color:#888;">Durata:</label>
            <select id="opt-tempo">
                <option value="45">45s (Fulmine)</option>
                <option value="60" selected>60s (Blitz)</option>
                <option value="90">90s</option>
                <option value="180">180s (Standard)</option>
                <option value="300">300s (Relax)</option>
            </select>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size:0.9rem; color:#888;">Dimensione Griglia:</label>
            <select id="opt-griglia">
                <option value="4">4x4 (Easy)</option>
                <option value="5" selected>5x5 (Classica)</option>
                <option value="6">6x6 (Intermedia)</option>
                <option value="7">7x7 (Grande)</option>
                <option value="10">10x10 (Estrema!)</option>
            </select>
        </div>
        
        <p style="margin-bottom:10px; color:#888; font-size:0.9rem;">Scegli la modalit√†:</p>
        
        <div class="mode-buttons">
            <button class="btn-mode" onclick="creaPartitaMultipla(false, false, false)">CLASSICA</button>
            <button class="btn-mode" onclick="creaPartitaMultipla(true, false, false)">BONUS ‚≠ê</button>
            <button class="btn-mode" onclick="creaPartitaMultipla(true, true, false)">CRAZY ü§™</button>
            <button class="btn-mode" onclick="creaPartitaMultipla(true, true, true)">BIATCH üíÖ</button>
        </div>
        
        <button class="btn-cancel" onclick="closeModal()">Annulla</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
	let mioNome = localStorage.getItem('mioNome') || "";
	let passwordHashSalvato = localStorage.getItem('passwordHash') || "";
    let amiciSelezionati = new Set();
    let giocoSelezionato = "ruzzle";

if(mioNome && passwordHashSalvato) {
    window.onload = async () => {
        try {
            const userRef = db.collection("utenti").doc(mioNome);
            const doc = await userRef.get();
            
            if (doc.exists && doc.data().passwordHash === passwordHashSalvato) {
                document.getElementById('login-div').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('user-display').textContent = "üë§ " + mioNome;
                aggiornaUIDisponibilita();
                aggiornaPresenza();
                setInterval(aggiornaPresenza, 20000);
                listen();
                caricaStorico();
            } else {
                // Hash non valido, richiedi login
                localStorage.removeItem('passwordHash');
                document.getElementById('login-div').style.display = 'block';
            }
        } catch (e) {
            console.error("Errore auto-login:", e);
            // Mostra schermata login in caso di errore
            document.getElementById('login-div').style.display = 'block';
            localStorage.removeItem('passwordHash');
        }
    };
}

// Funzione per creare hash SHA-256 (sicuro lato client)
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function entra(isAuto = false) {
    const n = document.getElementById('username').value.trim().toUpperCase();
    const p = document.getElementById('password').value.trim();
    
    if(n.length < 2 || p.length < 3) {
        if (!isAuto) alert("Nome minimo 2 caratteri, password minimo 3");
        return;
    }

    // ‚úÖ LOADING STATE
    const btn = document.querySelector('#login-div button');
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ Caricamento...';
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    try {
        const passwordHash = await hashPassword(p);
        const userRef = db.collection("utenti").doc(n);
        const doc = await userRef.get();
        
        if(doc.exists) {
            if(doc.data().passwordHash !== passwordHash) { 
                if(!isAuto) alert("Password Errata!"); 
                return; 
            }
        } else {
            if(confirm("Nuovo utente? Registrati con questa password.")) {
                await userRef.set({ nome: n, passwordHash: passwordHash });
            } else return;
        }

        mioNome = n;
        localStorage.setItem('mioNome', n);
        localStorage.setItem('passwordHash', passwordHash);
        
        document.getElementById('login-div').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-display').textContent = "üë§ " + mioNome;
        aggiornaUIDisponibilita();
        aggiornaPresenza(); 
        setInterval(aggiornaPresenza, 20000);
        listen();
        caricaStorico();
        
    } catch (e) {
        console.error("Errore login:", e);
        alert("‚ùå Errore di connessione. Controlla internet e riprova.");
    } finally {
        // ‚úÖ Ripristina pulsante (anche in caso di errore)
        btn.textContent = originalText;
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
    }
}

		async function aggiornaPresenza() { 
			 // Controlla se sono in una partita attiva
			 let inPartita = false;
			 let partitaId = null;
			 
			 try {
				  const snap = await db.collection("partite")
						.where("partecipanti", "array-contains", mioNome)
						.where("stato", "in", ["attesa", "in_corso"])
						.get();
				  
				  if (!snap.empty) {
						inPartita = true;
						partitaId = snap.docs[0].id;
				  }
			 } catch(e) {}
			 
			 db.collection("presenze").doc(mioNome).set({ 
				  nome: mioNome, 
				  last: Date.now(),
				  inPartita: inPartita,
				  partitaId: partitaId,
				  disponibile: localStorage.getItem('disponibile') !== 'false' // Default: disponibile
			 }); 
		}

function listen() {
    // ‚úÖ VARIABILE CONDIVISA tra i due listener
    let presenzeData = {};
    let amicizieSnapshot = null;

    // LISTENER 1: Presenze (si aggiorna ogni 20 secondi quando aggiorni presenza)
    db.collection("presenze").onSnapshot(presSnap => {
        // Aggiorna cache presenze
        presenzeData = {};
        presSnap.forEach(doc => {
            const u = doc.data();
            if (u.last > Date.now() - 60000) {
                presenzeData[u.nome] = u;
            }
        });
        
        // Se abbiamo gi√† i dati amicizie, aggiorna la vista
        if (amicizieSnapshot) {
            aggiornaListaAmici(amicizieSnapshot, presenzeData);
        }
        
        // Aggiorna lista globale
        aggiornaListaGlobale(presenzeData);
    });

    // LISTENER 2: Amicizie (si aggiorna solo quando aggiungi/rimuovi amici)
    db.collection("amicizie").onSnapshot(snap => {
        amicizieSnapshot = snap;
        aggiornaListaAmici(snap, presenzeData);
    });

    // LISTENER 3: Partite (invariato)
    db.collection("partite")
        .where("partecipanti", "array-contains", mioNome)
        .onSnapshot(snap => {
            const div = document.getElementById('lista-partite'); 
            div.innerHTML = `<div class="user-item" style="background:#34495e;" onclick="window.location.href='ruzzle.html'"><span>üéØ Allenamento Solo</span><button>GIOCA</button></div>`;
            
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                
                if(p.stato === "attesa" && p.partecipanti[0] !== mioNome) {
                    div.innerHTML += `<div class="user-item" style="background:#f1c40f; color:black;">
                        <span>‚öîÔ∏è SFIDA DA ${p.partecipanti[0]}</span>
                        <button onclick="window.location.href='${p.gioco}.html?matchId=${doc.id}'">ACCETTA</button>
                    </div>`;
                } else {
                    const altri = p.partecipanti.filter(n => n !== mioNome).join(", ");
                    div.innerHTML += `<div class="user-item live-match">
                        <span>vs ${altri} (${p.gioco})</span>
                        <div>
                            <button onclick="window.location.href='${p.gioco}.html?matchId=${doc.id}'" style="background:#03dac6; color:#000;">ENTRA</button>
                            <button onclick="if(confirm('Eliminare?')) db.collection('partite').doc('${doc.id}').delete()" style="background:#cf6679; margin-left:5px;">üóëÔ∏è</button>
                        </div>
                    </div>`;
                }
            });
        });
}
// FUNZIONE 1: Aggiorna lista amici
function aggiornaListaAmici(amicizieSnap, presenzeData) {
    const div = document.getElementById('lista-amici');
    div.innerHTML = "";
    const amiciSet = new Set();

    amicizieSnap.forEach(doc => {
        const d = doc.data();
        
        // Richieste pendenti
        if (d.a === mioNome && d.stato === 'pendente') {
            div.innerHTML += `<div class="user-item" style="background:#3700b3; color:white;">
                <span>ü§ù Richiesta da: ${d.da}</span>
                <button onclick="db.collection('amicizie').doc('${doc.id}').update({stato:'amici'})">ACCETTA</button>
            </div>`;
            return;
        }
        
        // Lista amici
        const nomeAmico = (d.da === mioNome) ? d.a : (d.a === mioNome ? d.da : null);
        if (!nomeAmico || d.stato !== 'amici') return;
        
        amiciSet.add(nomeAmico);
        
        const presenza = presenzeData[nomeAmico] || {};
        const isOnline = !!presenza.nome;
        const inPartita = presenza.inPartita || false;
        const disponibile = presenza.disponibile !== false;
        
        let statoIcon, statoColor, statoText;
        if (!isOnline) {
            statoIcon = '‚ö´'; statoColor = '#555'; statoText = 'Offline';
        } else if (!disponibile) {
            statoIcon = 'üî¥'; statoColor = '#e74c3c'; statoText = 'Non disponibile';
        } else if (inPartita) {
            statoIcon = 'üéÆ'; statoColor = '#f39c12'; statoText = 'In partita';
        } else {
            statoIcon = 'üü¢'; statoColor = '#2ecc71'; statoText = 'Disponibile';
        }

        const isSel = amiciSelezionati.has(nomeAmico);

        div.innerHTML += `
            <div class="user-item ${isSel ? 'selected' : ''}" 
                 onclick="toggleAmico('${nomeAmico}', this)" 
                 style="opacity: ${disponibile && isOnline ? 1 : 0.6};">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.2rem;">${statoIcon}</span>
                    <div>
                        <span style="font-weight:bold;">${nomeAmico}</span>
                        <div style="font-size:0.7rem; color:${statoColor};">${statoText}</div>
                    </div>
                </div>
                <button class="btn-del" onclick="event.stopPropagation(); if(confirm('Rimuovere?')) db.collection('amicizie').doc('${doc.id}').delete()">X</button>
            </div>`;
    });

    // Salva per uso in aggiornaListaGlobale
    window.amiciSetGlobal = amiciSet;
}

// FUNZIONE 2: Aggiorna lista globale
function aggiornaListaGlobale(presenzeData) {
    const div = document.getElementById('lista-global');
    div.innerHTML = "";
    const amiciSet = window.amiciSetGlobal || new Set();

    Object.values(presenzeData).forEach(u => {
        if (u.nome !== mioNome && !amiciSet.has(u.nome) && u.last > Date.now() - 3600000) {
            div.innerHTML += `<div class="user-item">
                <span>${u.nome}</span>
                <button onclick="addFriend('${u.nome}')">+AMICO</button>
            </div>`;
        }
    });
}

    function toggleAmico(nome, el) {
        if(amiciSelezionati.has(nome)) amiciSelezionati.delete(nome); else amiciSelezionati.add(nome);
        const btn = document.getElementById('btn-sfida-multipla');
        btn.style.display = amiciSelezionati.size > 0 ? 'block' : 'none';
        btn.textContent = `SFIDA ${amiciSelezionati.size} AMICI ‚öîÔ∏è`;
        el.classList.toggle('selected');
    }

    function selezionaGioco(g, el) { 
        giocoSelezionato = g; 
        document.querySelectorAll('.game-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }

    function apriModalSfida() { document.getElementById('modal-sfida-ruzzle').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-sfida-ruzzle').style.display = 'none'; }

    async function creaPartitaMultipla(bonus, crazy, biatch) {
        let mode = crazy ? 'crazy' : (biatch ? 'biatch' : (bonus ? 'bonus' : 'classic'));
        const partecipanti = [mioNome, ...Array.from(amiciSelezionati)];
        let pIniziali = {}; let paroleIniziali = {}; partecipanti.forEach(p => { pIniziali[p]=0; paroleIniziali[p]=[]; });
        
        const doc = await db.collection("partite").add({
            gioco: giocoSelezionato, partecipanti: partecipanti, punteggi: pIniziali, parole: paroleIniziali, pronti: [], finito: [], confermaVerifica: [], stato: "attesa",
            dataOra: new Date().toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}), timestamp: Date.now(),
            opzioni: { 
                tempo: document.getElementById('opt-tempo').value, 
                griglia: document.getElementById('opt-griglia').value, 
                mode: mode, 
                seed: Math.random().toString(36).substring(7).toUpperCase() 
            }
        });
        window.location.href = `${giocoSelezionato}.html?matchId=${doc.id}`;
    }

    function caricaStorico() {
        // Carico le partite e le ordino in JavaScript (evita errore indici Firebase)
        db.collection("partite").where("partecipanti", "array-contains", mioNome).where("stato","==","conclusa").onSnapshot(snap => {
            const div = document.getElementById('lista-storico'); 
            div.innerHTML = "";
            let partite = [];
            snap.forEach(doc => partite.push(doc.data()));
            
            // Ordinamento JS per tempo decrescente
            partite.sort((a,b) => b.timestamp - a.timestamp);

            partite.slice(0, 10).forEach(p => {
                let classif = Object.entries(p.punteggi).sort((a,b)=>b[1]-a[1]);
                let vincitore = classif[0][0];
                div.innerHTML += `<div class="history-item">
                    <span>${p.dataOra} - ${p.gioco.toUpperCase()}</span>
                    <span>Vinto da: <b>${vincitore}</b></span>
                </div>`;
            });
        });
    }

    function addFriend(n) { 
        db.collection("amicizie").doc(mioNome+"_"+n).set({da:mioNome, a:n, stato:'pendente'}); 
        alert("Richiesta inviata!"); 
    }
    
    function logout() { localStorage.clear(); window.location.reload(); }
	 
	 // ==========================================
// üìä SISTEMA STATISTICHE GIORNALIERE
// ==========================================

const STATS_KEY = 'funatwork_daily_stats';

// Funzione per ottenere la data in formato YYYY-MM-DD
function getTodayKey() {
    return new Date().toISOString().split('T')[0];
}

// Funzione per ottenere le statistiche salvate
function getDailyStats() {
    const saved = localStorage.getItem(STATS_KEY);
    return saved ? JSON.parse(saved) : { days: {}, totals: {} };
}

// Funzione per salvare le statistiche
function saveDailyStats(stats) {
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
}

// üéÆ REGISTRA UNA PARTITA (da chiamare quando finisce una partita)
function registraPartita(gioco) {
    const stats = getDailyStats();
    const oggi = getTodayKey();
    
    // Inizializza il giorno se non esiste
    if (!stats.days[oggi]) {
        stats.days[oggi] = {};
    }
    
    // Incrementa contatore giornaliero per questo gioco
    stats.days[oggi][gioco] = (stats.days[oggi][gioco] || 0) + 1;
    
    // Incrementa totale per questo gioco
    stats.totals[gioco] = (stats.totals[gioco] || 0) + 1;
    
    saveDailyStats(stats);
    
    // Aggiorna UI se siamo nella homepage
    if (typeof aggiornaStatsUI === 'function') {
        aggiornaStatsUI();
    }
    
    console.log(`üìä Partita registrata: ${gioco} (${stats.days[oggi][gioco]} oggi)`);
}

// Calcola statistiche
function calcolaStatistiche() {
    const stats = getDailyStats();
    const oggi = getTodayKey();
    const giorni = Object.keys(stats.days).sort();
    
    // Partite oggi
    const partiteOggi = stats.days[oggi] || {};
    const totaleOggi = Object.values(partiteOggi).reduce((a, b) => a + b, 0);
    
    // Partite per gioco oggi
    const ruzzleOggi = partiteOggi.ruzzle || 0;
    
    // Media giornaliera
    const giorniAttivi = giorni.length;
    const partiteTotali = Object.values(stats.totals).reduce((a, b) => a + b, 0);
    const media = giorniAttivi > 0 ? (partiteTotali / giorniAttivi).toFixed(1) : 0;
    
    // Giorno top
    let giornoTop = '-';
    let maxPartite = 0;
    giorni.forEach(giorno => {
        const tot = Object.values(stats.days[giorno]).reduce((a, b) => a + b, 0);
        if (tot > maxPartite) {
            maxPartite = tot;
            const d = new Date(giorno);
            giornoTop = `${d.getDate()}/${d.getMonth() + 1}`;
        }
    });
    if (maxPartite > 0) {
        giornoTop += ` (${maxPartite})`;
    }
    
    // Streak
    let streak = 0;
    let bestStreak = 0;
    let currentStreak = 0;
    
    const sortedDays = [...giorni].sort().reverse();
    const ieri = new Date();
    ieri.setDate(ieri.getDate() - 1);
    const ieriKey = ieri.toISOString().split('T')[0];
    
    if (stats.days[oggi]) {
        currentStreak = 1;
        let checkDate = new Date(oggi);
        
        while (true) {
            checkDate.setDate(checkDate.getDate() - 1);
            const checkKey = checkDate.toISOString().split('T')[0];
            if (stats.days[checkKey]) {
                currentStreak++;
            } else {
                break;
            }
        }
    } else if (stats.days[ieriKey]) {
        currentStreak = 0;
    }
    
    streak = currentStreak;
    
    let tempStreak = 0;
    for (let i = 0; i < sortedDays.length; i++) {
        const currentDay = new Date(sortedDays[i]);
        const prevDay = i > 0 ? new Date(sortedDays[i - 1]) : null;
        
        if (!prevDay) {
            tempStreak = 1;
        } else {
            const diff = (prevDay - currentDay) / (1000 * 60 * 60 * 24);
            if (diff === 1) {
                tempStreak++;
            } else {
                if (tempStreak > bestStreak) bestStreak = tempStreak;
                tempStreak = 1;
            }
        }
    }
    if (tempStreak > bestStreak) bestStreak = tempStreak;
    
    // üîß FIX: Settimana da LUNED√å a DOMENICA con giorni fissi
    const settimanaCorrente = [];
    const oggi_date = new Date();
    
    // Trova il luned√¨ di questa settimana
    const dayOfWeek = oggi_date.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Se domenica, torna indietro di 6 giorni
    
    const lunedi = new Date(oggi_date);
    lunedi.setDate(oggi_date.getDate() + diffToMonday);
    
    // Genera i 7 giorni da LUN a DOM
    for (let i = 0; i < 7; i++) {
        const d = new Date(lunedi);
        d.setDate(lunedi.getDate() + i);
        const key = d.toISOString().split('T')[0];
        const dayName = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'][i];
        const count = stats.days[key] ? Object.values(stats.days[key]).reduce((a, b) => a + b, 0) : 0;
        
        settimanaCorrente.push({
            key,
            dayName,
            count,
            isToday: key === oggi
        });
    }
    
    return {
        totaleOggi,
        ruzzleOggi,
        media,
        giornoTop,
        partiteTotali,
        giorniAttivi,
        streak,
        bestStreak,
        ultimi7Giorni: settimanaCorrente, // üëà Ora parte da Luned√¨
        totals: stats.totals
    };
}

// Aggiorna l'interfaccia delle statistiche
function aggiornaStatsUI() {
    const s = calcolaStatistiche();
    
    // ‚úÖ Feedback caricamento
    const statsContent = document.getElementById('stats-content');
    if (statsContent) {
        statsContent.style.opacity = '0.5';
        setTimeout(() => statsContent.style.opacity = '1', 200);
    }
    // Valori oggi
    const elOggiTotale = document.getElementById('stat-oggi-totale');
    const elOggiRuzzle = document.getElementById('stat-oggi-ruzzle');
    const elMedia = document.getElementById('stat-media');
    const elTopDay = document.getElementById('stat-top-day');
    
    if (elOggiTotale) elOggiTotale.textContent = s.totaleOggi;
    if (elOggiRuzzle) elOggiRuzzle.textContent = s.ruzzleOggi;
    if (elMedia) elMedia.textContent = s.media;
    if (elTopDay) elTopDay.textContent = s.giornoTop;
    
    // Valori totali
    const elTotalePartite = document.getElementById('stat-totale-partite');
    const elGiorniAttivi = document.getElementById('stat-giorni-attivi');
    const elStreak = document.getElementById('stat-streak');
    const elBestStreak = document.getElementById('stat-best-streak');
    
    if (elTotalePartite) elTotalePartite.textContent = s.partiteTotali;
    if (elGiorniAttivi) elGiorniAttivi.textContent = s.giorniAttivi;
    if (elStreak) elStreak.textContent = s.streak + ' üî•';
    if (elBestStreak) elBestStreak.textContent = s.bestStreak;
    
    // Grafico settimanale
    renderWeeklyChart(s.ultimi7Giorni);
}

// Renderizza il grafico settimanale
function renderWeeklyChart(data) {
    const container = document.getElementById('weekly-bars');
    if (!container) return;
    
    const maxCount = Math.max(...data.map(d => d.count), 1);
    
    container.innerHTML = data.map(day => {
        const heightPercent = (day.count / maxCount) * 100;
        const barClass = day.isToday ? 'bar today' : 'bar';
        
        return `
            <div class="day-bar">
                <div class="count">${day.count}</div>
                <div class="${barClass}" style="height: ${Math.max(heightPercent, 5)}%;"></div>
                <div class="label">${day.dayName}</div>
            </div>
        `;
    }).join('');
}

// Gestione tab statistiche
function showStatsTab(tab) {
    // Aggiorna tab attivo
    document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Mostra/nascondi contenuti
    const statsOggi = document.querySelector('.stats-grid-home');
    const statsSempre = document.getElementById('stats-sempre');
    const statsWeekly = document.getElementById('stats-weekly-chart');
    
    if (tab === 'oggi') {
        if (statsOggi) statsOggi.style.display = 'grid';
        if (statsSempre) statsSempre.style.display = 'none';
        if (statsWeekly) statsWeekly.style.display = 'none';
    } else if (tab === 'settimana') {
        if (statsOggi) statsOggi.style.display = 'none';
        if (statsSempre) statsSempre.style.display = 'none';
        if (statsWeekly) statsWeekly.style.display = 'block';
    } else if (tab === 'sempre') {
        if (statsOggi) statsOggi.style.display = 'none';
        if (statsSempre) statsSempre.style.display = 'block';
        if (statsWeekly) statsWeekly.style.display = 'none';
    }
}

// Carica statistiche all'avvio
document.addEventListener('DOMContentLoaded', () => {
    aggiornaStatsUI();
});

// Aggiorna ogni minuto (per aggiornare "oggi" se cambia giorno)
setInterval(aggiornaStatsUI, 60000);

function resetTutteLeStatistiche() {
    if(!confirm("‚ö†Ô∏è ATTENZIONE!\n\nQuesta azione canceller√† TUTTE le statistiche:\n- Partite giocate\n- Punteggi\n- Achievement\n- Storico\n\nSei sicuro?")) return;
    
    // Cancella statistiche Ruzzle
    localStorage.removeItem('paroliere_data');
    
    // Cancella statistiche giornaliere
    localStorage.removeItem('funatwork_daily_stats');
    
    alert("‚úÖ Statistiche azzerate!");
    location.reload();
}
function toggleDisponibilita() {
    const attuale = localStorage.getItem('disponibile') !== 'false';
    const nuovo = !attuale;
    localStorage.setItem('disponibile', nuovo);
    aggiornaUIDisponibilita();
    aggiornaPresenza(); // Aggiorna Firebase
}

function aggiornaUIDisponibilita() {
    const disponibile = localStorage.getItem('disponibile') !== 'false';
    const btn = document.getElementById('btn-disponibilita');
    if (btn) {
        if (disponibile) {
            btn.textContent = 'üü¢ Disponibile';
            btn.style.background = '#2ecc71';
            btn.style.color = 'white';
        } else {
            btn.textContent = 'üî¥ Non disturbare';
            btn.style.background = '#e74c3c';
            btn.style.color = 'white';
        }
    }
}
</script>
</body>
</html>

