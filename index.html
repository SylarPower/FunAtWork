<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pig Games Portal üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 10px; margin: 5px 0; border-radius: 8px; }
        button { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-sfida { background: #03dac6; }
        .btn-delete { background: #cf6679; color: white; font-size: 0.7rem; margin-left: 10px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:100; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; }
        select, input { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #444; }
        .live-match { border-left: 4px solid #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <div id="user-info" style="margin-bottom:10px; color:#03dac6;"></div>

    <!-- PARTITE IN CORSO (LIVE SCORE) -->
    <div class="box">
        <h3>üèÜ Partite Live</h3>
        <div id="lista-partite-live"></div>
    </div>

    <!-- AMICI -->
    <div class="box">
        <h3>‚≠ê Amici</h3>
        <div id="lista-amici"></div>
    </div>

    <!-- GLOBAL -->
    <div class="box">
        <h3>üåç Colleghi Online</h3>
        <div id="lista-global"></div>
    </div>
</div>

<!-- MODAL OPZIONI SFIDA -->
<div id="modal-sfida" class="modal">
    <div class="modal-content">
        <h2 id="sfida-target">Sfida</h2>
        <label>Tempo:</label>
        <select id="opt-tempo">
            <option value="60">60s (Blitz)</option>
            <option value="180" selected>180s (Standard)</option>
            <option value="300">300s (Relax)</option>
        </select>
        <label>Griglia:</label>
        <select id="opt-griglia">
            <option value="4">4x4</option>
            <option value="5" selected>5x5</option>
            <option value="10">10x10</option>
        </select>
        <label>Modalit√†:</label>
        <select id="opt-mode">
            <option value="classic">Classica</option>
            <option value="bonus">Bonus ‚≠ê</option>
            <option value="crazy">Crazy ü§™</option>
        </select>
        <button onclick="confermaSfida()" style="background:#03dac6; width:100%;">LANCIA SFIDA!</button>
        <button onclick="chiudiModal()" style="background:transparent; color:white; width:100%; margin-top:10px;">Annulla</button>
    </div>
</div>

<script>
    // --- CONFIGURAZIONE FIREBASE (METTI LE TUE CHIAVI) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mioNome = localStorage.getItem('mioNome') || prompt("Come ti chiami?").toUpperCase();
    localStorage.setItem('mioNome', mioNome);
    document.getElementById('user-info').textContent = "Ciao, " + mioNome;

    let targetSfidante = "";

    function aggiornaPresenza() { db.collection("presenze").doc(mioNome).set({ nome: mioNome, ultimoAccesso: Date.now() }); }
    aggiornaPresenza(); setInterval(aggiornaPresenza, 30000);

    // ASCOLTA TUTTO
    function ascolta() {
        // Global
        db.collection("presenze").onSnapshot(snap => {
            const list = document.getElementById('lista-global'); list.innerHTML = "";
            snap.forEach(doc => { if(doc.id !== mioNome) list.innerHTML += `<div class="user-item"><span>${doc.id}</span><button onclick="chiediAmicizia('${doc.id}')">‚ûï AMICO</button></div>`; });
        });

        // Amici
        db.collection("amicizie").onSnapshot(snap => {
            const list = document.getElementById('lista-amici'); list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                let amico = "";
                if(d.da === mioNome && d.stato === 'amici') amico = d.a;
                if(d.a === mioNome && d.stato === 'amici') amico = d.da;
                if(amico) {
                    list.innerHTML += `<div class="user-item">
                        <span>‚≠ê ${amico}</span>
                        <div>
                            <button class="btn-sfida" onclick="apriModalSfida('${amico}')">SFIDA</button>
                            <button class="btn-delete" onclick="rimuoviAmico('${doc.id}')">Elimina</button>
                        </div>
                    </div>`;
                } else if(d.a === mioNome && d.stato === 'pendente') {
                    list.innerHTML += `<div class="user-item"><span>Richiesta da: ${d.da}</span><button onclick="accettaAmicizia('${doc.id}')">ACCETTA</button></div>`;
                }
            });
        });

        // Partite Live (Punteggi)
        db.collection("partite").where("partecipanti", "array-contains", mioNome)
        .onSnapshot(snap => {
            const list = document.getElementById('lista-partite-live'); list.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                
                let scoresHtml = "";
                for(let player in p.punteggi) {
                    scoresHtml += `<b style="color:${player === mioNome ? '#03dac6' : '#ff4081'}">${player}: ${p.punteggi[player]}</b> `;
                }

                list.innerHTML += `
                    <div class="user-item live-match">
                        <div>
                            <small>${p.opzioni.griglia}x${p.opzioni.griglia} - ${p.opzioni.mode}</small><br>
                            ${scoresHtml}
                        </div>
                        <button onclick="entraInPartita('${doc.id}')">GIOCA</button>
                    </div>`;
            });
        });
    }

    function apriModalSfida(nome) { targetSfidante = nome; document.getElementById('sfida-target').textContent = "Sfida " + nome; document.getElementById('modal-sfida').style.display = 'flex'; }
    function chiudiModal() { document.getElementById('modal-sfida').style.display = 'none'; }

    async function confermaSfida() {
        const opzioni = {
            tempo: document.getElementById('opt-tempo').value,
            griglia: document.getElementById('opt-griglia').value,
            mode: document.getElementById('opt-mode').value,
            seed: Math.random().toString(36).substring(7).toUpperCase()
        };
        
        const partita = {
            partecipanti: [mioNome, targetSfidante],
            punteggi: { [mioNome]: 0, [targetSfidante]: 0 },
            opzioni: opzioni,
            stato: "attesa",
            creataDa: mioNome,
            timestamp: Date.now()
        };

        const docRef = await db.collection("partite").add(partita);
        chiudiModal();
        entraInPartita(docRef.id);
    }

    function entraInPartita(id) { window.location.href = `ruzzle.html?matchId=${id}`; }
    function chiediAmicizia(n) { db.collection("amicizie").doc(mioNome + "_" + n).set({ da: mioNome, a: n, stato: "pendente" }); }
    function accettaAmicizia(id) { db.collection("amicizie").doc(id).update({ stato: "amici" }); }
    function rimuoviAmico(id) { if(confirm("Rimuovere amico?")) db.collection("amicizie").doc(id).delete(); }

    ascolta();
</script>
</body>
</html>
