<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Pig Games Social üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin: 8px 0; border-radius: 8px; }
        button { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-sfida { background: #03dac6; color: #000; }
        .btn-add { background: #bb86fc; color: #000; }
        .btn-del { background: #cf6679; color: white; font-size: 0.7rem; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:100; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 2px solid #333; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 6px; }
        .live-match { border-left: 5px solid #f1c40f; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { border-color: #f1c40f; } 50% { border-color: #e67e22; } 100% { border-color: #f1c40f; } }
    </style>
</head>
<body>
<div class="container">
    <div id="user-display" style="color:#03dac6; font-weight:bold; margin-bottom:15px;"></div>
    
    <div class="box">
        <h3>üéÆ Partite in Corso / Sfide</h3>
        <div id="lista-partite"></div>
    </div>

    <div class="box">
        <h3>‚≠ê I tuoi Amici</h3>
        <div id="lista-amici"></div>
    </div>

    <div class="box">
        <h3>üåç Altri Colleghi Online</h3>
        <div id="lista-global"></div>
    </div>
</div>

<div id="modal-sfida" class="modal">
    <div class="modal-content">
        <h2 id="target-name">Sfida</h2>
        <label>Tempo:</label>
        <select id="opt-tempo">
            <option value="60">60s (Blitz)</option>
            <option value="180" selected>180s (Standard)</option>
            <option value="300">300s (Relax)</option>
        </select>
        <label>Griglia:</label>
        <select id="opt-griglia">
            <option value="4">4x4</option>
            <option value="5" selected>5x5</option>
            <option value="6">6x6</option>
            <option value="10">10x10</option>
        </select>
        <label>Modalit√†:</label>
        <select id="opt-mode">
            <option value="classic">Classica</option>
            <option value="bonus">Bonus ‚≠ê</option>
            <option value="crazy">Crazy ü§™</option>
            <option value="biatch">BIATCH üíÖ</option>
        </select>
        <button onclick="creaPartita()" style="background:#03dac6; width:100%; height:50px;">INVIA SFIDA</button>
        <button onclick="closeModal()" style="background:none; color:#777; width:100%; margin-top:10px;">Annulla</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const mioNome = localStorage.getItem('mioNome') || prompt("Inserisci il tuo nome").toUpperCase();
    localStorage.setItem('mioNome', mioNome);
    document.getElementById('user-display').textContent = "UTENTE: " + mioNome;<!--citation:1--><!--citation:3--><!--citation:4-->

    let targetUser = "";
    let listaAmici = new Set();

    function updateStatus() { db.collection("presenze").doc(mioNome).set({ nome: mioNome, last: Date.now() }); }
    updateStatus(); setInterval(updateStatus, 20000);

    function listen() {
        // Ascolta Amici per filtrare Global
        db.collection("amicizie").onSnapshot(snap => {
            listaAmici.clear();
            const amiciDiv = document.getElementById('lista-amici'); amiciDiv.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                let amico = (d.da === mioNome) ? d.a : (d.a === mioNome ? d.da : null);
                if(amico && d.stato === 'amici') {
                    listaAmici.add(amico);
                    amiciDiv.innerHTML += `<div class="user-item"><span>‚≠ê ${amico}</span><div><button class="btn-sfida" onclick="openSfida('${amico}')">SFIDA</button><button class="btn-del" onclick="removeAmico('${doc.id}')">X</button></div></div>`;
                } else if(d.a === mioNome && d.stato === 'pendente') {
                    amiciDiv.innerHTML += `<div class="user-item"><span>Richiesta da: ${d.da}</span><button onclick="accettaAmico('${doc.id}')">ACCETTA</button></div>`;
                }
            });
            updateGlobal();
        });<!--citation:1--><!--citation:4--><!--citation:7-->

        // Partite
        db.collection("partite").where("partecipanti", "array-contains", mioNome).onSnapshot(snap => {
            const partDiv = document.getElementById('lista-partite'); partDiv.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                let avversario = p.partecipanti.find(n => n !== mioNome);
                partDiv.innerHTML += `<div class="user-item live-match"><span>Partita vs ${avversario} (${p.stato})</span><button onclick="vaiAlGioco('${doc.id}')">ENTRA</button></div>`;
            });
        });
    }<!--citation:3--><!--citation:6-->

    function updateGlobal() {
        db.collection("presenze").onSnapshot(snap => {
            const globDiv = document.getElementById('lista-global'); globDiv.innerHTML = "";
            snap.forEach(doc => {
                if(doc.id !== mioNome && !listaAmici.has(doc.id)) {
                    globDiv.innerHTML += `<div class="user-item"><span>${doc.id}</span><button class="btn-add" onclick="addAmico('${doc.id}')">+AMICO</button></div>`;
                }
            });
        });
    }

    function openSfida(n) { targetUser = n; document.getElementById('modal-sfida').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-sfida').style.display = 'none'; }

    async function creaPartita() {
        const doc = await db.collection("partite").add({
            partecipanti: [mioNome, targetUser],
            punteggi: { [mioNome]: 0, [targetUser]: 0 },
            parole: { [mioNome]: [], [targetUser]: [] },
            pronti: [],
            confermaVerifica: [],
            stato: "attesa",
            opzioni: {
                tempo: document.getElementById('opt-tempo').value,
                griglia: document.getElementById('opt-griglia').value,
                mode: document.getElementById('opt-mode').value,
                seed: Math.random().toString(36).substring(2, 9).toUpperCase()
            }
        });
        vaiAlGioco(doc.id);
    }

    function vaiAlGioco(id) { window.location.href = `ruzzle.html?matchId=${id}`; }
    function addAmico(n) { db.collection("amicizie").doc(mioNome+"_"+n).set({ da: mioNome, a: n, stato: 'pendente' }); }
    function accettaAmico(id) { db.collection("amicizie").doc(id).update({ stato: 'amici' }); }
    function removeAmico(id) { if(confirm("Rimuovere?")) db.collection("amicizie").doc(id).delete(); }

    listen();
</script>
</body>
</html>
