<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Games Colleghi üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        h1, h2, h3 { color: #bb86fc; margin-top: 0; }
        input { width: calc(100% - 24px); padding: 12px; margin: 10px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; }
        button { background: #03dac6; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #018786; }
        .btn-sfida { background: #cf6679; color: white; }
        .btn-friend { background: #3700b3; color: white; margin-left: 5px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #03dac6; }
        .badge { font-size: 0.7rem; background: #444; padding: 3px 7px; border-radius: 10px; color: #bbb; }
        #status-bar { font-size: 0.9rem; margin-bottom: 10px; color: #03dac6; }
    </style>
</head>
<body>

<div class="container">
    <div id="status-bar"></div>

    <!-- LOGIN / BENVENUTO -->
    <div id="login-div" class="box">
        <h1>Benvenuto üê∑</h1>
        <input type="text" id="username" placeholder="Inserisci il tuo nome...">
        <button onclick="entra()">ENTRA</button>
    </div>

    <div id="main-app" style="display:none;">
        <!-- RICHIESTE AMICIZIA IN ARRIVO -->
        <div id="richieste-div" class="box" style="display:none;">
            <h3>Richieste di Amicizia:</h3>
            <div id="lista-richieste"></div>
        </div>

        <!-- AMICI ONLINE -->
        <div class="box">
            <h3>I tuoi Amici Online:</h3>
            <div id="lista-amici"></div>
        </div>

        <!-- CERCA ALTRI COLLEGHI -->
        <div class="box">
            <h3>Cerca Colleghi (Global):</h3>
            <div id="lista-global"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURAZIONE (METTI LE TUE CHIAVI QUI) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mioNome = localStorage.getItem('mioNome') || "";

    // Se il nome √® gi√† salvato, entra automaticamente
    if(mioNome) {
        window.onload = () => entra();
    }

    function entra() {
        if(!mioNome) {
            mioNome = document.getElementById('username').value.trim().toUpperCase();
        }
        
        if(mioNome.length < 2) return alert("Nome troppo corto!");
        
        // Salva nel browser
        localStorage.setItem('mioNome', mioNome);
        
        document.getElementById('login-div').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('status-bar').textContent = "Connesso come: " + mioNome;

        aggiornaPresenza();
        setInterval(aggiornaPresenza, 30000); // Heartbeat ogni 30 secondi

        ascoltaTutto();
    }

    // Segna che sono online e aggiorna l'orario
    function aggiornaPresenza() {
        db.collection("presenze").doc(mioNome).set({
            nome: mioNome,
            ultimoAccesso: Date.now()
        });
    }

    function ascoltaTutto() {
        // 1. Ascolta Colleghi Globali (chiunque sia entrato negli ultimi 5 minuti)
        db.collection("presenze").onSnapshot(snapshot => {
            const listaGlobal = document.getElementById('lista-global');
            listaGlobal.innerHTML = "";
            const cinqueMinutiFa = Date.now() - (5 * 60 * 1000);

            snapshot.forEach(doc => {
                const u = doc.data();
                if(u.nome !== mioNome && u.ultimoAccesso > cinqueMinutiFa) {
                    listaGlobal.innerHTML += `
                        <div class="user-item">
                            <span>${u.nome}</span>
                            <button class="btn-friend" onclick="chiediAmicizia('${u.nome}')">‚ûï AMICO</button>
                        </div>`;
                }
            });
        });

        // 2. Ascolta Richieste di Amicizia per ME
        db.collection("amicizie").where("a", "==", mioNome).where("stato", "==", "pendente")
        .onSnapshot(snapshot => {
            const divRichieste = document.getElementById('richieste-div');
            const lista = document.getElementById('lista-richieste');
            lista.innerHTML = "";
            
            if(snapshot.empty) divRichieste.style.display = 'none';
            else divRichieste.style.display = 'block';

            snapshot.forEach(doc => {
                const r = doc.data();
                lista.innerHTML += `
                    <div class="user-item">
                        <span>Richiesta da: ${r.da}</span>
                        <button onclick="accettaAmicizia('${doc.id}', '${r.da}')">ACCETTA</button>
                    </div>`;
            });
        });

        // 3. Ascolta Amici Accettati
        // Cerchiamo le amicizie dove io sono 'da' o 'a' e lo stato √® 'amici'
        db.collection("amicizie").where("stato", "==", "amici")
        .onSnapshot(snapshot => {
            const listaAmici = document.getElementById('lista-amici');
            listaAmici.innerHTML = "";
            let amiciNomi = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.da === mioNome) amiciNomi.push(d.a);
                if(d.a === mioNome) amiciNomi.push(d.da);
            });

            amiciNomi.forEach(amico => {
                listaAmici.innerHTML += `
                    <div class="user-item">
                        <span>‚≠ê ${amico}</span>
                        <button class="btn-sfida" onclick="inviaSfida('${amico}')">SFIDA</button>
                    </div>`;
            });
        });

        // 4. Ascolta Sfide in arrivo
        db.collection("sfide").where("a", "==", mioNome).onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    const s = change.doc.data();
                    if(confirm(s.da + " ti sfida! Accetti?")) {
                        window.location.href = `ruzzle.html?code=${s.seed}`;
                    }
                }
            });
        });
    }

    function chiediAmicizia(nomeDest) {
        db.collection("amicizie").doc(mioNome + "_" + nomeDest).set({
            da: mioNome,
            a: nomeDest,
            stato: "pendente"
        });
        alert("Richiesta inviata!");
    }

    function accettaAmicizia(docId, nomeAmico) {
        db.collection("amicizie").doc(docId).update({ stato: "amici" });
        alert("Ora sei amico di " + nomeAmico);
    }

    function inviaSfida(amico) {
        const seed = Math.random().toString(36).substring(7).toUpperCase();
        db.collection("sfide").add({
            da: mioNome, a: amico, seed: seed, timestamp: Date.now()
        });
        alert("Sfida inviata a " + amico);
    }
</script>
</body>
</html>
