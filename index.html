<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Pig Games Social üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin: 8px 0; border-radius: 8px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-sfida { background: #03dac6; color: #000; }
        .btn-del { background: #cf6679; color: white; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:100; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 2px solid #333; }
        .live-match { border-left: 5px solid #f1c40f; }
        .history-item { font-size: 0.85rem; border-bottom: 1px solid #333; padding: 10px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
<div class="container">
    
    <!-- LOGIN -->
    <div id="login-div" class="box">
        <h1>Benvenuto üê∑</h1>
        <p>Inserisci nome e password (nuova o esistente).</p>
        <input type="text" id="username" placeholder="NOME (es: MARCO)">
        <input type="password" id="password" placeholder="Password">
        <button onclick="entra()" style="background:#03dac6; width:100%; height:50px;">ENTRA / REGISTRATI</button>
    </div>

    <!-- DASHBOARD -->
    <div id="main-app" style="display:none;">
        <div id="user-display" style="color:#03dac6; font-weight:bold; margin-bottom:15px; font-size:1.2rem;"></div>
        
        <div class="box">
            <h3>üéÆ Partite In Corso / Inviti</h3>
            <div id="lista-partite"></div>
        </div>

        <div class="box">
            <h3>‚≠ê I tuoi Amici</h3>
            <div id="lista-amici"></div>
        </div>

        <div class="box">
            <h3>üåç Altri Colleghi Online</h3>
            <div id="lista-global"></div>
        </div>

        <div class="box">
            <h3>üìú Storico Partite</h3>
            <div id="lista-storico"></div>
        </div>
        
        <button onclick="logout()" style="background:#cf6679; width:100%;">LOGOUT</button>
    </div>
</div>

<div id="modal-sfida" class="modal">
    <div class="modal-content">
        <h2 id="target-name">Sfida</h2>
        <label>Tempo:</label>
        <select id="opt-tempo">
            <option value="45">45s</option><option value="60">60s</option><option value="90">90s</option>
            <option value="180" selected>180s</option><option value="300">300s</option>
        </select>
        <label>Griglia:</label>
        <select id="opt-griglia"><option value="4">4x4</option><option value="5" selected>5x5</option><option value="6">6x6</option><option value="10">10x10</option></select>
        <label>Modalit√†:</label>
        <select id="opt-mode"><option value="classic">Classica</option><option value="bonus">Bonus ‚≠ê</option><option value="crazy">Crazy ü§™</option><option value="biatch">BIATCH üíÖ</option></select>
        <button onclick="creaPartita()" style="background:#03dac6; width:100%; height:50px;">LANCIA SFIDA</button>
        <button onclick="closeModal()" style="background:none; color:#777; width:100%; margin-top:10px;">Annulla</button>
    </div>
</div>

<script>
    // --- METTI QUI IL TUO CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // RECUPERA NOME E PASSWORD SALVATI
    let mioNome = localStorage.getItem('mioNome') || "";
    let miaPass = localStorage.getItem('miaPass') || "";

    // AUTOLOGIN SE DATI PRESENTI
    if(mioNome && miaPass) {
        window.onload = () => {
            document.getElementById('username').value = mioNome;
            document.getElementById('password').value = miaPass;
            entra(true); // Parametro true per evitare alert inutili
        };
    }

    async function entra(isAuto = false) {
        const n = document.getElementById('username').value.trim().toUpperCase();
        const p = document.getElementById('password').value.trim();
        if(n.length < 2 || p.length < 3) return;

        const userRef = db.collection("utenti").doc(n);
        const doc = await userRef.get();

        if(doc.exists) {
            if(doc.data().password !== p) {
                if(!isAuto) alert("Password Errata!");
                return;
            }
        } else {
            if(confirm("Nuovo utente? Registrati con questa password.")) {
                await userRef.set({ nome: n, password: p });
            } else return;
        }

        mioNome = n;
        localStorage.setItem('mioNome', n);
        localStorage.setItem('miaPass', p); // Salva la pass per il prossimo accesso
        
        document.getElementById('login-div').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-display').textContent = "UTENTE: " + mioNome;

        updateStatus(); setInterval(updateStatus, 20000);
        listen();
        caricaStorico();
    }

    function updateStatus() { db.collection("presenze").doc(mioNome).set({ nome: mioNome, last: Date.now() }); }

    function listen() {
        // AMICI: Mostra solo se stato='amici'
        db.collection("amicizie").onSnapshot(snap => {
            const div = document.getElementById('lista-amici'); div.innerHTML = "";
            let amiciSet = new Set();
            snap.forEach(doc => {
                const d = doc.data();
                let amico = (d.da === mioNome) ? d.a : (d.a === mioNome ? d.da : null);
                if(amico && d.stato === 'amici') {
                    amiciSet.add(amico);
                    div.innerHTML += `<div class="user-item"><span>‚≠ê ${amico}</span><div><button class="btn-sfida" onclick="openSfida('${amico}')">SFIDA</button><button onclick="db.collection('amicizie').doc('${doc.id}').delete()" style="margin-left:10px; background:#444; color:white; border:none; padding:5px;">X</button></div></div>`;
                } else if(d.a === mioNome && d.stato === 'pendente') {
                    div.innerHTML += `<div class="user-item"><span>Richiesta da: ${d.da}</span><button onclick="db.collection('amicizie').doc('${doc.id}').update({stato:'amici'})">ACCETTA</button></div>`;
                }
            });
            // Aggiorna GLOBAL filtrando chi √® gi√† amico
            updateGlobal(amiciSet);
        });

        // PARTITE
        db.collection("partite").where("partecipanti", "array-contains", mioNome).onSnapshot(snap => {
            const div = document.getElementById('lista-partite'); div.innerHTML = "";
            div.innerHTML = `<div class="user-item" style="background:#34495e;"><span>Allenamento Solo</span><button onclick="window.location.href='ruzzle.html'">GIOCA</button></div>`;
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                let avv = p.partecipanti.find(n => n !== mioNome);
                div.innerHTML += `<div class="user-item live-match"><span>vs ${avv} (${p.dataOra})</span><div><button onclick="window.location.href='ruzzle.html?matchId=${doc.id}'">ENTRA</button><button onclick="db.collection('partite').doc('${doc.id}').delete()" style="background:#cf6679; margin-left:5px; color:white; border:none; padding:5px;">üóëÔ∏è</button></div></div>`;
            });
        });
    }

function updateGlobal(amiciSet) {
    db.collection("presenze").get().then(snap => {
        const div = document.getElementById('lista-global'); 
        div.innerHTML = "";
        snap.forEach(doc => {
            // Mostra l'utente solo se non sono io e se non √® gi√† mio amico
            if(doc.id !== mioNome && !amiciSet.has(doc.id)) {
                div.innerHTML += `
                    <div class="user-item">
                        <span>${doc.id}</span>
                        <button onclick="inviaRichiestaAmicizia('${doc.id}')" style="background:#bb86fc; color:black;">+ AMICO</button>
                    </div>`;
            }
        });
    });
}

// Nuova funzione da aggiungere in fondo allo script di index.html
async function inviaRichiestaAmicizia(target) {
    try {
        await db.collection("amicizie").doc(mioNome + "_" + target).set({
            da: mioNome,
            a: target,
            stato: 'pendente',
            timestamp: Date.now()
        });
        alert("Richiesta inviata a " + target + "!");
    } catch (e) {
        console.error(e);
        alert("Errore nell'invio della richiesta. Controlla le Rules di Firebase.");
    }
}

    function caricaStorico() {
        db.collection("partite").where("partecipanti", "array-contains", mioNome).where("stato","==","conclusa").onSnapshot(snap => {
            const div = document.getElementById('lista-storico'); div.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                const v = p.punteggi[p.partecipanti[0]] > p.punteggi[p.partecipanti[1]] ? p.partecipanti[0] : p.partecipanti[1];
                div.innerHTML += `<div class="history-item"><span>${p.dataOra} vs ${p.partecipanti.find(n=>n!==mioNome)}</span><span>Vincitore: <b>${v}</b></span></div>`;
            });
        });
    }

    let targetSfidante = "";
    function openSfida(n) { targetSfidante = n; document.getElementById('target-name').textContent = "Sfida " + n; document.getElementById('modal-sfida').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-sfida').style.display = 'none'; }

    async function creaPartita() {
        const ora = new Date().toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
        const doc = await db.collection("partite").add({
            partecipanti: [mioNome, targetSfidante], punteggi: {[mioNome]:0, [targetSfidante]:0}, parole: {[mioNome]:[], [targetSfidante]:[]},
            pronti: [], finito: [], confermaVerifica: [], stato: "attesa", dataOra: ora, timestamp: Date.now(),
            opzioni: { tempo: document.getElementById('opt-tempo').value, griglia: document.getElementById('opt-griglia').value, mode: document.getElementById('opt-mode').value, seed: Math.random().toString(36).substring(7).toUpperCase() }
        });
        window.location.href = `ruzzle.html?matchId=${doc.id}`;
    }
    function logout() { localStorage.clear(); window.location.reload(); }
</script>
</body>
</html>


