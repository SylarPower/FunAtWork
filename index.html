<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portale FaW</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        h1, h3 { color: #03dac6; margin-top: 0; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .user-item:hover { border-color: #444; }
        .user-item.selected { background: #03dac6 !important; color: #000; border-color: white; }
        
        .btn-sfida-multi { background: #f1c40f; color: #000; width: 100%; height: 50px; font-size: 1.1rem; margin-bottom: 15px; display: none; }
        .btn-del { background: #cf6679; color: white; padding: 5px 10px; font-size: 0.8rem; }
        
        .live-match { border-left: 5px solid #f1c40f; }
        .history-item { font-size: 0.85rem; border-bottom: 1px solid #333; padding: 8px 0; display: flex; justify-content: space-between; }
        
        #user-display { background: #03dac6; color: #000; padding: 5px 15px; border-radius: 20px; display: inline-block; font-weight: bold; margin-bottom: 20px; }
                
        .game-card { 
            min-width: 100px; padding: 15px; background: #252525; border-radius: 10px; 
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s;
        }
        .game-card.selected { border-color: #03dac6; background: #1a3a3a; opacity: 1 !important; }
        .modal { 
    display: none; /* Inizia nascosto */
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.9); 
    z-index: 10000; 
    justify-content: center; 
    align-items: center; 
}
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 2px solid #333; }
    
	 /* STATISTICHE HOMEPAGE */
.stats-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    border-bottom: 2px solid #333;
    padding-bottom: 10px;
}

.stats-tab {
    flex: 1;
    padding: 8px 12px;
    background: #2c2c2c;
    border: none;
    border-radius: 6px 6px 0 0;
    color: #888;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

.stats-tab.active {
    background: #03dac6;
    color: #000;
}

.stats-tab:hover:not(.active) {
    background: #3c3c3c;
    color: #fff;
}

.stats-grid-home {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

@media (min-width: 500px) {
    .stats-grid-home {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-box {
    background: #252525;
    padding: 15px 10px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid #333;
    transition: transform 0.2s;
}

.stat-box:hover {
    transform: scale(1.03);
}

.stat-box.highlight {
    background: linear-gradient(135deg, #1a3a3a 0%, #0d2626 100%);
    border-color: #03dac6;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 900;
    color: #03dac6;
    line-height: 1.2;
}

.stat-desc {
    font-size: 0.75rem;
    color: #888;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Grafico settimanale */
.weekly-bars {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    height: 100px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 8px;
    gap: 5px;
}

.day-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.day-bar .bar {
    width: 100%;
    max-width: 30px;
    background: linear-gradient(to top, #03dac6, #018786);
    border-radius: 4px 4px 0 0;
    min-height: 5px;
    transition: height 0.5s ease;
}

.day-bar .bar.today {
    background: linear-gradient(to top, #f1c40f, #e67e22);
    box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
}

.day-bar .label {
    font-size: 0.65rem;
    color: #666;
    text-transform: uppercase;
}

.day-bar .count {
    font-size: 0.7rem;
    color: #03dac6;
    font-weight: bold;
}

/* Giochi breakdown */
.games-breakdown {
    margin-top: 10px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 8px;
}

.game-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #333;
}

.game-row:last-child {
    border-bottom: none;
}

.game-name {
    display: flex;
    align-items: center;
    gap: 8px;
}

.game-count {
    font-weight: bold;
    color: #03dac6;
}
	 
	 </style>
</head>
<body>

<div class="container">
    
    <!-- LOGIN -->
    <div id="login-div" class="box">
        <h1>Login dei üê∑</h1>
        <input type="text" id="username" placeholder="IL TUO NOME">
        <input type="password" id="password" placeholder="PASSWORD">
        <button onclick="entra()" style="background:#03dac6; width:100%; height:50px; color:#000;">ENTRA / REGISTRATI</button>
    </div>

    <!-- DASHBOARD -->
    <div id="main-app" style="display:none;">
        <div id="user-display"></div>
        
        <div class="box">
            <h3>üéÆ Partite In Corso</h3>
            <div id="lista-partite"></div>
        </div>
        <div class="box">
            <h3>üéÆ Scegli il Gioco</h3>
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                <div class="game-card selected" onclick="selezionaGioco('ruzzle', this)" id="game-ruzzle">
                    <span style="font-size:2rem;">üî†</span><br>Ruzzle
                </div>
                <div class="game-card" style="opacity:0.3; cursor:not-allowed; pointer-events:none;">
                    <span style="font-size:2rem;">‚ùå</span><br>Prossimamente
                </div>
                <!-- Aggiungerai qui i futuri giochi -->
            </div>
        </div>
        <div class="box">
            <h3>‚≠ê I tuoi Amici</h3>
            <p style="font-size:0.8rem; opacity:0.6;">Clicca sui nomi per selezionare pi√π amici e sfidarli insieme!</p>
            <button id="btn-sfida-multipla" class="btn-sfida-multi" onclick="apriModalSfida()">SFIDA IL GRUPPO ‚öîÔ∏è</button>
            <div id="lista-amici"></div>
        </div>

        <div class="box">
            <h3>üåç Altri Colleghi Online</h3>
            <div id="lista-global"></div>
        </div>

<!-- BOX STATISTICHE GIORNALIERE -->
<div class="box">
    <h3>üìä Le Tue Statistiche</h3>
    
    <!-- Tab per cambiare vista -->
    <div class="stats-tabs">
        <button class="stats-tab active" onclick="showStatsTab('oggi')">Oggi</button>
        <button class="stats-tab" onclick="showStatsTab('settimana')">Settimana</button>
        <button class="stats-tab" onclick="showStatsTab('sempre')">Sempre</button>
    </div>
    
    <!-- Contenuto statistiche -->
    <div id="stats-content">
        <div class="stats-grid-home">
            <div class="stat-box">
                <div class="stat-number" id="stat-oggi-totale">0</div>
                <div class="stat-desc">Partite Oggi</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-oggi-ruzzle">0</div>
                <div class="stat-desc">üé≤ Ruzzle</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-media">0</div>
                <div class="stat-desc">Media/Giorno</div>
            </div>
            <div class="stat-box highlight">
                <div class="stat-number" id="stat-top-day">-</div>
                <div class="stat-desc">üèÜ Giorno Top</div>
            </div>
        </div>
        
        <!-- Dettaglio ultimi 7 giorni -->
        <div id="stats-weekly-chart" style="margin-top:15px; display:none;">
            <div class="weekly-bars" id="weekly-bars"></div>
        </div>
        
        <!-- Statistiche totali -->
        <div id="stats-sempre" style="display:none;">
            <div class="stats-grid-home">
                <div class="stat-box">
                    <div class="stat-number" id="stat-totale-partite">0</div>
                    <div class="stat-desc">Partite Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-giorni-attivi">0</div>
                    <div class="stat-desc">Giorni Attivi</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-streak">0</div>
                    <div class="stat-desc">üî• Streak Attuale</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-best-streak">0</div>
                    <div class="stat-desc">‚ö° Best Streak</div>
                </div>
            </div>
        </div>
    </div>
</div>

        <div class="box">
            <h3>üìú Storico Partite</h3>
            <div id="lista-storico"></div>
        </div>
        
        <button onclick="logout()" style="background:#444; width:100%; margin-top:20px;">ESCI (LOGOUT)</button>
    </div>
</div>

<!-- MODALE OPZIONI SFIDA -->
<div id="modal-sfida-ruzzle" class="modal">
	<div class="modal-content" style="text-align:center;">
		 <h2 id="target-name">Nuova Sfida</h2>
		 <div style="margin-bottom: 20px;">
			  <label>Durata:</label>
			  <select id="opt-tempo">
					<option value="45">45s</option><option value="60" selected>60s</option>
					<option value="90">90s</option><option value="180">180s</option>><option value="300">300s</option>
			  </select>
		 </div>
		 <div style="margin-bottom: 20px;">
			  <label>Dimensione Griglia:</label>
			  <select id="opt-griglia"><option value="4" selected>4x4</option><option value="5">5x5</option><option value="6">6x6</option><option value="7">7x7</option><option value="10">10x10</option></select>
		 </div>
		 <p>Scegli la modalit√† per il gruppo:</p>
		 <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
				<button onclick="creaPartitaMultipla(false, false, false)" style="background:#7f8c8d; flex:1;">CLASSICA</button>
				<button onclick="creaPartitaMultipla(true, false, false)" style="background:#e67e22; flex:1;">BONUS ‚≠ê</button>
				<button onclick="creaPartitaMultipla(true, true, false)" style="background:#9b59b6; flex:1;">CRAZY ü§™</button>
				<button onclick="creaPartitaMultipla(true, true, true)" style="background:#ff00ff; flex:1;">BIATCH üíÖ</button>
		 </div>
		 <button onclick="closeModal()" style="background:none; color:#777; margin-top:15px;">Annulla</button>
	</div>
</div>

<script>
    // --- 1. CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let mioNome = localStorage.getItem('mioNome') || "";
    let miaPass = localStorage.getItem('miaPass') || "";
    let amiciSelezionati = new Set();
    let giocoSelezionato = "ruzzle";

    // Esegui accesso automatico se i dati esistono
    if(mioNome && miaPass) {
        window.onload = () => {
            document.getElementById('username').value = mioNome;
            document.getElementById('password').value = miaPass;
            entra(true);
        };
    }

    async function entra(isAuto = false) {
        const n = document.getElementById('username').value.trim().toUpperCase();
        const p = document.getElementById('password').value.trim();
        if(n.length < 2 || p.length < 3) return;

        const userRef = db.collection("utenti").doc(n);
        try {
            const doc = await userRef.get();
            if(doc.exists) {
                if(doc.data().password !== p) { 
                    if(!isAuto) alert("Password Errata!"); 
                    return; 
                }
            } else {
                if(confirm("Nuovo utente? Registrati con questa password.")) {
                    await userRef.set({ nome: n, password: p });
                } else return;
            }

            mioNome = n;
            localStorage.setItem('mioNome', n);
            localStorage.setItem('miaPass', p);
            
            document.getElementById('login-div').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-display').textContent = "üë§ " + mioNome;

            aggiornaPresenza(); 
            setInterval(aggiornaPresenza, 20000);
            listen();
            caricaStorico();
        } catch (e) {
            console.error("Errore login:", e);
        }
    }

    function aggiornaPresenza() { 
        db.collection("presenze").doc(mioNome).set({ nome: mioNome, last: Date.now() }); 
    }

    function mostraNotifica(testo, colore, callback) {
        const div = document.createElement('div');
        div.style = `position:fixed; top:20px; left:50%; transform:translateX(-50%); background:${colore}; color:white; padding:25px; border-radius:12px; z-index:5000; font-weight:bold; box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; border:3px solid white;`;
        div.innerHTML = `<p style="margin:0 0 15px 0; font-size:1.3rem;">${testo}</p>
                         <button style="background:white; color:black; padding:10px 25px; border-radius:5px; font-weight:900; cursor:pointer;" onclick="this.parentElement.remove(); callback();">ACCETTA</button>
                         <button style="background:none; color:white; margin-left:15px; border:none; cursor:pointer; text-decoration:underline;" onclick="this.parentElement.remove();">CHIUDI</button>`;
        document.body.appendChild(div);
    }

    function listen() {
        // ASCOLTO AMICI E STATO ONLINE
        // Usiamo un doppio ascolto: uno per le amicizie e uno per le presenze globali
        db.collection("presenze").onSnapshot(presSnap => {
            let utentiOnline = {};
            presSnap.forEach(doc => {
                const u = doc.data();
                // Un utente √® considerato online se l'ultimo "battito" √® di meno di 60 secondi fa
                if (u.last > Date.now() - 60000) {
                    utentiOnline[u.nome] = true;
                }
            });

            db.collection("amicizie").onSnapshot(snap => {
                const div = document.getElementById('lista-amici'); 
                div.innerHTML = "";
                let amiciSet = new Set();

                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // Gestione Richieste in arrivo (Box Viola)
                    if (d.a === mioNome && d.stato === 'pendente') {
                        div.innerHTML += `<div class="user-item" style="background:#3700b3; color:white;">
                            <span>ü§ù Richiesta Amicizia: ${d.da}</span>
                            <button onclick="db.collection('amicizie').doc('${doc.id}').update({stato:'amici'})">ACCETTA</button>
                        </div>`;
                    }
                    
                    // Gestione Lista Amici
                    let nomeAmico = (d.da === mioNome) ? d.a : (d.a === mioNome ? d.da : null);
                    if(nomeAmico && d.stato === 'amici') {
                        amiciSet.add(nomeAmico);
                        const isSel = amiciSelezionati.has(nomeAmico);
                        const isOnline = utentiOnline[nomeAmico]; // <--- CONTROLLO PALLINO

                        div.innerHTML += `
                            <div class="user-item ${isSel?'selected':''}" onclick="toggleAmico('${nomeAmico}', this)">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="height:10px; width:100px; width:10px; background:${isOnline ? '#2ecc71' : '#555'}; border-radius:50%; display:inline-block; box-shadow: ${isOnline ? '0 0 8px #2ecc71' : 'none'};"></span>
                                    <span style="font-weight:bold;">${nomeAmico}</span>
                                </div>
                                <button class="btn-del" onclick="event.stopPropagation(); if(confirm('Rimuovere amico?')) db.collection('amicizie').doc('${doc.id}').delete()">X</button>
                            </div>`;
                    }
                });
                updateGlobal(amiciSet);
            });
        });

        // ASCOLTO PARTITE (Resta invariato)
        db.collection("partite").where("partecipanti", "array-contains", mioNome).onSnapshot(snap => {
            const div = document.getElementById('lista-partite'); 
            div.innerHTML = `<div class="user-item" style="background:#34495e;" onclick="window.location.href='ruzzle.html'"><span>Allenamento Solo (Ruzzle)</span><button>GIOCA</button></div>`;
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                if(p.stato === "attesa" && p.partecipanti[0] !== mioNome) {
                    div.innerHTML += `<div class="user-item" style="background:#f1c40f; color:black;">
                        <span>‚öîÔ∏è SFIDA A ${p.gioco.toUpperCase()} DA ${p.partecipanti[0]}</span>
                        <button onclick="window.location.href='${p.gioco}.html?matchId=${doc.id}'">ACCETTA</button>
                    </div>`;
                } else {
                    let altri = p.partecipanti.filter(n => n !== mioNome).join(", ");
                    div.innerHTML += `
                        <div class="user-item live-match">
                            <span>vs ${altri} (${p.gioco})</span>
                            <div>
                                <button onclick="window.location.href='${p.gioco}.html?matchId=${doc.id}'" style="background:#03dac6; color:#000;">ENTRA</button>
                                <button onclick="if(confirm('Eliminare partita?')) db.collection('partite').doc('${doc.id}').delete()" style="background:#cf6679; margin-left:5px;">üóëÔ∏è</button>
                            </div>
                        </div>`;
                }
            });
        });
    }

    function updateGlobal(amiciSet) {
        db.collection("presenze").get().then(snap => {
            const div = document.getElementById('lista-global'); 
            div.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                // Mostra solo utenti diversi da me, non amici, ed entrati di recente (1 ora)
                if(u.nome !== mioNome && !amiciSet.has(u.nome) && u.last > Date.now() - 3600000) {
                    div.innerHTML += `<div class="user-item">
                        <span>${u.nome}</span>
                        <button onclick="addFriend('${u.nome}')">+AMICO</button>
                    </div>`;
                }
            });
        });
    }

    function toggleAmico(nome, el) {
        if(amiciSelezionati.has(nome)) amiciSelezionati.delete(nome); else amiciSelezionati.add(nome);
        const btn = document.getElementById('btn-sfida-multipla');
        btn.style.display = amiciSelezionati.size > 0 ? 'block' : 'none';
        btn.textContent = `SFIDA ${amiciSelezionati.size} AMICI ‚öîÔ∏è`;
        el.classList.toggle('selected');
    }

    function selezionaGioco(g, el) { 
        giocoSelezionato = g; 
        document.querySelectorAll('.game-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }

    function apriModalSfida() { document.getElementById('modal-sfida-ruzzle').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-sfida-ruzzle').style.display = 'none'; }

    async function creaPartitaMultipla(bonus, crazy, biatch) {
        let mode = crazy ? 'crazy' : (biatch ? 'biatch' : (bonus ? 'bonus' : 'classic'));
        const partecipanti = [mioNome, ...Array.from(amiciSelezionati)];
        let pIniziali = {}; let paroleIniziali = {}; partecipanti.forEach(p => { pIniziali[p]=0; paroleIniziali[p]=[]; });
        
        const doc = await db.collection("partite").add({
            gioco: giocoSelezionato, partecipanti: partecipanti, punteggi: pIniziali, parole: paroleIniziali, pronti: [], finito: [], confermaVerifica: [], stato: "attesa",
            dataOra: new Date().toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}), timestamp: Date.now(),
            opzioni: { 
                tempo: document.getElementById('opt-tempo').value, 
                griglia: document.getElementById('opt-griglia').value, 
                mode: mode, 
                seed: Math.random().toString(36).substring(7).toUpperCase() 
            }
        });
        window.location.href = `${giocoSelezionato}.html?matchId=${doc.id}`;
    }

    function caricaStorico() {
        // Carico le partite e le ordino in JavaScript (evita errore indici Firebase)
        db.collection("partite").where("partecipanti", "array-contains", mioNome).where("stato","==","conclusa").onSnapshot(snap => {
            const div = document.getElementById('lista-storico'); 
            div.innerHTML = "";
            let partite = [];
            snap.forEach(doc => partite.push(doc.data()));
            
            // Ordinamento JS per tempo decrescente
            partite.sort((a,b) => b.timestamp - a.timestamp);

            partite.slice(0, 10).forEach(p => {
                let classif = Object.entries(p.punteggi).sort((a,b)=>b[1]-a[1]);
                let vincitore = classif[0][0];
                div.innerHTML += `<div class="history-item">
                    <span>${p.dataOra} - ${p.gioco.toUpperCase()}</span>
                    <span>Vinto da: <b>${vincitore}</b></span>
                </div>`;
            });
        });
    }

    function addFriend(n) { 
        db.collection("amicizie").doc(mioNome+"_"+n).set({da:mioNome, a:n, stato:'pendente'}); 
        alert("Richiesta inviata!"); 
    }
    
    function logout() { localStorage.clear(); window.location.reload(); }
	 
	 // ==========================================
// üìä SISTEMA STATISTICHE GIORNALIERE
// ==========================================

const STATS_KEY = 'funatwork_daily_stats';

// Funzione per ottenere la data in formato YYYY-MM-DD
function getTodayKey() {
    return new Date().toISOString().split('T')[0];
}

// Funzione per ottenere le statistiche salvate
function getDailyStats() {
    const saved = localStorage.getItem(STATS_KEY);
    return saved ? JSON.parse(saved) : { days: {}, totals: {} };
}

// Funzione per salvare le statistiche
function saveDailyStats(stats) {
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
}

// üéÆ REGISTRA UNA PARTITA (da chiamare quando finisce una partita)
function registraPartita(gioco) {
    const stats = getDailyStats();
    const oggi = getTodayKey();
    
    // Inizializza il giorno se non esiste
    if (!stats.days[oggi]) {
        stats.days[oggi] = {};
    }
    
    // Incrementa contatore giornaliero per questo gioco
    stats.days[oggi][gioco] = (stats.days[oggi][gioco] || 0) + 1;
    
    // Incrementa totale per questo gioco
    stats.totals[gioco] = (stats.totals[gioco] || 0) + 1;
    
    saveDailyStats(stats);
    
    // Aggiorna UI se siamo nella homepage
    if (typeof aggiornaStatsUI === 'function') {
        aggiornaStatsUI();
    }
    
    console.log(`üìä Partita registrata: ${gioco} (${stats.days[oggi][gioco]} oggi)`);
}

// Calcola statistiche
function calcolaStatistiche() {
    const stats = getDailyStats();
    const oggi = getTodayKey();
    const giorni = Object.keys(stats.days).sort();
    
    // Partite oggi
    const partiteOggi = stats.days[oggi] || {};
    const totaleOggi = Object.values(partiteOggi).reduce((a, b) => a + b, 0);
    
    // Partite per gioco oggi
    const ruzzleOggi = partiteOggi.ruzzle || 0;
    
    // Media giornaliera
    const giorniAttivi = giorni.length;
    const partiteTotali = Object.values(stats.totals).reduce((a, b) => a + b, 0);
    const media = giorniAttivi > 0 ? (partiteTotali / giorniAttivi).toFixed(1) : 0;
    
    // Giorno top
    let giornoTop = '-';
    let maxPartite = 0;
    giorni.forEach(giorno => {
        const tot = Object.values(stats.days[giorno]).reduce((a, b) => a + b, 0);
        if (tot > maxPartite) {
            maxPartite = tot;
            // Formatta data
            const d = new Date(giorno);
            giornoTop = `${d.getDate()}/${d.getMonth() + 1}`;
        }
    });
    if (maxPartite > 0) {
        giornoTop += ` (${maxPartite})`;
    }
    
    // Streak (giorni consecutivi)
    let streak = 0;
    let bestStreak = 0;
    let currentStreak = 0;
    
    // Ordina i giorni e calcola streak
    const sortedDays = [...giorni].sort().reverse();
    
    // Verifica se oggi o ieri abbiamo giocato
    const ieri = new Date();
    ieri.setDate(ieri.getDate() - 1);
    const ieriKey = ieri.toISOString().split('T')[0];
    
    if (stats.days[oggi]) {
        currentStreak = 1;
        let checkDate = new Date(oggi);
        
        while (true) {
            checkDate.setDate(checkDate.getDate() - 1);
            const checkKey = checkDate.toISOString().split('T')[0];
            if (stats.days[checkKey]) {
                currentStreak++;
            } else {
                break;
            }
        }
    } else if (stats.days[ieriKey]) {
        // Se oggi non abbiamo giocato, la streak √® a rischio!
        currentStreak = 0; // Streak interrotta
    }
    
    streak = currentStreak;
    
    // Best streak (calcolo completo)
    let tempStreak = 0;
    for (let i = 0; i < sortedDays.length; i++) {
        const currentDay = new Date(sortedDays[i]);
        const prevDay = i > 0 ? new Date(sortedDays[i - 1]) : null;
        
        if (!prevDay) {
            tempStreak = 1;
        } else {
            const diff = (prevDay - currentDay) / (1000 * 60 * 60 * 24);
            if (diff === 1) {
                tempStreak++;
            } else {
                if (tempStreak > bestStreak) bestStreak = tempStreak;
                tempStreak = 1;
            }
        }
    }
    if (tempStreak > bestStreak) bestStreak = tempStreak;
    
    // Ultimi 7 giorni
    const ultimi7Giorni = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        const dayName = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'][d.getDay()];
        const count = stats.days[key] ? Object.values(stats.days[key]).reduce((a, b) => a + b, 0) : 0;
        ultimi7Giorni.push({
            key,
            dayName,
            count,
            isToday: key === oggi
        });
    }
    
    return {
        totaleOggi,
        ruzzleOggi,
        media,
        giornoTop,
        partiteTotali,
        giorniAttivi,
        streak,
        bestStreak,
        ultimi7Giorni,
        totals: stats.totals
    };
}

// Aggiorna l'interfaccia delle statistiche
function aggiornaStatsUI() {
    const s = calcolaStatistiche();
    
    // Valori oggi
    const elOggiTotale = document.getElementById('stat-oggi-totale');
    const elOggiRuzzle = document.getElementById('stat-oggi-ruzzle');
    const elMedia = document.getElementById('stat-media');
    const elTopDay = document.getElementById('stat-top-day');
    
    if (elOggiTotale) elOggiTotale.textContent = s.totaleOggi;
    if (elOggiRuzzle) elOggiRuzzle.textContent = s.ruzzleOggi;
    if (elMedia) elMedia.textContent = s.media;
    if (elTopDay) elTopDay.textContent = s.giornoTop;
    
    // Valori totali
    const elTotalePartite = document.getElementById('stat-totale-partite');
    const elGiorniAttivi = document.getElementById('stat-giorni-attivi');
    const elStreak = document.getElementById('stat-streak');
    const elBestStreak = document.getElementById('stat-best-streak');
    
    if (elTotalePartite) elTotalePartite.textContent = s.partiteTotali;
    if (elGiorniAttivi) elGiorniAttivi.textContent = s.giorniAttivi;
    if (elStreak) elStreak.textContent = s.streak + ' üî•';
    if (elBestStreak) elBestStreak.textContent = s.bestStreak;
    
    // Grafico settimanale
    renderWeeklyChart(s.ultimi7Giorni);
}

// Renderizza il grafico settimanale
function renderWeeklyChart(data) {
    const container = document.getElementById('weekly-bars');
    if (!container) return;
    
    const maxCount = Math.max(...data.map(d => d.count), 1);
    
    container.innerHTML = data.map(day => {
        const heightPercent = (day.count / maxCount) * 100;
        const barClass = day.isToday ? 'bar today' : 'bar';
        
        return `
            <div class="day-bar">
                <div class="count">${day.count}</div>
                <div class="${barClass}" style="height: ${Math.max(heightPercent, 5)}%;"></div>
                <div class="label">${day.dayName}</div>
            </div>
        `;
    }).join('');
}

// Gestione tab statistiche
function showStatsTab(tab) {
    // Aggiorna tab attivo
    document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Mostra/nascondi contenuti
    const statsOggi = document.querySelector('.stats-grid-home');
    const statsSempre = document.getElementById('stats-sempre');
    const statsWeekly = document.getElementById('stats-weekly-chart');
    
    if (tab === 'oggi') {
        if (statsOggi) statsOggi.style.display = 'grid';
        if (statsSempre) statsSempre.style.display = 'none';
        if (statsWeekly) statsWeekly.style.display = 'none';
    } else if (tab === 'settimana') {
        if (statsOggi) statsOggi.style.display = 'none';
        if (statsSempre) statsSempre.style.display = 'none';
        if (statsWeekly) statsWeekly.style.display = 'block';
    } else if (tab === 'sempre') {
        if (statsOggi) statsOggi.style.display = 'none';
        if (statsSempre) statsSempre.style.display = 'block';
        if (statsWeekly) statsWeekly.style.display = 'none';
    }
}

// Carica statistiche all'avvio
document.addEventListener('DOMContentLoaded', () => {
    aggiornaStatsUI();
});

// Aggiorna ogni minuto (per aggiornare "oggi" se cambia giorno)
setInterval(aggiornaStatsUI, 60000);
	 
</script>
</body>
</html>

