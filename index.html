<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portale FaW</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: auto; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        h1, h3 { color: #03dac6; margin-top: 0; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #2c2c2c; color: white; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .user-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .user-item:hover { border-color: #444; }
        .user-item.selected { background: #03dac6 !important; color: #000; border-color: white; }
        
        .btn-sfida-multi { background: #f1c40f; color: #000; width: 100%; height: 50px; font-size: 1.1rem; margin-bottom: 15px; display: none; }
        .btn-del { background: #cf6679; color: white; padding: 5px 10px; font-size: 0.8rem; }
        
        .live-match { border-left: 5px solid #f1c40f; }
        .history-item { font-size: 0.85rem; border-bottom: 1px solid #333; padding: 8px 0; display: flex; justify-content: space-between; }
        
        #user-display { background: #03dac6; color: #000; padding: 5px 15px; border-radius: 20px; display: inline-block; font-weight: bold; margin-bottom: 20px; }
                
        .game-card { 
            min-width: 100px; padding: 15px; background: #252525; border-radius: 10px; 
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s;
        }
        .game-card.selected { border-color: #03dac6; background: #1a3a3a; opacity: 1 !important; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 2px solid #333; }
    </style>
</head>
<body>

<div class="container">
    
    <!-- LOGIN -->
    <div id="login-div" class="box">
        <h1>Login dei üê∑</h1>
        <input type="text" id="username" placeholder="IL TUO NOME">
        <input type="password" id="password" placeholder="PASSWORD">
        <button onclick="entra()" style="background:#03dac6; width:100%; height:50px; color:#000;">ENTRA / REGISTRATI</button>
    </div>

    <!-- DASHBOARD -->
    <div id="main-app" style="display:none;">
        <div id="user-display"></div>
        
        <div class="box">
            <h3>üéÆ Partite In Corso</h3>
            <div id="lista-partite"></div>
        </div>
        <div class="box">
            <h3>üéÆ Scegli il Gioco</h3>
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                <div class="game-card selected" onclick="selezionaGioco('ruzzle', this)" id="game-ruzzle">
                    <span style="font-size:2rem;">üê∑</span><br>Ruzzle
                </div>
                <div class="game-card" onclick="selezionaGioco('tris', this)" id="game-tris" style="opacity:0.5;">
                    <span style="font-size:2rem;">‚ùå</span><br>(Prossimamente)
                </div>
                <!-- Aggiungerai qui i futuri giochi -->
            </div>
        </div>
        <div class="box">
            <h3>‚≠ê I tuoi Amici</h3>
            <p style="font-size:0.8rem; opacity:0.6;">Clicca sui nomi per selezionare pi√π amici e sfidarli insieme!</p>
            <button id="btn-sfida-multipla" class="btn-sfida-multi" onclick="apriModalSfida()">SFIDA IL GRUPPO ‚öîÔ∏è</button>
            <div id="lista-amici"></div>
        </div>

        <div class="box">
            <h3>üåç Altri Colleghi Online</h3>
            <div id="lista-global"></div>
        </div>

        <div class="box">
            <h3>üìú Storico Partite</h3>
            <div id="lista-storico"></div>
        </div>
        
        <button onclick="logout()" style="background:#444; width:100%; margin-top:20px;">ESCI (LOGOUT)</button>
    </div>
</div>

<!-- MODALE OPZIONI SFIDA -->
<div id="modal-sfida" class="modal">
    <div class="modal-content">
        <h2 id="sfida-title">Impostazioni Sfida</h2>
        <label>Tempo:</label>
        <select id="opt-tempo">
            <option value="45">45s (Fulmine ‚ö°)</option>
            <option value="60">60s (Blitz)</option>
            <option value="90">90s (Veloce)</option>
            <option value="180" selected>180s (Standard)</option>
            <option value="300">300s (Relax)</option>
        </select>
        <label>Griglia:</label>
        <select id="opt-griglia">
            <option value="4">4x4</option>
            <option value="5" selected>5x5</option>
            <option value="6">6x6</option>
            <option value="10">10x10</option>
        </select>
        <label>Modalit√†:</label>
        <select id="opt-mode">
            <option value="classic">Classica</option>
            <option value="bonus">Bonus ‚≠ê</option>
            <option value="crazy" selected>Crazy ü§™</option>
            <option value="biatch">BIATCH üíÖ</option>
        </select>
        <button onclick="creaPartitaMultipla()" style="background:#03dac6; width:100%; height:50px; color:#000;">VAI! üöÄ</button>
        <button onclick="closeModal()" style="background:none; color:#777; width:100%; margin-top:10px;">Annulla</button>
    </div>
</div>

<script>
        const firebaseConfig = {
        apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
        authDomain: "funatwork-cd237.firebaseapp.com",
        projectId: "funatwork-cd237",
        storageBucket: "funatwork-cd237.firebasestorage.app",
        messagingSenderId: "798226885203",
        appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let mioNome = localStorage.getItem('mioNome') || "";
    let miaPass = localStorage.getItem('miaPass') || "";
    let amiciSelezionati = new Set();
    let giocoSelezionato = "ruzzle"; // Default

    if(mioNome && miaPass) {
        window.onload = () => {
            document.getElementById('username').value = mioNome;
            document.getElementById('password').value = miaPass;
            entra(true);
        };
    }

    async function entra(isAuto = false) {
        const n = document.getElementById('username').value.trim().toUpperCase();
        const p = document.getElementById('password').value.trim();
        if(n.length < 2 || p.length < 3) return;
        const userRef = db.collection("utenti").doc(n);
        const doc = await userRef.get();
        if(doc.exists) {
            if(doc.data().password !== p) { if(!isAuto) alert("Password Errata!"); return; }
        } else {
            if(confirm("Nuovo utente? Registrati con questa password.")) { await userRef.set({ nome: n, password: p }); } else return;
        }
        mioNome = n;
        localStorage.setItem('mioNome', n);
        localStorage.setItem('miaPass', p);
        document.getElementById('login-div').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-display').textContent = "üë§ " + mioNome;
        aggiornaPresenza(); setInterval(aggiornaPresenza, 20000);
        listen();
        caricaStorico();
    }

    function aggiornaPresenza() { db.collection("presenze").doc(mioNome).set({ nome: mioNome, last: Date.now() }); }

    function mostraNotifica(testo, colore, callback) {
        const div = document.createElement('div');
        div.style = `position:fixed; top:10px; left:50%; transform:translateX(-50%); background:${colore}; color:white; padding:20px; border-radius:10px; z-index:2000; font-weight:bold; box-shadow:0 0 20px rgba(0,0,0,0.5); text-align:center; min-width:300px; border:3px solid white;`;
        div.innerHTML = `<p style="margin:0 0 10px 0; font-size:1.2rem;">${testo}</p>
                         <button id="notif-ok" style="background:white; color:black; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">ACCETTA</button>
                         <button id="notif-no" style="background:rgba(0,0,0,0.2); color:white; border:none; padding:10px 20px; border-radius:5px; margin-left:10px; cursor:pointer;">CHIUDI</button>`;
        document.body.appendChild(div);
        div.querySelector('#notif-ok').onclick = () => { callback(); div.remove(); };
        div.querySelector('#notif-no').onclick = () => { div.remove(); };
    }

    function listen() {
        // ASCOLTO AMICI E RICHIESTE
        db.collection("amicizie").onSnapshot(snap => {
            const div = document.getElementById('lista-amici'); div.innerHTML = "";
            let amiciNomi = new Set();
            snap.docChanges().forEach(change => {
                const d = change.doc.data();
                // Nel listener delle partite, quando scatta l'added:
                if (change.type === "added" && p.stato === "attesa" && p.partecipanti[0] !== mioNome) {
                    mostraNotifica(`‚öîÔ∏è SFIDA A ${p.gioco.toUpperCase()} DA: ${p.partecipanti[0]}`, "#f1c40f", () => { 
                        // Ti manda automaticamente al file HTML corretto
                        window.location.href = `${p.gioco}.html?matchId=${change.doc.id}`; 
                    });
                }
            });
            snap.forEach(doc => {
                const d = doc.data();
                let amico = (d.da === mioNome) ? d.a : (d.a === mioNome ? d.da : null);
                if(amico && d.stato === 'amici') {
                    amiciNomi.add(amico);
                    div.innerHTML += `<div class="user-item ${amiciSelezionati.has(amico)?'selected':''}" onclick="toggleAmico('${amico}', this)"><span>‚≠ê ${amico}</span><button class="btn-del" onclick="event.stopPropagation(); rimozioneAmico('${doc.id}')">X</button></div>`;
                }
            });
            updateGlobal(amiciNomi);
        });

        // ASCOLTO SFIDE
        db.collection("partite").where("partecipanti", "array-contains", mioNome).onSnapshot(snap => {
            const div = document.getElementById('lista-partite'); div.innerHTML = "";
            div.innerHTML = `<div class="user-item" style="background:#34495e;" onclick="window.location.href='ruzzle.html'"><span>Allenamento Solo</span><button>GIOCA</button></div>`;
            snap.docChanges().forEach(change => {
                const p = change.doc.data();
                if (change.type === "added" && p.stato === "attesa" && p.partecipanti[0] !== mioNome) {
                    mostraNotifica(`‚öîÔ∏è SFIDA DA: ${p.partecipanti[0]}`, "#f1c40f", () => { window.location.href=`ruzzle.html?matchId=${change.doc.id}`; });
                }
            });
            snap.forEach(doc => {
                const p = doc.data();
                if(p.stato === "conclusa") return;
                let altri = p.partecipanti.filter(n => n !== mioNome).join(", ");
                div.innerHTML += `<div class="user-item live-match"><span>vs ${altri} (${p.dataOra})</span><div><button onclick="window.location.href='ruzzle.html?matchId=${doc.id}'" style="background:#03dac6; color:#000;">ENTRA</button><button onclick="db.collection('partite').doc('${doc.id}').delete()" style="background:#cf6679; margin-left:5px;">üóëÔ∏è</button></div></div>`;
            });
        });
    }

    function toggleAmico(nome, el) {
        if(amiciSelezionati.has(nome)) amiciSelezionati.delete(nome); else amiciSelezionati.add(nome);
        const btn = document.getElementById('btn-sfida-multipla');
        btn.style.display = amiciSelezionati.size > 0 ? 'block' : 'none';
        btn.textContent = `SFIDA ${amiciSelezionati.size} AMICI ‚öîÔ∏è`;
        el.classList.toggle('selected');
    }

    function updateGlobal(amiciSet) {
        db.collection("presenze").get().then(snap => {
            const div = document.getElementById('lista-global'); div.innerHTML = "";
            snap.forEach(doc => { if(doc.id !== mioNome && !amiciSet.has(doc.id)) div.innerHTML += `<div class="user-item"><span>${doc.id}</span><button onclick="addFriend('${doc.id}')">+AMICO</button></div>`; });
        });
    }

    function apriModalSfida() { document.getElementById('modal-sfida').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-sfida').style.display = 'none'; }

    function selezionaGioco(id, el) {
        giocoSelezionato = id;
        // Rimuove la selezione visiva dagli altri e la mette a questo
        document.querySelectorAll('.game-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        
        // In futuro potrai mostrare/nascondere opzioni diverse nel modale 
        // (es: per il Tris non serve la dimensione griglia o il dizionario)
    }
    
    async function creaPartitaMultipla() {
        const ora = new Date().toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
        const partecipanti = [mioNome, ...Array.from(amiciSelezionati)];
        
        let pIniziali = {}; let paroleIniziali = {}; 
        partecipanti.forEach(p => { pIniziali[p] = 0; paroleIniziali[p] = []; });
    
        const doc = await db.collection("partite").add({
            gioco: giocoSelezionato, // <--- FONDAMENTALE: Salva quale gioco √® stato scelto
            partecipanti: partecipanti,
            punteggi: pIniziali,
            parole: paroleIniziali,
            pronti: [], finito: [], confermaVerifica: [],
            stato: "attesa",
            dataOra: ora,
            timestamp: Date.now(),
            opzioni: {
                tempo: document.getElementById('opt-tempo').value,
                griglia: document.getElementById('opt-griglia').value,
                mode: document.getElementById('opt-mode').value,
                seed: Math.random().toString(36).substring(7).toUpperCase()
            }
        });
        
        // Ti manda al file specifico del gioco scelto
        window.location.href = `${giocoSelezionato}.html?matchId=${doc.id}`;
    }

    function caricaStorico() {
        db.collection("partite")
          .where("partecipanti", "array-contains", mioNome)
          .where("stato","==","conclusa")
          .orderBy("timestamp", "desc").limit(15) // <--- CRONOLOGICO DECRESCENTE
          .onSnapshot(snap => {
            const div = document.getElementById('lista-storico'); div.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                let classif = Object.entries(p.punteggi).sort((a,b)=>b[1]-a[1]);
                div.innerHTML += `<div class="history-item"><span>${p.dataOra} - vs ${p.partecipanti.length-1} amici</span><span>Vinto da: <b>${classif[0][0]}</b></span></div>`;
            });
        });
    }

    function addFriend(n) { db.collection("amicizie").doc(mioNome+"_"+n).set({da:mioNome, a:n, stato:'pendente'}); alert("Richiesta inviata!"); }
    function rimozioneAmico(id) { if(confirm("Eliminare?")) db.collection("amicizie").doc(id).delete(); }
    function logout() { localStorage.clear(); window.location.reload(); }
</script>
</body>
</html>








