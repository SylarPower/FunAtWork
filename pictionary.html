<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pictionary dei üê∑</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #eee;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========================================
           üé® BARRA SUPERIORE FISSA
        ======================================== */
        .game-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 99999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
            background: linear-gradient(135deg, #e94560 0%, #d63447 100%);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .game-banner .banner-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .game-banner .banner-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-banner {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.2s;
            background: white;
            color: #333;
        }

        .btn-banner:hover {
            transform: scale(1.05);
        }

        .btn-banner.btn-danger {
            background: #cf6679;
            color: white;
        }

        .btn-banner.btn-primary {
            background: #03dac6;
            color: #000;
        }

        /* ========================================
           üé® CANVAS E LAYOUT
        ======================================== */
        .main-container {
            margin-top: 80px;
            padding: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .drawing-area {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #drawing-canvas {
            width: 100%;
            max-width: 800px;
            height: 500px;
            background: white;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            touch-action: none;
        }

        .tools-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.2);
        }

        .tool-btn {
            padding: 10px 20px;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            color: #eee;
            cursor: pointer;
            font-weight: 500;
        }

        .tool-btn:hover {
            background: #3c3c3c;
        }

        /* ========================================
           üìã LOBBY
        ======================================== */
        #lobby-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .lobby-card {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            border: 2px solid #e94560;
        }

        .player-list {
            margin: 20px 0;
            padding: 0;
            list-style: none;
        }

        .player-item {
            background: #2c2c2c;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ready-badge {
            background: #2ecc71;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* ========================================
           üñºÔ∏è MODALE RIFERIMENTO
        ======================================== */
        #reference-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100001;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .reference-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .reference-content img {
            max-width: 100%;
            max-height: 80vh;
            border: 5px solid #03dac6;
            border-radius: 10px;
            display: block;
        }

        .ref-info {
            text-align: center;
            color: white;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        .close-ref {
            position: absolute;
            top: -15px;
            right: -15px;
            background: #cf6679;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* ========================================
           ‚≠ê GALLERIA VOTAZIONE
        ======================================== */
        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chain-card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #333;
        }

        .chain-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #03dac6;
            margin-bottom: 15px;
            text-align: center;
        }

        .drawing-sequence {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .drawing-step {
            background: #2c2c2c;
            padding: 10px;
            border-radius: 8px;
        }

        .drawing-step img {
            width: 100%;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .drawing-step img:hover {
            transform: scale(1.05);
        }

        .drawing-info {
            font-size: 0.85rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        .vote-section {
            margin-top: 15px;
            text-align: center;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .star {
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
            filter: grayscale(100%);
        }

        .star.active {
            filter: grayscale(0%);
            transform: scale(1.2);
        }

        /* ========================================
           üì± RESPONSIVE
        ======================================== */
        @media (max-width: 600px) {
            .game-banner {
                flex-direction: column;
                padding: 10px;
            }

            #drawing-canvas {
                height: 400px;
            }

            .main-container {
                margin-top: 120px;
                padding: 10px;
            }
        }

        /* ========================================
           üéØ UTILITY
        ======================================== */
        .hidden {
            display: none !important;
        }

        #timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f1c40f;
        }

        .theme-label {
            font-size: 1.8rem;
            font-weight: bold;
            color: #03dac6;
            background: rgba(3, 218, 198, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        #mini-reference {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            background: white;
            border: 3px solid #03dac6;
            border-radius: 10px;
            cursor: pointer;
            z-index: 9998;
            display: none;
            overflow: hidden;
        }

        #mini-reference img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #mini-reference:hover {
            transform: scale(1.05);
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100002;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ========================================
         üìã LOBBY INIZIALE
    ======================================== -->
    <div id="lobby-screen">
        <div class="lobby-card">
            <h1 style="color: #e94560; margin: 0 0 10px 0;">üé® PICTIONARY</h1>
            <div id="lobby-code" style="font-size: 1.5rem; color: #03dac6; font-weight: bold; margin-bottom: 20px;"></div>
            
            <div id="lobby-info">
                <p style="opacity: 0.8;">In attesa che tutti i giocatori siano pronti...</p>
                <ul class="player-list" id="player-list"></ul>
            </div>

            <div id="lobby-actions" style="margin-top: 30px;">
                <button id="btn-ready" class="btn-banner btn-primary" onclick="toggleReady()" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                    ‚úÖ SONO PRONTO
                </button>
                <button class="btn-banner btn-danger" onclick="leaveRoom()" style="width: 100%; margin-top: 10px;">
                    üö™ ESCI
                </button>
            </div>

            <div id="host-start" class="hidden" style="margin-top: 20px;">
                <button class="btn-banner" onclick="startGame()" style="width: 100%; padding: 15px; font-size: 1.1rem; background: #2ecc71; color: white;">
                    üöÄ INIZIA PARTITA
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
         üé® AREA DI GIOCO
    ======================================== -->
    <div class="game-banner hidden" id="game-banner">
        <div class="banner-left">
            <span id="phase-indicator">üé® Disegno</span>
            <span id="timer-display">60s</span>
        </div>
        <div class="banner-right">
            <button id="btn-submit" class="btn-banner btn-primary hidden" onclick="submitDrawing()">‚úÖ FATTO</button>
            <button id="btn-clear" class="btn-banner hidden" onclick="clearCanvas()">üóëÔ∏è Cancella</button>
            <button id="btn-show-ref" class="btn-banner hidden" onclick="showReferenceModal()">üîç Vedi Riferimento</button>
            <button class="btn-banner btn-danger" onclick="leaveRoom()">üö™ Esci</button>
        </div>
    </div>

    <div class="main-container hidden" id="main-game">
        <!-- Tema assegnato (solo fase iniziale) -->
        <div id="theme-container" class="hidden">
            <div class="theme-label">
                Disegna: <span id="assigned-theme"></span>
            </div>
        </div>

        <!-- Area disegno -->
        <div class="drawing-area">
            <canvas id="drawing-canvas" width="800" height="500"></canvas>
            
            <div class="tools-bar">
                <button class="color-btn active" data-color="#000000" style="background: #000000;"></button>
                <button class="color-btn" data-color="#e74c3c" style="background: #e74c3c;"></button>
                <button class="color-btn" data-color="#3498db" style="background: #3498db;"></button>
                <button class="color-btn" data-color="#2ecc71" style="background: #2ecc71;"></button>
                <button class="color-btn" data-color="#f1c40f" style="background: #f1c40f;"></button>
                <button class="color-btn" data-color="#9b59b6" style="background: #9b59b6;"></button>
                <button class="color-btn" data-color="#ffffff" style="background: #ffffff; border: 2px solid #333;"></button>
                
                <select id="brush-size" class="tool-btn" style="width: auto;">
                    <option value="2">Sottile</option>
                    <option value="5" selected>Medio</option>
                    <option value="10">Spesso</option>
                    <option value="20">Molto Spesso</option>
                </select>
            </div>
        </div>

        <!-- Miniatura riferimento (per ridisegno) -->
        <div id="mini-reference" onclick="showReferenceModal()"></div>

        <!-- Galleria votazione -->
        <div id="gallery-section" class="hidden">
            <h2 style="text-align: center; color: #e94560;">‚≠ê VOTAZIONE FINALE</h2>
            <p style="text-align: center; opacity: 0.8;">Vota le catene di disegni pi√π divertenti!</p>
            <div class="gallery-container" id="gallery-container"></div>
            <button class="btn-banner btn-primary" onclick="tornaHome()" style="width: 100%; max-width: 400px; margin: 30px auto; display: block; padding: 15px;">
                üè† TORNA ALLA HOME
            </button>
        </div>
    </div>

    <!-- ========================================
         üñºÔ∏è MODALE RIFERIMENTO INGRANDITO
    ======================================== -->
    <div id="reference-modal">
        <div class="reference-content">
            <button class="close-ref" onclick="closeReferenceModal()">‚úñ</button>
            <img id="reference-img" src="" alt="Riferimento">
            <div class="ref-info">
                üí° Ridisegna quello che vedi (senza sapere il tema originale)
            </div>
        </div>
    </div>

    <!-- ========================================
         ‚è≥ LOADING
    ======================================== -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div id="loading-text">Caricamento...</div>
    </div>

    <!-- ========================================
         üî• FIREBASE + LOGICA
    ======================================== -->
    <script>
        // ========================================
        // üîß CONFIGURAZIONE FIREBASE
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCNo7o2Ft22JDEyJ97BspE3Kur5DNAPKQc",
            authDomain: "funatwork-cd237.firebaseapp.com",
            projectId: "funatwork-cd237",
            storageBucket: "funatwork-cd237.firebasestorage.app",
            messagingSenderId: "798226885203",
            appId: "1:798226885203:web:ce83f4d9e96b82266274a6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========================================
        // üìä VARIABILI GLOBALI
        // ========================================
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        const playerName = localStorage.getItem('mioNome') || 'OSPITE';

        let roomData = null;
        let unsubscribe = null;
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = '#000000';
        let brushSize = 5;
        let timerInterval = null;
        let timeLeft = 60;

        // ========================================
        // üéØ TEMI DISPONIBILI
        // ========================================
        const THEMES = [
            "Gatto", "Casa", "Albero", "Sole", "Auto", "Pizza", "Telefono", "Libro",
            "Fiore", "Montagna", "Bicicletta", "Ombrello", "Chitarra", "Elefante",
            "Treno", "Cuore", "Stella", "Luna", "Occhiali", "Scarpa", "Cappello",
            "Pallone", "Pesce", "Aereo", "Nave", "Castello", "Robot", "Drago"
        ];

        // ========================================
        // üöÄ INIT
        // ========================================
        window.onload = () => {
            if (!roomCode) {
                alert('‚ùå Nessuna stanza specificata');
                window.location.href = 'index.html';
                return;
            }

            if (!playerName) {
                alert('‚ùå Devi effettuare il login');
                window.location.href = 'index.html';
                return;
            }

            initCanvas();
            setupColorPicker();
            listenToRoom();
        };

        // ========================================
        // üé® CANVAS SETUP
        // ========================================
        function initCanvas() {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            // Brush size
            document.getElementById('brush-size').addEventListener('change', (e) => {
                brushSize = parseInt(e.target.value);
            });
        }

        function setupColorPicker() {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentColor = btn.dataset.color;
                });
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function getCanvasDataURL() {
            return canvas.toDataURL('image/png');
        }

        // ========================================
        // üî• LISTENER ROOM
        // ========================================
        function listenToRoom() {
            unsubscribe = db.collection('pictionary_rooms').doc(roomCode).onSnapshot(doc => {
                if (!doc.exists) {
                    alert('‚ùå Stanza non trovata');
                    window.location.href = 'index.html';
                    return;
                }

                roomData = { id: doc.id, ...doc.data() };
                console.log('üì° Room update:', roomData);
                updateUI();
            });
        }

        // ========================================
        // üéØ AGGIORNA UI
        // ========================================
        function updateUI() {
            const stato = roomData.stato;

            if (stato === 'lobby') {
                showLobby();
            } else if (stato === 'drawing' || stato === 'interpreting') {
                showGame();
            } else if (stato === 'voting') {
                showVoting();
            } else if (stato === 'results') {
                showResults();
            }
        }

        // ========================================
        // üìã LOBBY
        // ========================================
        function showLobby() {
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('main-game').classList.add('hidden');
            document.getElementById('game-banner').classList.add('hidden');

            document.getElementById('lobby-code').textContent = `Codice: ${roomCode}`;

            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';

            roomData.players.forEach(p => {
                const isReady = roomData.ready.includes(p);
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `
                    <span>${p === roomData.host ? 'üëë ' : ''}${p}</span>
                    ${isReady ? '<span class="ready-badge">PRONTO</span>' : '<span style="opacity:0.5;">In attesa...</span>'}
                `;
                playerList.appendChild(li);
            });

            // Pulsante pronto
            const btnReady = document.getElementById('btn-ready');
            if (roomData.ready.includes(playerName)) {
                btnReady.textContent = '‚è≥ IN ATTESA...';
                btnReady.disabled = true;
                btnReady.style.opacity = '0.6';
            } else {
                btnReady.textContent = '‚úÖ SONO PRONTO';
                btnReady.disabled = false;
                btnReady.style.opacity = '1';
            }

            // Mostra pulsante start solo all'host se tutti sono pronti
            if (roomData.host === playerName && roomData.ready.length === roomData.players.length) {
                document.getElementById('host-start').classList.remove('hidden');
            } else {
                document.getElementById('host-start').classList.add('hidden');
            }
        }

        async function toggleReady() {
            const isReady = roomData.ready.includes(playerName);
            
            if (isReady) {
                await db.collection('pictionary_rooms').doc(roomCode).update({
                    ready: firebase.firestore.FieldValue.arrayRemove(playerName)
                });
            } else {
                await db.collection('pictionary_rooms').doc(roomCode).update({
                    ready: firebase.firestore.FieldValue.arrayUnion(playerName)
                });
            }
        }

        async function startGame() {
            showLoading('Inizializzazione partita...');

            const numPlayers = roomData.players.length;
            const chains = {};
            const usedThemes = [];

            // Crea una catena per ogni giocatore
            roomData.players.forEach((player, index) => {
                const theme = getRandomTheme(usedThemes);
                usedThemes.push(theme);

                chains[`chain_${index}`] = {
                    theme: theme,
                    originalPlayer: player,
                    drawings: {}
                };
            });

            await db.collection('pictionary_rooms').doc(roomCode).update({
                stato: 'drawing',
                currentPhase: 0,
                chains: chains,
                completedPhase: {},
                timestamp: Date.now()
            });

            hideLoading();
        }

        function getRandomTheme(exclude) {
            const available = THEMES.filter(t => !exclude.includes(t));
            return available[Math.floor(Math.random() * available.length)];
        }

        // ========================================
        // üé® GAME
        // ========================================
        function showGame() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('main-game').classList.remove('hidden');
            document.getElementById('game-banner').classList.remove('hidden');
            document.getElementById('gallery-section').classList.add('hidden');

            const phase = roomData.currentPhase;
            const myChain = getMyAssignedChain();
            const isInitialPhase = phase === 0;

            // Aggiorna barra superiore
            if (isInitialPhase) {
                document.getElementById('phase-indicator').textContent = 'üé® Disegna il tuo tema';
                document.getElementById('theme-container').classList.remove('hidden');
                document.getElementById('assigned-theme').textContent = roomData.chains[myChain].theme;
                document.getElementById('mini-reference').style.display = 'none';
                document.getElementById('btn-show-ref').classList.add('hidden');
            } else {
                document.getElementById('phase-indicator').textContent = `‚úèÔ∏è Ridisegno (Round ${phase + 1})`;
                document.getElementById('theme-container').classList.add('hidden');
                setupReferenceDrawing(myChain, phase);
                document.getElementById('btn-show-ref').classList.remove('hidden');
            }

            document.getElementById('btn-submit').classList.remove('hidden');
            document.getElementById('btn-clear').classList.remove('hidden');

            // Verifica se ho gi√† completato questa fase
            const completed = roomData.completedPhase[phase] || [];
            if (completed.includes(playerName)) {
                disableDrawing();
                document.getElementById('btn-submit').textContent = '‚úÖ COMPLETATO';
                document.getElementById('btn-submit').disabled = true;
            } else {
                enableDrawing();
                document.getElementById('btn-submit').textContent = '‚úÖ FATTO';
                document.getElementById('btn-submit').disabled = false;
                startTimer();
            }
        }

        function getMyAssignedChain() {
            const phase = roomData.currentPhase;
            const playerIndex = roomData.players.indexOf(playerName);
            const numPlayers = roomData.players.length;

            if (phase === 0) {
                return `chain_${playerIndex}`;
            }

            // Rotazione circolare: prendo il disegno di (index - phase) mod numPlayers
            const sourceIndex = (playerIndex - phase + numPlayers) % numPlayers;
            return `chain_${sourceIndex}`;
        }

        function setupReferenceDrawing(chainId, phase) {
            const previousPhase = phase - 1;
            const drawing = roomData.chains[chainId].drawings[previousPhase];

            if (drawing && drawing.dataURL) {
                const miniRef = document.getElementById('mini-reference');
                miniRef.innerHTML = `<img src="${drawing.dataURL}" alt="Riferimento">`;
                miniRef.style.display = 'block';

                document.getElementById('reference-img').src = drawing.dataURL;
            }
        }

        async function submitDrawing() {
            if (!confirm('Confermi il disegno?')) return;

            showLoading('Salvataggio...');

            const dataURL = getCanvasDataURL();
            const myChain = getMyAssignedChain();
            const phase = roomData.currentPhase;

            const updates = {};
            updates[`chains.${myChain}.drawings.${phase}`] = {
                player: playerName,
                dataURL: dataURL,
                timestamp: Date.now()
            };

            updates[`completedPhase.${phase}`] = firebase.firestore.FieldValue.arrayUnion(playerName);

            await db.collection('pictionary_rooms').doc(roomCode).update(updates);

            stopTimer();
            disableDrawing();

            // Controlla se tutti hanno finito
            checkPhaseCompletion();

            hideLoading();
        }

        async function checkPhaseCompletion() {
            const phase = roomData.currentPhase;
            const completed = roomData.completedPhase[phase] || [];

            if (completed.length === roomData.players.length) {
                // Tutti hanno finito questa fase
                const totalRounds = roomData.settings.rounds;

                if (phase + 1 >= totalRounds) {
                    // Partita finita
                    await db.collection('pictionary_rooms').doc(roomCode).update({
                        stato: 'voting',
                        votes: {},
                        scores: {}
                    });
                } else {
                    // Passa alla prossima fase
                    setTimeout(async () => {
                        await db.collection('pictionary_rooms').doc(roomCode).update({
                            currentPhase: phase + 1
                        });
                    }, 2000);
                }
            }
        }

        function disableDrawing() {
            canvas.style.pointerEvents = 'none';
            canvas.style.opacity = '0.6';
        }

        function enableDrawing() {
            canvas.style.pointerEvents = 'auto';
            canvas.style.opacity = '1';
            clearCanvas();
        }

        // ========================================
        // ‚è±Ô∏è TIMER
        // ========================================
        function startTimer() {
            stopTimer();
            timeLeft = roomData.settings.timePerRound;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    stopTimer();
                    submitDrawing();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = `${timeLeft}s`;
        }

        // ========================================
        // üñºÔ∏è MODALE RIFERIMENTO
        // ========================================
        function showReferenceModal() {
            document.getElementById('reference-modal').style.display = 'flex';
        }

        function closeReferenceModal() {
            document.getElementById('reference-modal').style.display = 'none';
        }

        // ========================================
        // ‚≠ê VOTAZIONE
        // ========================================
        function showVoting() {
            stopTimer();
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('main-game').classList.remove('hidden');
            document.getElementById('game-banner').classList.add('hidden');
            document.getElementById('gallery-section').classList.remove('hidden');

            const container = document.getElementById('gallery-container');
            container.innerHTML = '';

            Object.entries(roomData.chains).forEach(([chainId, chainData]) => {
                const card = document.createElement('div');
                card.className = 'chain-card';

                const title = document.createElement('div');
                title.className = 'chain-title';
                title.textContent = `Tema: ${chainData.theme}`;
                card.appendChild(title);

                const sequence = document.createElement('div');
                sequence.className = 'drawing-sequence';

                // Ordina disegni per fase
                const phases = Object.keys(chainData.drawings).sort((a, b) => parseInt(a) - parseInt(b));

                phases.forEach(phase => {
                    const drawing = chainData.drawings[phase];
                    const step = document.createElement('div');
                    step.className = 'drawing-step';

                    const img = document.createElement('img');
                    img.src = drawing.dataURL;
                    img.alt = `Fase ${parseInt(phase) + 1}`;
                    img.onclick = () => {
                        document.getElementById('reference-img').src = drawing.dataURL;
                        showReferenceModal();
                    };

                    const info = document.createElement('div');
                    info.className = 'drawing-info';
                    info.innerHTML = `
                        <span>Fase ${parseInt(phase) + 1}</span>
                        <span>${drawing.player}</span>
                    `;

                    step.appendChild(img);
                    step.appendChild(info);
                    sequence.appendChild(step);
                });

                card.appendChild(sequence);

                // Votazione
                const voteSection = document.createElement('div');
                voteSection.className = 'vote-section';
                voteSection.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px;">Vota questa catena:</div>
                    <div class="star-rating" id="stars-${chainId}">
                        ${[1,2,3,4,5].map(n => `<span class="star" data-chain="${chainId}" data-value="${n}">‚≠ê</span>`).join('')}
                    </div>
                `;

                card.appendChild(voteSection);
                container.appendChild(card);

                // Listener voti
                document.querySelectorAll(`#stars-${chainId} .star`).forEach(star => {
                    star.addEventListener('click', () => voteChain(chainId, parseInt(star.dataset.value)));
                });

                // Ripristina voto se gi√† dato
                if (roomData.votes[playerName] && roomData.votes[playerName][chainId]) {
                    const myVote = roomData.votes[playerName][chainId];
                    for (let i = 0; i < myVote; i++) {
                        document.querySelectorAll(`#stars-${chainId} .star`)[i].classList.add('active');
                    }
                }
            });
        }

        async function voteChain(chainId, stars) {
            // Non puoi votare la tua catena originale
            const myChainIndex = roomData.players.indexOf(playerName);
            if (chainId === `chain_${myChainIndex}`) {
                alert('‚ùå Non puoi votare la tua catena!');
                return;
            }

            const updates = {};
            updates[`votes.${playerName}.${chainId}`] = stars;

            await db.collection('pictionary_rooms').doc(roomCode).update(updates);

            // Aggiorna UI
            document.querySelectorAll(`#stars-${chainId} .star`).forEach((star, index) => {
                if (index < stars) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // ========================================
        // üèÜ RISULTATI
        // ========================================
        function showResults() {
            // Calcola punteggi
            const scores = {};
            roomData.players.forEach(p => scores[p] = 0);

            Object.entries(roomData.votes).forEach(([voter, votes]) => {
                Object.entries(votes).forEach(([chainId, stars]) => {
                    const chain = roomData.chains[chainId];
                    // Assegna punti all'autore originale
                    scores[chain.originalPlayer] += stars;
                });
            });

            alert(`üèÜ RISULTATI FINALI:\n\n${Object.entries(scores).sort((a,b) => b[1] - a[1]).map(([p, s]) => `${p}: ${s} ‚≠ê`).join('\n')}`);
        }

        // ========================================
        // üö™ ESCI
        // ========================================
        async function leaveRoom() {
            if (!confirm('Vuoi davvero uscire?')) return;

            if (unsubscribe) unsubscribe();

            await db.collection('pictionary_rooms').doc(roomCode).update({
                players: firebase.firestore.FieldValue.arrayRemove(playerName),
                ready: firebase.firestore.FieldValue.arrayRemove(playerName)
            });

            window.location.href = 'index.html';
        }

        function tornaHome() {
            leaveRoom();
        }

        // ========================================
        // üéØ UTILITY
        // ========================================
        function showLoading(msg) {
            document.getElementById('loading-text').textContent = msg;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });
    </script>
</body>
</html>
